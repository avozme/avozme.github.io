<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>1.4 Interacción con la base de datos - DESARROLLO WEB FULL STACK</title> <link rel="shortcut icon" href="/docs/fullstack/_site/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/docs/fullstack/_site/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/docs/fullstack/_site/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/docs/fullstack/_site/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>1.4 Interacción con la base de datos | DESARROLLO WEB FULL STACK</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="1.4 Interacción con la base de datos" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Apuntes del módulo optativo de “Desarrollo web full stack”, de 2º curso del Ciclo Formativo de Grado Superior de Desarrollo de Aplicaciones Web/Multiplataforma impartido en el IES Celia Viñas de Almería (España)" /> <meta property="og:description" content="Apuntes del módulo optativo de “Desarrollo web full stack”, de 2º curso del Ciclo Formativo de Grado Superior de Desarrollo de Aplicaciones Web/Multiplataforma impartido en el IES Celia Viñas de Almería (España)" /> <link rel="canonical" href="https://iescelia.org/docs/fullstack/_site/php/interaccion-con-mysql.html" /> <meta property="og:url" content="https://iescelia.org/docs/fullstack/_site/php/interaccion-con-mysql.html" /> <meta property="og:site_name" content="DESARROLLO WEB FULL STACK" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="1.4 Interacción con la base de datos" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Apuntes del módulo optativo de “Desarrollo web full stack”, de 2º curso del Ciclo Formativo de Grado Superior de Desarrollo de Aplicaciones Web/Multiplataforma impartido en el IES Celia Viñas de Almería (España)","headline":"1.4 Interacción con la base de datos","url":"https://iescelia.org/docs/fullstack/_site/php/interaccion-con-mysql.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="https://iescelia.org/docs/fullstack/_site/" class="site-title lh-tight"> DESARROLLO WEB FULL STACK </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://iescelia.org/docs/fullstack/_site/" class="nav-list-link">Desarrollo web full stack</a><ul class="nav-list "><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://iescelia.org/docs/fullstack/_site/php/" class="nav-list-link">1 Programación web con PHP</a><ul class="nav-list"><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/frontend-backend-fullstack.html" class="nav-list-link">1.1 Frontend vs backend vs full stack</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/caja-de-herramientas.html" class="nav-list-link">1.2 Caja de herramientas</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/sintaxis-de-php.html" class="nav-list-link">1.3 Sintaxis de PHP</a> </li><li class="nav-list-item active"> <a href="https://iescelia.org/docs/fullstack/_site/php/interaccion-con-mysql.html" class="nav-list-link active">1.4 Interacción con la base de datos</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/depuracion-php-xdebug.html" class="nav-list-link">1.5 Depurando el código PHP con xdebug</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/cookies-y-sesiones.html" class="nav-list-link">1.6 Cookies y variables de sesión</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/mvc/" class="nav-list-link">1.7 Arquitectura MVC</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/ejemplos-resueltos.html" class="nav-list-link">1.8 Ejemplos resueltos</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/ejercicios-propuestos.html" class="nav-list-link">1.9 Prácticas</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/php/practica.html" class="nav-list-link">1.10 Práctica final</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://iescelia.org/docs/fullstack/_site/laravel/" class="nav-list-link">2 Laravel</a><ul class="nav-list"><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/caracteristicas.html" class="nav-list-link">2.1 Características de Laravel</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/instalacion.html" class="nav-list-link">2.2 Instalación de Laravel</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/configuracion.html" class="nav-list-link">2.3 Configuración de Laravel</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/artisan.html" class="nav-list-link">2.4 Artisan</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/hola-mundo-con-laravel.html" class="nav-list-link">2.5 Hola mundo</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/enrutamiento.html" class="nav-list-link">2.6 Enrutamiento</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/vistas-blade.html" class="nav-list-link">2.7 Vistas y plantillas con Blade</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/controladores.html" class="nav-list-link">2.8 Controladores</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/migraciones.html" class="nav-list-link">2.9 Migraciones</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/eloquent.html" class="nav-list-link">2.10 Usando la BD con Eloquent</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/querybuilder.html" class="nav-list-link">2.11 Usando la BD con QueryBuilder</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/sesiones.html" class="nav-list-link">2.12 Sesiones con Laravel</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/helpers.html" class="nav-list-link">2.13 Helpers de Laravel</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/flujo-de-trabajo-con-laravel.html" class="nav-list-link">2.14 Flujo de trabajo típico con Laravel</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/aspectos-avanzados.html" class="nav-list-link">2.15 Aspectos avanzados de Laravel</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/crud-con-laravel.html" class="nav-list-link">2.16 CRUD desarrollado con Laravel</a> </li><li class="nav-list-item "> <a href="https://iescelia.org/docs/fullstack/_site/laravel/practicas.html" class="nav-list-link">2.17 Prácticas</a> </li></ul></li><li class="nav-list-item "><a href="https://iescelia.org/docs/fullstack/_site/api-rest/" class="nav-list-link">3 Desarrollo de un API REST</a></li><li class="nav-list-item "><a href="https://iescelia.org/docs/fullstack/_site/vue-js/" class="nav-list-link">4 Vue.js</a></li><li class="nav-list-item "><a href="https://iescelia.org/docs/fullstack/_site/inertia/" class="nav-list-link">5 Intertia.js</a></li><li class="nav-list-item "><a href="https://iescelia.org/docs/fullstack/_site/scv-git/" class="nav-list-link">Apéndice 1. Sistemas de control de versiones. Git</a></li><li class="nav-list-item "><a href="https://iescelia.org/docs/fullstack/_site/docker/" class="nav-list-link">Apéndice 2. Virtualización con Docker</a></li><li class="nav-list-item "><a href="https://iescelia.org/docs/fullstack/_site/openstack/" class="nav-list-link">Apéndice 3. Despliegue con Openstack</a></li></ul></li><li class="nav-list-item"><a href="https://iescelia.org/docs/fullstack/_site/about/" class="nav-list-link">About</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search DESARROLLO WEB FULL STACK" aria-label="Search DESARROLLO WEB FULL STACK" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://iescelia.org/docs/fullstack/_site/">Desarrollo web full stack</a></li> <li class="breadcrumb-nav-list-item"><a href="https://iescelia.org/docs/fullstack/_site/php/">1 Programación web con PHP</a></li> <li class="breadcrumb-nav-list-item"><span>1.4 Interacción con la base de datos</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h2 class="no_toc" id="14-interacción-entre-mariadb-y-php"> <a href="#14-interacción-entre-mariadb-y-php" class="anchor-heading" aria-labelledby="14-interacción-entre-mariadb-y-php"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4. Interacción entre MariaDB y PHP </h2> <ul id="markdown-toc"> <li><a href="#141-mysqlmariadb-con-php4-ojo-obsoleto" id="markdown-toc-141-mysqlmariadb-con-php4-ojo-obsoleto">1.4.1. MySQL/MariaDB con PHP4 (¡Ojo! ¡Obsoleto!)</a></li> <li><a href="#142-mysqlmariadb-a-partir-de-php5" id="markdown-toc-142-mysqlmariadb-a-partir-de-php5">1.4.2. MySQL/MariaDB a partir de PHP5</a></li> <li><a href="#143-inserción-modificación-y-borrado-de-datos-con-pdo" id="markdown-toc-143-inserción-modificación-y-borrado-de-datos-con-pdo">1.4.3. Inserción, modificación y borrado de datos con PDO</a></li> <li><a href="#144-consultas-con-pdo" id="markdown-toc-144-consultas-con-pdo">1.4.4. Consultas con PDO</a></li> <li><a href="#145-mejorando-la-implementación-de-consultas" id="markdown-toc-145-mejorando-la-implementación-de-consultas">1.4.5. Mejorando la implementación de consultas</a></li> <li><a href="#146-formas-de-hacer-fetch" id="markdown-toc-146-formas-de-hacer-fetch">1.4.6. Formas de hacer fetch</a></li> </ul> <p>A partir de ahora, vamos a referirnos a MySQL/MariaDB indistintamente. Este será el gestor de bases de datos relacionales que vamos a usar a lo largo del curso. La adaptación a otros gestores, en cualquier caso, es muy simple.</p> <p>MySQL/MariaDB, como ya hemos visto, es un SGBD relacional de probada eficacia. La interacción con él resulta eficiente y segura para casi cualquier aplicación web que podamos concebir.</p> <h3 id="141-mysqlmariadb-con-php4-ojo-obsoleto"> <a href="#141-mysqlmariadb-con-php4-ojo-obsoleto" class="anchor-heading" aria-labelledby="141-mysqlmariadb-con-php4-ojo-obsoleto"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4.1. MySQL/MariaDB con PHP4 (¡Ojo! ¡Obsoleto!) </h3> <p>En la red hay mucho código PHP obsoleto que <strong><em>NO debes utilizar bajo ningún concepto</em></strong> porque es muy inseguro.</p> <p>Si encuentras código que se parece al siguiente, huye de esa página porque no te va a ayudar:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// *** CÓDIGO OBSOLETO -- ¡¡¡NO USAR!!!***</span>

<span class="c1">// Conectamos con MySQL</span>
<span class="nb">mysql_connect</span><span class="p">(</span><span class="s2">"URL"</span><span class="p">,</span><span class="s2">"nombre_usuario"</span><span class="p">,</span><span class="s2">"contraseña"</span><span class="p">);</span>

<span class="c1">// Seleccionamos la base de datos con la que vamos a trabajar</span>
<span class="nb">mysql_select_db</span><span class="p">(</span><span class="s2">"nombre_base_de_datos"</span><span class="p">);</span>

<span class="c1">// Ejecutamos una sentencia SQL</span>
<span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"INSERT INTO clientes (nombre,telefono) VALUES ('</span><span class="nv">$nombre</span><span class="s2">','</span><span class="nv">$telefono</span><span class="s2">')"</span><span class="p">);</span>
</code></pre></div></div> <h3 id="142-mysqlmariadb-a-partir-de-php5"> <a href="#142-mysqlmariadb-a-partir-de-php5" class="anchor-heading" aria-labelledby="142-mysqlmariadb-a-partir-de-php5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4.2. MySQL/MariaDB a partir de PHP5 </h3> <p>Desde PHP5, se utiliza <strong>una biblioteca de clases para acceder a los diferentes SGBDs</strong>.</p> <p>Todos los nuevos desarrollos deberían usar las bibliotecas de clases y prescindir de las viejas librerías de funciones.</p> <h4 id="formas-de-acceder-a-bases-de-datos-en-php"> <a href="#formas-de-acceder-a-bases-de-datos-en-php" class="anchor-heading" aria-labelledby="formas-de-acceder-a-bases-de-datos-en-php"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Formas de acceder a bases de datos en PHP </h4> <p>PHP proporciona varios mecanismos para acceder a bases de datos (ya te lo dije antes: en PHP, casi todo se puede hacer de varias maneras distintas):</p> <ul> <li> <p><strong>Forma 1: Usar la extensión mysqli en su forma procedimental.</strong></p> <p>Esta forma recuerda mucho a PHP4, pero cambiando la palabra “mysql” por “mysqli”.</p> <p>Por ejemplo, la función <em>mysql_connect()</em> ahora se llama <em>mysqli_connect()</em> (la “i” significa “improved”, es decir, “mejorado”).</p> <p>Esta forma es apta para programadores/as perezosos y anticuados, que no quieren pasarse a la programación orientada a objetos y se sienten cómodos con la forma de codificación tradicional. Pero ese no es tu caso, ¿verdad? Así que nunca utilizaremos la forma procedimental.</p> </li> <li> <p><strong>Forma 2: Usar la extensión mysqli en su forma orientada a objetos.</strong></p> <p>Se accede a la base de datos a través de un objeto de la clase <em>mysqli</em>. Es decir, se crea una instancia (con <code class="language-plaintext highlighter-rouge">new mysqli()</code>) y, a través de ella, se tiene acceso a todos los métodos para interactuar con la base de datos.</p> <p>Si en lugar de una base de datos MySQL, trabajamos con otro gestor de base de datos, hay que crear un objeto de otro tipo. Por ejemplo, la clase <em>SQLite3</em> sirve para conectar con bases de datos SQLite. Hay otros gestores que solo ofrecen la forma procedimental.</p> </li> <li> <p><strong>Forma 3: Usar la extensión PDO.</strong></p> <p>A partir de PHP 5.1, existe una clase genérica, llamada <em>PDO</em>, que permite acceder a cualquier gestor de bases de datos mediante el mismo conjunto de métodos. Es lo que se llama una <em>capa de abstracción de acceso a datos</em></p> <p>Esto significa que, independientemente de la base de datos que se esté utilizando, PDO permite utilizar los mismos métodos para realizar consultas y obtener datos, por lo que es la forma de trabajo más flexible y la que vamos a utilizar en este curso.</p> </li> </ul> <h3 id="143-inserción-modificación-y-borrado-de-datos-con-pdo"> <a href="#143-inserción-modificación-y-borrado-de-datos-con-pdo" class="anchor-heading" aria-labelledby="143-inserción-modificación-y-borrado-de-datos-con-pdo"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4.3. Inserción, modificación y borrado de datos con PDO </h3> <p>Vamos a ver cómo funciona la clase <em>PDO</em> mediante unos cuantos ejemplos. En primer lugar, lanzaremos una inserción de datos.</p> <p>Imagina que tenemos una base de datos MySQL o MariaDB llamada <em>mi-base-de-datos</em> que contiene una tabla de clientes donde guardamos, entre otras cosas, los nombres y los teléfonos de los clientes.</p> <p>Insertar un registro en esa tabla desde PHP se logra en solo dos pasos:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// Datos de conexión</span>
<span class="nv">$dsn</span> <span class="o">=</span> <span class="s2">"mysql:host=servidor;dbname=mi-base-de-datos;charset=utf8"</span><span class="p">;</span>
<span class="nv">$usuario</span> <span class="o">=</span> <span class="s2">"nombre-de-usuario"</span><span class="p">;</span>
<span class="nv">$clave</span>   <span class="o">=</span> <span class="s2">"password"</span><span class="p">;</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Conexión con PDO</span>
    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">);</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">setAttribute</span><span class="p">(</span><span class="no">PDO</span><span class="o">::</span><span class="no">ATTR_ERRMODE</span><span class="p">,</span> <span class="no">PDO</span><span class="o">::</span><span class="no">ERRMODE_EXCEPTION</span><span class="p">);</span>

    <span class="c1">// Sentencia preparada para insertar</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO clientes (nombre, telefono) VALUES (:nombre, :telefono)"</span><span class="p">;</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

    <span class="c1">// Ejecutar la consulta con los valores</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">([</span>
        <span class="s2">":nombre"</span>  <span class="o">=&gt;</span> <span class="nv">$nombre</span><span class="p">,</span>
        <span class="s2">":telefono"</span><span class="o">=&gt;</span> <span class="nv">$telefono</span>
    <span class="p">]);</span>

    <span class="k">echo</span> <span class="s2">"Registro insertado correctamente"</span><span class="p">;</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Error: "</span> <span class="mf">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>Si sustituyes la sentencia INSERT por cualquier otra instrucción SQL válida, también funcionará, con la excepción de SELECT, que se maneja de otra manera que enseguida veremos.</p> <p>Por lo tanto, el código anterior te puede servir de base para ejecutar cualquier INSERT, UPDATE o DELETE sobre tu base de datos. O incluso sentencias de definición de la base de datos, como CREATE TABLE o ALTER TABLE (siempre que el usuario con el que te estés conectando tenga permisos para ejecutarlas, claro)</p> <h3 id="144-consultas-con-pdo"> <a href="#144-consultas-con-pdo" class="anchor-heading" aria-labelledby="144-consultas-con-pdo"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4.4. Consultas con PDO </h3> <p>Hemos dicho que las sentencias SELECT se lanzan desde PHP de un modo diferente al resto. ¿Por qué será?</p> <p>La respuesta es sencilla de entender: la ejecución de consultas (SELECT) produce la devolución de un conjunto de registros, mientras que cualquier otra instucción (INSERT, UPDATE, DELETE o lo que sea) no devuelve ningún registro.</p> <p>Los registros obtenidos como resultado de un SELECT se manejan en PHP con un objeto denominado <strong>cursor</strong>. Un cursor no es más que un puntero al conjunto de resultados que señala al registro que se va a procesar a continuación.</p> <p>Es decir: se parece al cursor de tu procesador de textos, que te indica el lugar en el que vas a insertar o borrar caracteres.</p> <p>En el caso de los cursores MySQL, no te permiten borrar nada. El cursor solo señala un registro concreto dentro de los resultados del SELECT.</p> <p>Observa cómo se hace un SELECT en este ejemplo:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// Datos de conexión</span>
<span class="nv">$dsn</span> <span class="o">=</span> <span class="s2">"mysql:host=servidor;dbname=database;charset=utf8mb4"</span><span class="p">;</span>
<span class="nv">$usuario</span> <span class="o">=</span> <span class="s2">"user"</span><span class="p">;</span>
<span class="nv">$clave</span>   <span class="o">=</span> <span class="s2">"password"</span><span class="p">;</span>

<span class="c1">// Conexión con PDO</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">);</span>

<span class="c1">// Ejecutamos la consulta</span>
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT nombre, telefono FROM Clientes"</span><span class="p">;</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$stmt</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">"Error en la conexión o en la consulta: "</span> <span class="mf">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">"1"</span> <span class="na">align=</span><span class="s">"center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th&gt;</span>Nombre<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>Teléfono<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="cp">&lt;?php</span> 
        <span class="k">while</span> <span class="p">(</span><span class="nv">$cliente</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">(</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">))</span> <span class="p">{</span> 
           <span class="k">echo</span> <span class="s2">"&lt;tr&gt;"</span><span class="p">;</span>
           <span class="k">echo</span> <span class="s2">"&lt;td&gt;"</span><span class="mf">.</span><span class="nv">$cliente</span><span class="p">[</span><span class="s2">"nombre"</span><span class="p">]</span><span class="mf">.</span><span class="s2">"&lt;/td&gt;"</span><span class="p">;</span>
           <span class="k">echo</span> <span class="s2">"&lt;td&gt;"</span><span class="mf">.</span><span class="nv">$cliente</span><span class="p">[</span><span class="s2">"telefono"</span><span class="p">]</span><span class="mf">.</span><span class="s2">"&lt;/td&gt;"</span><span class="p">;</span>
           <span class="k">echo</span> <span class="s2">"&lt;/tr&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="cp">?&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre></div></div> <p>Probablemente ya lo hayas captado sin necesidad de explicaciones adicionales, pero, por si acaso no es así, ahí va una explicación adicional gratuita.</p> <p>Cuando se lanza una consulta contra una base de datos desde PHP, la base de datos nos devuelve el resultado en un <em>cursor</em>, como hemos dicho. Ese objeto de tipo cursor lo almacenamos en una variable que, en este ejemplo, hemos llamado <em>$stmt</em> (abreviatura de “Statement”).</p> <p>Recuerda que un cursor es un apuntador a un conjunto de resultados. Cuando un cursor está recién abierto, <em>siempre apunta al primer registro de ese conjunto de resultados</em>.</p> <p>Nuestra variable <em>$stmt</em> es un objeto y, como cualquier objeto, contiene una serie de métodos. Entre esos métodos, cualquier cursor siempre nos ofrecerá un método importantísimo llamado <strong><em>fetch()</em></strong>.</p> <p>El método <em>fetch()</em> nos devuelve el siguiente dato almacenado en el cursor (en nuestro caso, un registro completo) y hace avanzar al cursor para que apunte al siguiente dato (en nuestro caso, el siguiente registro). Así, lo deja preparado para recuperar otro registro en la siguiente iteración.</p> <p>Por eso hemos colocado la instrucción <em>fetch()</em> en un bucle.</p> <p>Cuando el cursor está recién abierto, el primer <em>fetch()</em> nos devuelve el primer registro del resultado. Es decir, el primer cliente. Podemos acceder a los campos de ese registro (como “nombre” o “teléfono”) accediendo al registro como si fuera un array ($registro[“nomnre”], $registro[“telefono”], etc). Por eso el método no se llama solo <em>fetch()</em>, sino <em>fetch_array()</em>.</p> <p>Pero <em>fetch()</em> no solo recupera el primer registro, sino que hace avanzar el cursor para que se quede apuntando al segundo. De este modo, en la siguiente iteración del bucle, <em>fetch()</em> nos recupera <em>el segundo</em> registro (el segundo cliente), y el cursor queda apuntando al tercero, listo para la siguiente iteración.</p> <p>Cuando no quedan más registros que procesar, <em>fetch()</em> devuelve <em>false</em> y el bucle termina. De ese modo, habremos procesado fácilmente todo el conjunto de resultados devueltos por la consulta.</p> <h3 id="145-mejorando-la-implementación-de-consultas"> <a href="#145-mejorando-la-implementación-de-consultas" class="anchor-heading" aria-labelledby="145-mejorando-la-implementación-de-consultas"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4.5. Mejorando la implementación de consultas </h3> <p>Podríamos hacer muchas consideraciones adicionales sobre PHP, pero esto solo es una introducción al lenguaje, así que no profundizaremos mucho.</p> <p>Sin embargo, me gustaría que vieras una implementación alternativa del código anterior (PHP es muy flexible y admite muchas maneras de hacer lo mismo), porque ilustra algunas características de PHP que me parece que debes conocer:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- PARTE 1: Lógica de la consulta --&gt;</span>
<span class="cp">&lt;?php</span>
<span class="c1">// Configuración de la conexión</span>
<span class="nv">$dsn</span> <span class="o">=</span> <span class="s2">"mysql:host=servidor;dbname=database;charset=utf8mb4"</span><span class="p">;</span>
<span class="nv">$usuario</span> <span class="o">=</span> <span class="s2">"user"</span><span class="p">;</span>
<span class="nv">$clave</span>   <span class="o">=</span> <span class="s2">"password"</span><span class="p">;</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Conexión con PDO</span>
    <span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">);</span>
    <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">setAttribute</span><span class="p">(</span><span class="no">PDO</span><span class="o">::</span><span class="no">ATTR_ERRMODE</span><span class="p">,</span> <span class="no">PDO</span><span class="o">::</span><span class="no">ERRMODE_EXCEPTION</span><span class="p">);</span>

    <span class="c1">// Ejecutamos la consulta</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT nombre, telefono FROM Clientes"</span><span class="p">);</span>
    <span class="nv">$clientes</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">);</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">"Error en la conexión o consulta: "</span> <span class="mf">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="c">&lt;!-- PARTE 2: Mostrar los datos de la consulta--&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>Nombre<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Teléfono<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$clientes</span> <span class="k">as</span> <span class="nv">$cliente</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$cliente</span><span class="p">[</span><span class="s2">"nombre"</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$cliente</span><span class="p">[</span><span class="s2">"telefono"</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

</code></pre></div></div> <p>Este código es funcionalmente idéntico que el que veíamos antes, pero tiene algunas mejoras interesantes en las que quiero que te fijes:</p> <ol> <li><strong>Separa completamente la lógica del problema (la extracción de datos de la BD) de su presentación</strong>. Cuanto menos se mezcle el código PHP con el código HTML, menos confuso será el resultado. Por eso, en esta solución usamos <strong><em>fetchAll()</em></strong> en lugar de <em>fetch()</em>: para mover todo el resultado a un array asociativo (PDO::FETCH_ASSOC), que es un array PHP normal que podemos procesar más adelante, cuando vayamos a mostrarlo.</li> <li><strong>Utiliza <em>&lt;?= … ?&gt;</em></strong>. Esto es una abreviatura muy habitual de <em>&lt;?php echo(“…”) ?&gt;</em>.</li> <li><strong>Utiliza <em>$pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION)</em></strong>, que fuerza a que PDO lance una excepción si ocurre un error en la consulta. De otro modo, PDO no lanza excepciones, solo devuelve <em>false</em> si la consulta falla. El manejador de excepciones es más seguro y puede tener en cuenta más situaciones de error que la simple comprobación de ese <em>false</em>.</li> <li><strong>Utiliza <em>htmlspecialchars()</em></strong>. Esto filtra cualquier contenido sospechoso que un atacante malicioso pudiera haber inyectado en tu base de datos, por lo que se considera más seguro que usar solo <em>echo()</em> en aplicaciones web. Imagínate que en la BD alguien hubiera logrado inyectar el código <em>&lt;script&gt;location.href=’miServidor.com’&lt;/script&gt;</em> en el campo <em>teléfono</em> de un usuario. ¿Qué pasaría al tratar de mostrar la lista de usuarios? <em>htmlspecialchars()</em> impedirá la ejecución de ese código malicioso y de cualquier otra cosa sospechosa o mal formada.</li> </ol> <h3 id="146-formas-de-hacer-fetch"> <a href="#146-formas-de-hacer-fetch" class="anchor-heading" aria-labelledby="146-formas-de-hacer-fetch"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4.6. Formas de hacer fetch </h3> <p>Como has visto en los ejemplos, al hacer <em>fetch()</em> del resultado de una consulta recuperas los datos del siguiente registro, pero esto se puede lograr de varias maneras.</p> <p>En primer lugar, tenemos dos métodos para hacer <em>fetch</em>:</p> <ul> <li><strong><em>fetch()</em></strong> recupera el siguiente registro de la consulta.</li> <li><strong><em>fetchAll()</em></strong> recupera todos los registros de la consulta.</li> </ul> <p>Además, tanto a <em>fetch()</em> como a <em>fetchAll()</em> podemos indicarle la forma en la que queremos que se almacenen los datos recuperados en variables PHP. Por ejemplo:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT id, nombre FROM usuarios"</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$fila</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">(</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$fila</span><span class="p">[</span><span class="s1">'nombre'</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div> <p>Aquí se ha usado <em>fetch(PDO::FETCH_ASSOC)</em>, que devuelve los datos de la consulta en un array asociativo con esta forma:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$fila['id'] = Aquí-va-el-ID;
$fila['nombre'] = "Aquí va el nombre";
</code></pre></div></div> <p>En cambio, podríamos haber recuperado los datos así:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT id, nombre FROM usuarios"</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$fila</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">(</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_NUM</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$fila</span><span class="p">[</span><span class="s1">'nombre'</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div> <p>En este caso, <em>fetch(PDO::FETCH_NUM)</em> nos colocará los datos en un array indexado por números, donde la posición 0 es la primera columna, la posición 1 la segunda, etc:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$fila[0] = Aquí-va-el-ID;
$fila[1] = "Aquí va el nombre";
</code></pre></div></div> <p>Tanto <em>fetch()</em> como <em>fetchAll()</em> admiten, por tanto, varias posibilidades. Estas son las más interesantes, aunque hay más:</p> <ul> <li><strong><em>fetch(PDO::FETCH_ASSOC)</em></strong>: Devuelve los datos en un array asociativo.</li> <li><strong><em>fetch(PDO::FETCH_NUM)</em></strong>: Devuelve los datos en un array indexado por números enteros.</li> <li><strong><em>fetch(PDO::FETCH_BOTH)</em></strong> (por defecto): Devuelve los datos en un array asociativo y en un array indexado por números enteros, las dos cosas a la vez.</li> <li><strong><em>fetch(PDO::FETCH_OBJ)</em></strong>: Devuelve los datos en un objeto creado para la ocasión (Los datos serían accesibles como <em>$fila-&gt;nombre, $fila-&gt;id</em>, etc).</li> <li><strong><em>fetch(PDO::FETCH_CLASS, NombreClase)</em></strong>: Devuelve los datos como instancias de la clase especificada.</li> </ul> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
