I"죑<h1 class="no_toc" id="ap칠ndice-2-virtualizaci칩n-con-docker">Ap칠ndice 2. Virtualizaci칩n con Docker</h1>

<ul id="markdown-toc">
  <li><a href="#a21-qu칠-es-docker" id="markdown-toc-a21-qu칠-es-docker">A2.1. 쯈u칠 es Docker?</a></li>
  <li><a href="#a22-comandos-usuales-de-docker" id="markdown-toc-a22-comandos-usuales-de-docker">A2.2. Comandos usuales de Docker</a></li>
  <li><a href="#a23-persistencia-de-datos" id="markdown-toc-a23-persistencia-de-datos">A2.3. Persistencia de datos</a></li>
  <li><a href="#a24-montando-con-docker-un-servidor-web-con-persistencia-de-datos" id="markdown-toc-a24-montando-con-docker-un-servidor-web-con-persistencia-de-datos">A2.4. Montando con Docker un servidor web con persistencia de datos</a>    <ul>
      <li><a href="#paso-1-crear-docker-composeyml" id="markdown-toc-paso-1-crear-docker-composeyml">Paso 1. Crear ./docker-compose.yml</a></li>
      <li><a href="#paso-2-crear-apache-customhttpdconf" id="markdown-toc-paso-2-crear-apache-customhttpdconf">Paso 2. Crear ./apache-custom/httpd.conf</a></li>
      <li><a href="#paso-3-crear-apache-custommyappconf" id="markdown-toc-paso-3-crear-apache-custommyappconf">Paso 3. Crear ./apache-custom/myapp.conf</a></li>
      <li><a href="#paso-4-crear-el-archivo-customini" id="markdown-toc-paso-4-crear-el-archivo-customini">Paso 4. Crear el archivo custom.ini</a></li>
      <li><a href="#paso-5-levantar-los-contenedores-con-docker-compose-up" id="markdown-toc-paso-5-levantar-los-contenedores-con-docker-compose-up">Paso 5. Levantar los contenedores con docker-compose up</a></li>
      <li><a href="#paso-6-probar-los-contenedores" id="markdown-toc-paso-6-probar-los-contenedores">Paso 6. Probar los contenedores</a></li>
      <li><a href="#paso-7-detener-los-contenedores" id="markdown-toc-paso-7-detener-los-contenedores">Paso 7. Detener los contenedores</a></li>
    </ul>
  </li>
</ul>

<h2 id="a21-qu칠-es-docker">A2.1. 쯈u칠 es Docker?</h2>

<p><strong>Docker</strong> es una herramienta de virtualizaci칩n basada en <em>contenedores</em>.</p>

<p>Un <strong>contenedor</strong> es un paquete de software completamente independiente del sistema donde se ejecuta. Recibe ese nombre por los contenedores que se utilizan en el transporte mar칤timo, que tienen unas medidas y una forma estandarizada y que aislan por completo la carga que llevan dentro del exterior.</p>

<p>Un contenedor Docker hace lo mismo, pero con un conjunto de software: lo aisla por completo del exterior. El software que hay dentro del contenedor se puede ejecutar en cualquier m치quina gracias al <em>runtime</em> de Docker, que se comporta como un mini-sistema operativo virtualizado que corre sobre la m치quina anfitri칩n.</p>

<p>Un contenedor puede contener cualquier cosa. Por ejemplo, Apache. De ese modo, podemos ejecutar Apache en cualquier m치quina (siempre que tenga previamente instalado Docker) sin necesidad de instalarlo realmente, con todo lo que ello conlleva de configuraci칩n de la m치quina, consumo de recursos, etc. El contenedor Docker puede ponerse en marcha cuando queramos y detenerse en cualquier momento, sin dejar ning칰n rastro en la m치quina anfitriona.</p>

<p>En definitiva, puedes usar y/o testear <em>cualquier</em> programa sin tener que instalarlo realmente en tu m치quina.</p>

<p>Los contenedores Docker vienen empaquetados en <strong>im치genes</strong>, a partir de los cuales pueden lanzarse todos los contenedores que necesitemos. Es decir, las im치genes con como las <em>clases</em> en programaci칩n orientada a objetos, y los contenedores son como los objetos que se instancian a partir de esas clases.</p>

<p>Cada cual puede construir las im치genes que necesite o usar im치genes ya hechas, con todo lo necesario en su interior para ejecutar cualquier software sin necesidad de instalarlo ni configurarlo. Hay repositorios p칰blicos de im치genes, como <strong>DockerHub</strong>, donde uno puede encontrar im치genes de pr치cticamente cualquier cosa.</p>

<h2 id="a22-comandos-usuales-de-docker">A2.2. Comandos usuales de Docker</h2>

<p>Aunque Docker puede usarse desde un interfaz gr치fico (como <strong>Docker Desktop</strong>), lo habitual es hacerlo desde la l칤nea de comandos.</p>

<p>Esto no es un manual de Docker, pero s칤 vamos a enumerar aqu칤 los comandos principales que nos ser치n 칰tiles como desarrolladores web para que puedas usarlos como referencia r치pida cuando tengas que trabajar con Docker.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker run [nombre-imagen]</code> - Lanza un contenedor a partir de la imagen especificada. Si la imagen no est치 descargada en el ordenador, la buscar치 en el repositorio configurado (por defecto, <em>DockerHub</em>).</li>
  <li><code class="language-plaintext highlighter-rouge">docker ps</code> - Muestra un listado con los contenedores que hay actualmente en el sistema. Un contenedor no tiene por qu칠 estar necesariamente corriendo, sino que existen otros estados (detenido, preparado, finalizado, etc). Con <code class="language-plaintext highlighter-rouge">docker ps -a</code> podemos ver todos los contenedores, tambi칠n los detenidos.</li>
  <li><code class="language-plaintext highlighter-rouge">docker stop [id-del-contenedor]</code> - Detiene un contenedor. Su id puede obtenerse con <code class="language-plaintext highlighter-rouge">docker ps</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">docker start [id-del-contenedor]</code> - Reanuda un contenedor.</li>
  <li><code class="language-plaintext highlighter-rouge">docker exec -it [id-del-contenedor] bash</code> - Abrir un terminal en el contenedor.</li>
  <li><code class="language-plaintext highlighter-rouge">docker-compose up -d</code> - Inicia todos los contenedores especificados en el archivo <em>docker-compose.yml</em> del directorio actual. Necesitas tener instalado, adem치s de Docker, el programa <em>docker-compose</em>.</li>
  <li><code class="language-plaintext highlighter-rouge">docker-compose down</code> - Detiene todos los contenedores especificados en el archivo <em>docker-compose.yml</em> del directorio actual.</li>
</ul>

<h2 id="a23-persistencia-de-datos">A2.3. Persistencia de datos</h2>

<p>Cualquier cosa que guardes en un contenedor de Docker se perder치 cuando el contenedor se detenga. Por ejemplo, si est치s haciendo una aplicaci칩n web que usa una base de datos MySQL, y tu servidor MySQL est치 en un contenedor Docker, toda la informaci칩n de esa base de datos se perder치 cada vez que destruyas el contenedor.</p>

<p>Es posible evitar eso usando la persistencia de datos. Consiste en pedirle a Docker que guarde datos <em>fuera</em> del contenedor, para que estos no se pierdan al reiniciarlo o eliminarlo. Por ejemplo, los datos de la base de datos.</p>

<p>La persistencia se puede habilitar con <strong>docker run</strong>. Por ejemplo:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -d --name mysql-container -e MYSQL_ROOT_PASSWORD=clave123 -v mysql-data:/var/lib/mysql mysql:latest
</code></pre></div></div>

<p>La persistencia se habilita con <em>-v mysql-data:/var/lib/mysql</em>, que crea (o usa) un volumen llamado <em>mysql-data</em> y lo monta en la ruta <em>/var/lib/mysql</em> de la m치quina real, que es donde MySQL suele guardar los datos.</p>

<p>Personalmente, encuentro m치s sencillo hacerlo todo a trav칠s de <strong>docker-compose</strong>. Por ejemplo, mira este archivo de configuraci칩n docker-compose.yml:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">mysql</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:latest</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">mysql-container</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mysql-data:/var/lib/mysql</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3306:3306"</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">mysql-data</span><span class="pi">:</span>
</code></pre></div></div>

<p>Con este archivo de configuraci칩n se lanzar치 un contenedor de <em>mysql</em> en cuanto tecleemos <em>docker-compose up</em>. Observa estas dos l칤neas:</p>

<ul>
  <li>La l칤nea <em>volumes</em> dentro del servicio <em>mysql</em> monta el volumen virtual <em>mysql-data</em> en <em>/var/lib/mysql</em>, el lugar de la m치quina real donde MySQL suele guardar los datos.</li>
  <li>La l칤nea <em>volumes</em> al final del archivo declara el volumen llamado <em>mysql-data</em>, que Docker crear치 si no existe.</li>
</ul>

<p>As칤, los datos persisten en <em>/var/lib/mysql</em> aunque detengas o elimines el contenedor.</p>

<h2 id="a24-montando-con-docker-un-servidor-web-con-persistencia-de-datos">A2.4. Montando con Docker un servidor web con persistencia de datos</h2>

<p>En esta secci칩n vamos a mostrar c칩mo montar un servidor web con im치genes Docker y levantarlo o apagarlo con docker-compose.</p>

<p>Usaremos las im치genes oficiales de cada desarrollador, y necesitaremos poner en marcha <strong>cuatro contenedores</strong> simult치neamente, por lo que ser치 mucho m치s c칩modo hacerlo con docker-compose para poder levantarlas todas a la vez y no de una en una:</p>

<ol>
  <li><strong>Servidor Apache</strong></li>
  <li><strong>Int칠rprete PHP</strong></li>
  <li><strong>Servidor MariaDB</strong></li>
  <li><strong>PHPMyAdmin</strong></li>
</ol>

<p>Adem치s, necesitamos que los datos de MariaDB sean persistentes, es decir, que no se pierdan cuando detengamos los contenedores.</p>

<p>Lograr esto es complicadillo, pero trabajar con los servidores siempre lo es. A cambio, tendremos un entorno f치cilmente transportable a otros servidores.</p>

<p>Te dejo las instrucciones paso a paso para que lo consigas sin desesperarte demasiado:</p>

<h3 id="paso-1-crear-docker-composeyml">Paso 1. Crear ./docker-compose.yml</h3>

<p>Crea un archivo <strong><em>docker-compose.yml</em></strong> en tu directorio de trabajo con este contenido exacto, para trabajar con las im치gene de nuestros cuatro servicios.</p>

<p>Usaremos solo las im치genes oficiales, excepto la de <em>php</em>. Para esa usaremos la imagen de <em>Bitnami</em>, una divisi칩n de <em>VMWare</em>, porque ya trae activadas ciertas extensiones de PHP (como <em>PDO</em>) que nos conviene tener a mano. As칤 nos evitamos tener que hacer complicadas configuraciones posteriores:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">php</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">bitnamilegacy/php-fpm</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./app:/app</span>
      <span class="pi">-</span> <span class="s">./custom.ini:/usr/local/etc/php/conf.d/custom.ini</span>

  <span class="na">apache</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">httpd:2.4</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:80"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./app:/app</span>
      <span class="pi">-</span> <span class="s">./apache-custom/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro</span>
      <span class="pi">-</span> <span class="s">./apache-custom/myapp.conf:/usr/local/apache2/conf/extra/myapp.conf:ro</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">php</span>

  <span class="na">mariadb</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mariadb:10.6</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">MYSQL_ROOT_PASSWORD</span><span class="pi">:</span> <span class="m">1234</span>
      <span class="na">MYSQL_DATABASE</span><span class="pi">:</span> <span class="s">pruebas</span>
      <span class="na">MYSQL_USER</span><span class="pi">:</span> <span class="s">user</span>
      <span class="na">MYSQL_PASSWORD</span><span class="pi">:</span> <span class="m">1234</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mariadb_data:/var/lib/mysql</span>

  <span class="na">phpmyadmin</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">phpmyadmin/phpmyadmin</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8000:80"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">PMA_HOST</span><span class="pi">:</span> <span class="s">mariadb</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mariadb</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">mariadb_data</span><span class="pi">:</span>
</code></pre></div></div>

<h3 id="paso-2-crear-apache-customhttpdconf">Paso 2. Crear ./apache-custom/httpd.conf</h3>

<p>Por defecto, la imagen oficial de Apache no interpreta el c칩digo PHP, sino que lo sirve en texto plano, como si fuera HTML.</p>

<p>Para reconfigurar esa imagen sin tener que meter mano al Dockerfile (algo que aprender치s a hacer en otros m칩dulos) tienes que:</p>

<ol>
  <li>Crear el directorio <strong><em>apache-custom</em></strong> en tu carpeta de trabajo.</li>
  <li>Crear el archivo <strong><em>httpd.conf</em></strong> dentro de <em>apache-custom</em> con este contenido:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># httpd.conf m칤nimo preparado para usar Apache httpd:2.4 + PHP-FPM

ServerRoot "/usr/local/apache2"

# Puerto en el que Apache escuchar치 dentro del contenedor
Listen 80

# M칩dulos esenciales
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule env_module modules/mod_env.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule alias_module modules/mod_alias.so
LoadModule negotiation_module modules/mod_negotiation.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule headers_module modules/mod_headers.so

# M칩dulos necesarios para proxying a PHP-FPM
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so

# Informaci칩n del servidor
ServerAdmin you@example.com
ServerName localhost:80

# Archivos de tipos mime
TypesConfig conf/mime.types

# Logs: enviar a stdout/stderr para que docker-compose logs funcione bien
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 common

# Seguridad por defecto
&lt;Directory /&gt;
    AllowOverride none
    Require all denied
&lt;/Directory&gt;

# DocumentRoot por defecto
DocumentRoot "/usr/local/apache2/htdocs"
&lt;Directory "/usr/local/apache2/htdocs"&gt;
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
&lt;/Directory&gt;

# 칈ndices (queremos que index.php tenga preferencia sobre index.html)
&lt;IfModule dir_module&gt;
    DirectoryIndex index.php index.html
&lt;/IfModule&gt;

# Incluimos el virtualhost personalizado que defines en apache-custom/myapp.conf
Include conf/extra/myapp.conf

# Fin del archivo
</code></pre></div></div>

<h3 id="paso-3-crear-apache-custommyappconf">Paso 3. Crear ./apache-custom/myapp.conf</h3>

<p>En este archivo de configuraci칩n adicional redirigiremos todas las peticiones de archivos .php hacia el contenedor con el int칠rprete PHP. El resto de archivos ser치n servidos por Apache.</p>

<p>Crea el archivo <strong><em>myapp.conf</em></strong> dentro del directorio <em>apache-custom</em> con este contenido:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
    DocumentRoot "/app"

    &lt;Directory "/app"&gt;
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.php
    &lt;/Directory&gt;

    # Enviar todas las peticiones a .php al FPM del contenedor `php`
    ProxyPassMatch ^/(.*\.php(/.*)?)$ fcgi://php:9000/app/$1
&lt;/VirtualHost&gt;
</code></pre></div></div>

<h3 id="paso-4-crear-el-archivo-customini">Paso 4. Crear el archivo custom.ini</h3>

<p>Este archivo contiene las <strong>opciones de configuraci칩n adicionales para PHP</strong>.</p>

<p>PHP se configura dentro del contenedor correspondiente, en un archivo llamado <em>php.ini</em>. Podemos agregar configuraciones adicionales sin necesidad de tocar el contenedor con un archivo de configuraci칩n adicional que mapearemos al interior del contenedor.</p>

<p>Crea un archivo llamado <strong><em>custom.ini</em></strong> en tu directorio de trabajo con este contenido:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>display_errors = On
error_reporting = E_ALL
opcache.enable = 0
</code></pre></div></div>

<p>Esto <strong>habilitar치 las opciones de depuraci칩n de errores</strong> de PHP. En un entorno de producci칩n, estas opciones se deshabilitar칤an, claro.</p>

<p>Si m치s adelante necesitas <strong>configuraciones adicionales para PHP</strong> (como incrementar el tama침o m치ximo de archivos subidos al servidor o el tiempo de procesamiento de un script), puedes hacerlo f치cilmente en este custom.ini.</p>

<h3 id="paso-5-levantar-los-contenedores-con-docker-compose-up">Paso 5. Levantar los contenedores con docker-compose up</h3>

<p>Ya podemos <strong>poner en marcha los cuatro contenedores</strong> tecleando (en el directorio de trabajo):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-compose up --build
</code></pre></div></div>

<p>O bien, si no hemos tocado la configuraci칩n de los contenedores recientemente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-compose up
</code></pre></div></div>

<p>Tambi칠n podemos lanzarlo en segundo plano, para que la consola no se quede bloqueada:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-compose up -d
</code></pre></div></div>

<h3 id="paso-6-probar-los-contenedores">Paso 6. Probar los contenedores</h3>

<p>Si todo ha ido bien, deber칤as tener estos servicios activos:</p>

<ul>
  <li><strong>http://localhost:8080</strong> -&gt; Aqu칤 deber칤a estar escuchando Apache/PHP. Si pones un archivo .php en la carpeta ./app de tu proyecto, tendr칤a que verse el resultado.</li>
  <li><strong>http://localhost:8000</strong> -&gt; Aqu칤 deber칤a estar escuchando PHPMyAdmin. El usuario y contrase침a de la base de datos est치n en el docker-compose.yml (los puedes cambiar all칤 si no te gustan).</li>
</ul>

<h3 id="paso-7-detener-los-contenedores">Paso 7. Detener los contenedores</h3>

<p>Para detener los contenedores, tan solo teclea:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose down
</code></pre></div></div>

<p>O bien pulsa <strong>CTRL + C</strong> si inciaste docker-compose en segundo plano (con la opci칩n -d).</p>
:ET