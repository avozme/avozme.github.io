I"`Ú<h2 class="no_toc" id="26-tdd-test-driven-development">2.6. TDD: test-driven development</h2>

<ul id="markdown-toc">
  <li><a href="#261-ventajas-de-hacer-testing-autom√°tico" id="markdown-toc-261-ventajas-de-hacer-testing-autom√°tico">2.6.1. Ventajas de hacer testing autom√°tico</a></li>
  <li><a href="#262-tipos-de-pruebas" id="markdown-toc-262-tipos-de-pruebas">2.6.2. Tipos de pruebas</a></li>
  <li><a href="#263-qu√©-es-tdd" id="markdown-toc-263-qu√©-es-tdd">2.6.3. ¬øQu√© es TDD?</a>    <ul>
      <li><a href="#flujo-de-trabajo-con-tdd" id="markdown-toc-flujo-de-trabajo-con-tdd">Flujo de trabajo con TDD</a></li>
      <li><a href="#unit-tests-are-first" id="markdown-toc-unit-tests-are-first">Unit Tests are FIRST</a></li>
    </ul>
  </li>
  <li><a href="#264-implantar-tdd-en-un-proyecto-php-con-php-unit" id="markdown-toc-264-implantar-tdd-en-un-proyecto-php-con-php-unit">2.6.4. Implantar TDD en un proyecto PHP con PHP Unit</a>    <ul>
      <li><a href="#instalar-y-preparar-phpunit" id="markdown-toc-instalar-y-preparar-phpunit">Instalar y preparar PHPUnit</a></li>
      <li><a href="#casos-de-prueba-de-phpunit" id="markdown-toc-casos-de-prueba-de-phpunit">Casos de prueba de PHPUnit</a></li>
      <li><a href="#escribiendo-mi-primer-caso-de-prueba" id="markdown-toc-escribiendo-mi-primer-caso-de-prueba">Escribiendo mi primer caso de prueba</a></li>
      <li><a href="#ejecutando-los-tests" id="markdown-toc-ejecutando-los-tests">Ejecutando los tests</a></li>
      <li><a href="#fixtures" id="markdown-toc-fixtures">Fixtures</a></li>
      <li><a href="#dobles-de-prueba" id="markdown-toc-dobles-de-prueba">Dobles de prueba</a></li>
      <li><a href="#dobles-de-prueba-stubs" id="markdown-toc-dobles-de-prueba-stubs">Dobles de prueba: <em>stubs</em></a></li>
      <li><a href="#dobles-de-prueba-mocks" id="markdown-toc-dobles-de-prueba-mocks">Dobles de prueba: <em>mocks</em></a></li>
      <li><a href="#cobertura" id="markdown-toc-cobertura">Cobertura</a></li>
    </ul>
  </li>
</ul>

<p>El <strong><em>testing</em></strong> o <strong>fase de pruebas</strong> es una de las grandes olvidadas en los cursos de programaci√≥n y este ciclo formativo no es una excepci√≥n. Realmente, parece que nunca hubiera tiempo para dedicarse a probar el software como es debido.</p>

<p>Vamos a dedicar este apartado al <em>testing</em> y vamos a ver algunas t√©cnicas que nos ayudar√°n a interiorizarlo y a integrarlo como parte de nuestra pr√°ctica profesional. En particular, nos vamos a centrar en el <strong>TDD</strong> o <strong><em>test-driven development</em></strong>, una metodolog√≠a de desarrollo que toma las pruebas del software como la piedra angular del proceso de desarrollo y que, por lo tanto, permite construir aplicaciones <em>en cualquier lenguaje</em> que resultan mucho m√°s confiables que las que se prueban a salto de mata.</p>

<h3 id="261-ventajas-de-hacer-testing-autom√°tico">2.6.1. Ventajas de hacer testing autom√°tico</h3>

<p>Imagina que est√°s desarrollando una aplicaci√≥n web que tiene multitud de funcionalidades. A ti te han encargado dos: hacer la pantalla de login y el mantenimiento de los usuarios registrados (altas, bajas, modificaciones, esas cosas).</p>

<p>Puede que decidas que empezar por la pantalla de login est√° bien, as√≠ que comienzas a desarrollarla y te centras en todas sus funcionalidades: comprobar que el usuario y la contrase√±a son correctas, prevenir los posibles ataques, informar al usuario de posibles errores, habilitar un mecanismo para resetear la contrase√±a en caso de olvido, etc.</p>

<p>Cuando terminas, ¬øque haces? <strong>Lo pruebas todo <em>manualmente</em></strong> una y otra vez. De hecho, lo habr√°s estado probando mientras lo desarrollabas. <em>Las pruebas manuales est√°n bien, y es conveniente hacerlas, <strong>pero no son suficiente</strong></em>. Siempre hay posibilidades que se nos pasan por alto y olvidamos probar. ¬øCu√°ntas veces no has ense√±ado un programa a un compa√±ero o a tu profesor despu√©s de haberlo usado mil veces y te ha fallado a los dos segundos porque han hecho algo que a ti no se te hab√≠a ocurrido comprobar?</p>

<p>Por lo tanto, aqu√≠ tenemos la primera ventaja de hacer un <em>testing</em>: <strong>el <em>testing</em> bien dise√±ado siempre detectar√° m√°s fallos que las pruebas manuales</strong>, adem√°s de consumir mucho menos tiempo por nuestra parte.</p>

<p>Sigamos imaginando. Cuando terminas la pantalla de login, comienzas a desarrollar tu segunda tarea, es decir, el mantenimiento de usuarios. Te centras durante varios d√≠as en este nuevo subprograma y todas sus funciones: insertar, modificar y borrar usuarios, validar campos, impedir repeticiones, prevenir ataques, etc.</p>

<p>Cuando terminas, <em>no puedes estar seguro de si algo de lo que has hecho ha podido afectar a la pantalla de login</em>. Por ejemplo, has podido a√±adir un nuevo campo que te hac√≠a falta a la tabla de usuarios, y eso puede afectar a c√≥mo se comporta el login. Conclusi√≥n: ¬°tienes que volver a probar el login de nuevo!</p>

<p>Con un <em>testing</em> automatizado y bien dise√±ado, esto no es necesario, y aqu√≠ viene la segunda gran ventaja: <strong>siempre estaremos seguros de que toda la aplicaci√≥n funciona</strong>, aunque vayamos a√±adiendo m√≥dulos y funcionalidades.</p>

<p>En resumen, hacer un buen <em>testing</em> nos asegura que estamos produciendo c√≥digo de calidad y libre de errores. No libre de errores al 100%, porque eso no existe, pero s√≠ de buena calidad. Y eso no solo dice mucho de nuestra profesionalidad, sino que te dar√° una tranquilidad a la hora de presentar tus proyectos a tus clientes o a tus jefes (¬°o a tus profesores!) que te aseguro que no tiene precio.</p>

<p>La metodolog√≠a TDD es √∫til cuando trabajas con proyectos grandes. Para proyectos peque√±os, suele dar buenos resultados hacer un <em>testing</em> m√°s o menos manual. Pero si trabajas as√≠ en un proyecto grande, notar√°s que al principio desarrollas muy deprisa pero, al cabo de unas semanas o unos meses, pasas m√°s tiempo <em>reparando</em> cosas que no funcionan de tu c√≥digo antiguo que desarrollando c√≥digo y funcionalidades nuevas. <em>Esta es la prueba m√°s clara de que ese proyecto habria necesitado de un proceso de testing mucho m√°s estricto</em>. Estos proyectos suelen acabar abandonados porque se vuelven imposibles de mantener.</p>

<p>En las primeras fases de desarrollo de un proyecto grande, puede parecerte que usar TDD es una p√©rdida de tiempo. Pero ese tiempo se recupera con creces m√°s adelante, cuando podemos seguir avanzando al mismo ritmo que al principio porque tenemos la seguridad de que todo sigue funcionando.</p>

<p>Y as√≠ llegamos a la √∫ltima gran ventaja de seguir una metodolog√≠a que automatice el <em>testing</em>: los programadores que trabajan de este modo y est√°n acostumbrados a producir c√≥digo de calidad <strong>ganan m√°s dinero</strong> que los programadores chapuceros que prueban sus aplicaciones manualmente. Y lo hacen porque, a la larga, resultan mucho m√°s productivos para su empresa.</p>

<p>As√≠ que la decisi√≥n es tuya: <strong>¬øquieres ser un programador/a que genere c√≥digo de calidad o te conformas con ser un programador/a chapucero?</strong></p>

<h3 id="262-tipos-de-pruebas">2.6.2. Tipos de pruebas</h3>

<p>La fase de pruebas de cualquier programa incluye diferentes tipos de prueba. Este no es un manual te√≥rico sobre ingenier√≠a del software (¬°Dios nos libre!), pero necesitas conocer al menos estos tres tipos de prueba para entender c√≥mo act√∫a la metodolog√≠a TDD sobre el flujo de trabajo en un proyecto:</p>

<ul>
  <li>
    <p><strong>Test unitario</strong>: estas pruebas se dedican a comprobar que una funcionalidad muy concreta responde correctamente.</p>

    <p>Por ejemplo, imagina que en tu pantalla de login quieres exigir al usuario que el campo <em>email</em> tenga formato de una direcci√≥n de correo bien escrita, as√≠ que escribes el c√≥digo necesario para hacer esa comprobaci√≥n. Pues bien, cuando compruebas si esa comprobaci√≥n est√° funcionando o no, est√°s haciendo un test unitario.</p>
  </li>
  <li>
    <p><strong>Test de integraci√≥n</strong>: estas pruebas comprueban el funcionamiento de varias funcionalidades o varios componentes trabajando en conjunto.</p>

    <p>Por ejemplo, cuando has terminado de escribir toda tu pantalla de login y quieres comprobar que todo funciona, est√°s haciendo un test de integraci√≥n. Ah√≠ est√°n en juego no solo las distintas funciones que has programado (comprobaci√≥n del email, comprobaci√≥n de la contrase√±a, consulta a la base de datos, etc), sino varios componentes de la aplicaci√≥n: javascript en el lado del cliente, una conexi√≥n con el servidor, tal vez un enrutador, etc.</p>
  </li>
  <li>
    <p><strong>Test de aceptaci√≥n</strong>: estas pruebas son parecidas a las de integraci√≥n, pero a√∫n m√°s amplias, implicando a componentes dispersos que previamente habr√°s probado mediante test de integraci√≥n y, en √∫ltima instancia, a toda la aplicaci√≥n en su conjunto. Es el test que se hace antes de poner la aplicaci√≥n en producci√≥n o de hacer una demo ante un cliente.</p>
  </li>
</ul>

<h3 id="263-qu√©-es-tdd">2.6.3. ¬øQu√© es TDD?</h3>

<p>La metodolog√≠a <strong>TDD</strong> o <strong><em>test-driven development</em></strong> es diferente del <em>testing</em> o fase de pruebas. TDD es una <strong>metodolog√≠a de desarrollo</strong>, es decir, una manera de trabajar en el desarrollo de un proyecto software, con la peculiaridad de que la metodolog√≠a TDD implica que el <em>testing</em> va a estar presente a lo largo de todo el desarrollo.</p>

<p>Es decir, que puedes hacer <em>testing</em> sin metodolog√≠a TDD, pero si trabajas con la metodolog√≠a TDD, es seguro que vas a estar haciendo <em>testing</em> todo el tiempo.</p>

<p>De hecho, cuando usas TDD, <strong>no escribes ni una sola l√≠nea de c√≥digo sin haber dise√±ado antes las pruebas para ese c√≥digo</strong>. El <em>testing</em> as√≠, en general, puede hacerse en cualquier momento del desarollo, pero si usas TDD estar√°s haciendo <em>testing</em> de forma continua.</p>

<h4 id="flujo-de-trabajo-con-tdd">Flujo de trabajo con TDD</h4>

<p>Desarrollar cualquier parte de tu aplicaci√≥n con TDD implica seguir siempre este orden:</p>

<ol>
  <li><strong>FASE ROJA</strong>: Consiste en <strong>dise√±ar las pruebas</strong> unitarias o de integraci√≥n de lo que sea que vamos a desarrollar a continuaci√≥n. Se llama <em>fase roja</em> porque estas pruebas siempre fallar√°n (y los errores, por aquello de que es un color muy llamativo, siempre se muestran en color rojo), ya que el c√≥digo a√∫n no est√° escrito.</li>
  <li><strong>FASE VERDE</strong>: Consiste en <strong>escribir el c√≥digo</strong> necesario para que las pruebas dejen de fallar, sin preocuparnos de si est√° muy bien escrito o no. Lo importante aqu√≠ es convertir esos errores en rojo en mensajes en verde.</li>
  <li><strong>REFACTORIZACI√ìN</strong>: Consiste en <strong>arreglar el c√≥digo</strong> anterior para dejarlo bien legible y siguiendo las directrices de nuestra empresa o de nuestro grupo de trabajo en cuanto a calidad. Las pruebas, por supuesto, deben seguir dando un resultado verde, es decir, el c√≥digo quedar√° vestido de domingo y seguir√° sin fallar.</li>
</ol>

<h4 id="unit-tests-are-first">Unit Tests are FIRST</h4>

<p>Los test unitarios pueden hacerse en cualquier momento del desarrollo, pero la metodolog√≠a TDD aboga por hacerlos ANTES de escribir el c√≥digo de las clases.</p>

<p>‚ÄúUnit Tests are FIRST‚Äù no es solo una frase para recordarnos la conveniencia de dise√±ar los tests antes de escribir el c√≥digo, sino que la palabra FIRST es un acr√≥nimo de las caracter√≠sticas que deben tener esos tests seg√∫n la metodolog√≠a TDD:</p>

<ul>
  <li>
    <p><strong>Fast</strong> (r√°pido): el n√∫mero de tests puede llegar a ser considerable. Si no se ejecutan con rapidez, cada vez que pasemos la bater√≠a de tests podemos tener que esperar un buen rato.</p>
  </li>
  <li>
    <p><strong>Isolated</strong> (aislado): debemos dise√±ar cada test para que sea independiente de factores externos y tambi√©n de los otros tests. Un cambio en uno de los tests no deber√≠a afectar al resto.</p>
  </li>
  <li>
    <p><strong>Repeateable</strong> (repetible): los tests siempre deben ofrecer los mismos resultados ante los mismos datos de prueba.</p>
  </li>
  <li>
    <p><strong>Selfverifying</strong> (autoverificable): los tests bien hechos solo pueden ofrecer dos resultados: o son un √©xito o fallan. No deben quedar a la interpretaci√≥n del desarrollador.</p>
  </li>
  <li>
    <p><strong>Timely</strong> (oportuno): los tests deben escribirse antes que el c√≥digo que se pretende verificar. Eso, que puede resultado antiintuitivo al principio, hace que tengamos mucho m√°s claro qu√© comportamiento debe tener el c√≥digo que vamos a escribir.</p>
  </li>
</ul>

<h3 id="264-implantar-tdd-en-un-proyecto-php-con-php-unit">2.6.4. Implantar TDD en un proyecto PHP con PHP Unit</h3>

<p>Vamos a ver c√≥mo usar PHP Unit para automatizar las pruebas unitarias de nuestras aplicaciones. Y lo vamos a hacer mediante un ejemplo.</p>

<p>Supongamos que una determinada funcionalidad de nuestra aplicaci√≥n tiene el cometido de comprobar que el campo <em>email</em> de un formulario no est√° vac√≠o y tiene formato de email (es decir, una @ y al menos un punto). En caso contrario, debe mostrar un mensaje de error. Podr√≠amos escribir ese c√≥digo m√°s o menos as√≠:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"email"</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">echo</span> <span class="s2">"Error: email incorrecto"</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="no">FILTER_VALIDATE_EMAIL</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">echo</span> <span class="s2">"Error: email incorrecto"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Este ejemplo tan simple ser√° el c√≥digo con el que trabajaremos para comprender c√≥mo se usa PHPUnit.</p>

<h4 id="instalar-y-preparar-phpunit">Instalar y preparar PHPUnit</h4>

<p>PHPunit, como cualquier paquete adicional para PHP, puede instalarse manualmente o, mejor, con <strong><em>composer</em></strong>. Ya hablamos de c√≥mo funciona este gestor de dependencias en el <a href="/docs/dwes/_site/php/caja-de-herramientas.html#gesti%C3%B3n-de-dependencias-con-composer">apartado 2.2.5</a>, as√≠ que vuelve a leerlo si no lo recuerdas.</p>

<p>Configuraremos <strong><em>composer.json</em></strong> de este modo:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
   <span class="dl">"</span><span class="s2">autoload</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">psr-4</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span><span class="dl">"</span><span class="s2">Application</span><span class="se">\\</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">src/</span><span class="dl">"</span><span class="p">}</span>
   <span class="p">},</span>
   <span class="dl">"</span><span class="s2">require-dev</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">phpunit/phpunit</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">^9.5</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">phpunit/php-code-coverage</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">^9.2</span><span class="dl">"</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>De este modo, le estamos indicando a <em>composer</em> que cargue autom√°ticamente las clases que encuentre en la carpeta <em>/src</em>, que es donde deben estar los fuentes de tu aplicaci√≥n (si no est√°n ah√≠, cambia el archivo de configuraci√≥n) y que las asigne al espacio de nombres (namespace) ‚ÄúApplication‚Äù. Tambi√©n estamos declarando las dependencias de <em>phpunit</em> para que los paquetes necesarios se instalen en la carpeta <em>/vendor</em>, de manera que tengamos PHPUnit disponible durante el desarrollo.</p>

<p>Para lanzar la instalaci√≥n de esos paquetes y la autocarga de las clases de la aplicaci√≥n, ahora tienes que teclear estos comandos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer install
$ composer dump-autoload
</code></pre></div></div>

<h4 id="casos-de-prueba-de-phpunit">Casos de prueba de PHPUnit</h4>

<p>Los <strong>casos de prueba</strong> son clases que contienen el c√≥digo necesario para probar otras clases.</p>

<p>Estos casos de prueba se suelen organizar del mismo modo que las clases reales. La costumbre es tener una carpeta llamada <em>tests</em> y, dentro de ella, reproducir la jerarqu√≠a de clases de todo el programa.</p>

<p>Adem√°s, existen una serie de convenciones de nombres que debemos respetar:</p>

<ul>
  <li>Si una clase de la aplicaci√≥n se llama <em>MiClase</em>, el caso de prueba de esa clase debe llamarse <em>MiClaseTest</em>.</li>
  <li>Los casos de prueba deben heredar de <em>PHPUnit/Framework/TestCase</em>.</li>
  <li>Los tests que haya dentro de los casos de prueba deben ser m√©todos p√∫blicos, sin par√°metros y contener el texto <em>test</em> en su nombre.</li>
  <li>Todos los tests deben comportarse como afirmaciones. Pueden ser como la funci√≥n <em>assertTrue()</em> del ejemplo anterior. En ese caso, estar√≠amos afirmando que cierta condici√≥n es <em>true</em> y, en otro caso, el test fallar√°. O pueden ser afirmaciones de tipo <em>assertEquals()</em> (el valor de algo es igual a cierto valor esperado o, si no, el test fallar√°), <em>assertContains()</em> (cierta estructura de datos contiene determinado valor; si no, el test fallar√°), <em>assertCount()</em> (una estructura de datos contiene un cierto n√∫mero de elementos; si no es as√≠, el test fallar√°), etc. PHPunit tiene predefinidas un enorme n√∫mero de afirmaciones como estas.</li>
  <li>Los tests se lanzan desde la l√≠nea de comandos. Lo m√°s c√≥modo es usar la consola integrada dentro de Visual Studio Code (o del editor que est√©s usando, si dispone de esta funcionalidad). Si no, siempre puedes abrir un terminal de texto en tu sistema operativo y moverte hasta la carpeta de tu proyecto.</li>
</ul>

<h4 id="escribiendo-mi-primer-caso-de-prueba">Escribiendo mi primer caso de prueba</h4>

<p>Aunque es posible llamar a una sola clase de prueba, lo habitual es lanzar la bater√≠a completa de tests de un directorio concreto. En nuestro ejemplo no habr√° diferencias porque, como es un ejemplo peque√±ito, solo tendremos una clase (que llamaremos <em>CheckFormLogin</em>) y su correspondiente caso de prueba (<em>CheckFormLoginTest</em>). Esta clase contendr√° las comprobaciones necesarias para saber si un formulario de login de una aplicaci√≥n web ha sido cumplimentado correctamente.</p>

<p>El c√≥digo de <em>CheckFormLogin</em> debe estar, como el resto de la aplicaci√≥n, en la carpeta <em>/src</em> (u la carpeta que hayamos preferido, siempre que se lo indiquemos a PHPUnit en <em>composer.json</em>):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Application</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">CheckFormLogin</span> <span class="p">{</span>

   <span class="k">private</span> <span class="nv">$status</span><span class="p">;</span>     <span class="c1">// Estado de la comprobaci√≥n de errores. Si vale 0, es que no hay ning√∫n error.</span>
   <span class="k">private</span> <span class="nv">$email</span><span class="p">;</span>      <span class="c1">// Campos del formulario. Solo trabajaremos con el email, pero se pueden a√±adir m√°s.</span>

   <span class="cm">/* Constructor. Pone el status a 0, que significa que no se ha detectado ning√∫n error en el formulario. */</span>
   <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Comprueba si el campo email est√° correctamente escrito. Pone el status a 1 si el email est√° vac√≠o y
      a 2 si el email no est√° correctamente formado. Devuelve el valor del status */</span>
   <span class="k">function</span> <span class="n">checkEmail</span><span class="p">()</span> <span class="p">{</span>      
      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">,</span> <span class="no">FILTER_VALIDATE_EMAIL</span><span class="p">))</span> <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Getter y setter para el atributo email */</span>
   <span class="k">function</span> <span class="n">getEmail</span><span class="p">()</span> <span class="p">{</span> 
      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">;</span> 
   <span class="p">}</span>
   <span class="k">function</span> <span class="n">setEmail</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">;</span>
   <span class="p">}</span> 
<span class="p">}</span>
</code></pre></div></div>

<p>Por supuesto, esta clase puede contener otros atributos y otros m√©todos para comprobar que otros campos de un formulario de login se han rellenado correctamente, pero para nuestro ejemplo solo usaremos <em>$email</em> y <em>checkEmail()</em>.</p>

<p>Necesitamos ahora escribir, en la carpeta <em>/test</em>, el caso de prueba correspondiente a la clase anterior:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Test</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Application\CheckFormLogin</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ChecCheckFormLoginTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span> <span class="p">{</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">testEmailIsEmpty</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$checkLogin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CheckFromLogin</span><span class="p">();</span>
      <span class="nv">$checkLogin</span><span class="o">-&gt;</span><span class="nf">setEmail</span><span class="p">(</span><span class="s2">""</span><span class="p">);</span>           <span class="c1">// Probamos un email vac√≠o</span>
      <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$checkLogin</span><span class="o">-&gt;</span><span class="nf">checkEmail</span><span class="p">();</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">testEmailBadFormat</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$checkLogin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CheckFromLogin</span><span class="p">();</span>  
      <span class="nv">$checkLogin</span><span class="o">-&gt;</span><span class="nf">setEmail</span><span class="p">(</span><span class="s2">"blablabla"</span><span class="p">);</span>  <span class="c1">// Probamos un email mal formateado</span>
      <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$checkLogin</span><span class="o">-&gt;</span><span class="nf">checkEmail</span><span class="p">();</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lo que hemos hecho en el caso de prueba es testear que la clase que estamos probando, <em>CheckFormLogin</em>, se comporta como debe en cada situaci√≥n. Por ejemplo, el primer m√©todo, <em>testEmailIsEmpty()</em>, comprueba qu√© pasa cuando la clase <em>CheckFormLogin</em> recibe como email una cadena vac√≠a (el atributo <em>status</em> deber√≠a pasar a valer 1, y eso es lo que comprobamos). El otro m√©todo, <em>testEmailBadFormat()</em>, comprueba qu√© sucede si la clase <em>CheckFormLogin</em> recibe un email mal formateado, sin arrobas ni puntos (el <em>status</em> deber√≠a valer 2).</p>

<p>Por supuesto, se pueden a√±adir otras comprobaciones, como el caso de un email correctamente escrito (el <em>status</em> deber√≠a valer 0).</p>

<p>Se hace f√°cil ver que construir los casos de prueba es un trabajo bastante costoso y que, en m√°s de una ocasi√≥n, requerir√° m√°s l√≠neas de c√≥digo que la propia aplicaci√≥n.</p>

<h4 id="ejecutando-los-tests">Ejecutando los tests</h4>

<p>Ya tenemos nuestro primer caso de prueba escrito para una de las clases de nuestra aplicaci√≥n. Ha llegado el momento de lanzar el test.</p>

<p>Para eso, nos salimos a la consola de texto (recuerda: si lo haces desde dentro del propio Visual Studio Code, todo resultar√° m√°s f√°cil) y escribimos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./vendor/bin/phpunit --colors test
</code></pre></div></div>

<p>As√≠ ejecutaremos phpunit (que est√° dentro de la carpeta <em>/vendor</em>, como todos los paquetes de terceros) y lanzamos el test de colores (lo mencionamos al principio: fase roja, fase verde y refactorizaci√≥n. Por eso se llama ‚Äútest de colores‚Äù).</p>

<p>PHPUnit lanzar√° todos los tests que encuentre y nos mostrar√° una pantalla de resultados, marcando en rojo los tests que hayan fallado, es decir, las afirmaciones o <em>assets</em> que no se hayan cumplido. Si pasamos los tests regularmente a toda la aplicaci√≥n, podemos ir haciendo crecer nuestro c√≥digo sin miedo a que los nuevos fragmentos de c√≥digo rompan algo de lo que ya hab√≠amos probado antes.</p>

<h4 id="fixtures">Fixtures</h4>

<p>Casi todos los m√©todos de los casos de prueba siguen el mismo patr√≥n:</p>

<ol>
  <li>Preparamos la clase que queremos probar (en nuestro ejemplo anterior, <em>CheckFormLogin</em>), creando un objeto de esa clase con los valores que correspondan.</li>
  <li>Se lanza la acci√≥n que queremos probar (en nuestro ejemplo, <em>checkEmail()</em>)</li>
  <li>Se realiza una afirmaci√≥n sobre el resultado de la acci√≥n anterior (en nuestro ejemplo, que el <em>status</em> valga 1 o 2).</li>
</ol>

<p>Hay ciertas partes de ese patr√≥n que se repetir√°n una y otra vez en todos los m√©todos del caso de prueba. Para evitar ese copy-paste, que siempre es una p√©sima pr√°ctica de programaci√≥n, existen las <em>fixtures</em> o caracter√≠sticas fijas que se repiten en todos los tests.</p>

<p>Incluso en el ejemplo anterior, que es muy simple, podemos observar una caracter√≠stica fija: todos los tests empiezan crando un objeto de tipo <em>CheckFormLogin</em>. Por supuesto, en tests m√°s realistas y complejos podr√≠a haber bastante m√°s c√≥digo repetido.</p>

<p>Pues bien, PHPUnit permite evitar la duplicaci√≥n de ese c√≥digo mediante dos m√©todos que se pueden a√±adir al caso de prueba:</p>

<ul>
  <li><strong><em>setUp()</em></strong> - El c√≥digo que pongamos en este m√©todo se ejecutar√° ANTES que los tests. Suele usarse para crear objetos y configurarlos.</li>
  <li><strong><em>tearDown()</em></strong> - El c√≥digo que escribamos aqu√≠ se ejecutar DESPU√âS de los tests, cuando todo haya terminado. Suele usarse para liberar la memoria o los recursos que hayan requerido los tests.</li>
</ul>

<p>En nuestro ejemplo anterior, podr√≠amos a√±adir esos dos m√©todos as√≠:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Test</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Application\CheckFormLogin</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ChecCheckFormLoginTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span> <span class="p">{</span>

   <span class="k">private</span> <span class="nv">$checkLogin</span><span class="p">;</span>   <span class="c1">// Este ser√° el objeto con el que haremos los tests   </span>

   <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">checkLogin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CheckLoginForm</span><span class="p">();</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">testEmailIsEmpty</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">checkLogin</span><span class="o">-&gt;</span><span class="nf">setEmail</span><span class="p">(</span><span class="s2">""</span><span class="p">);</span>           <span class="c1">// Probamos un email vac√≠o</span>
      <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">checkLogin</span><span class="o">-&gt;</span><span class="nf">checkEmail</span><span class="p">();</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">testEmailBadFormat</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">checkLogin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CheckFromLogin</span><span class="p">();</span>  
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">checkLogin</span><span class="o">-&gt;</span><span class="nf">setEmail</span><span class="p">(</span><span class="s2">"blablabla"</span><span class="p">);</span>  <span class="c1">// Probamos un email mal formateado</span>
      <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">checkLogin</span><span class="o">-&gt;</span><span class="nf">checkEmail</span><span class="p">();</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">protected</span> <span class="k">function</span> <span class="n">tearDown</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">checkLogin</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Como puedes ver, ya no repetimos la l√≠nea <code class="language-plaintext highlighter-rouge">checkLogin = new CheckFormLogin()</code> al principio de cada m√©todo, sino que ese c√≥digo repetido se escribe una sola vez, en el m√©todo <strong><em>setUp()</em></strong>. Y usamos el m√©todo <strong><em>tearDown()</em></strong> para eliminar el objeto que hemos creado. Esto √∫ltimo no es obligatorio (si no lo hubi√©ramos hecho, el recolector de basura de PHP se hubiera encargado de ello), pero mantener la simetr√≠a entre los m√©todos de creaci√≥n y destrucci√≥n se considera una buena pr√°ctica de programaci√≥n.</p>

<p>Como es l√≥gico, en un caso m√°s complejo que el de este ejemplo, tanto <em>setUp()</em> como <em>tearDown()</em> podr√≠an tener mucho m√°s trabajo que hacer.</p>

<h4 id="dobles-de-prueba">Dobles de prueba</h4>

<p>A veces, no se puede probar bien una clase porque esta necesita otros componentes (por ejemplo, otras clases) que no se pueden usar, por ejemplo porque a√∫n no est√°n desarrollados o porque tienen efectos secundarios que afectar√≠an a la propia prueba. ¬°Los diferentes componentes de las aplicaciones no suelen ser completamente independientes, y eso es un engorro a la hora de plantear las pruebas!</p>

<p>Esto puede hacer que nuestros tests sean muy dependientes unos de otros y, como vimos m√°s arriba, los tests deber√≠an ser completamente independientes entre s√≠.</p>

<p>Para solventar este problema existen los <strong>dobles de prueba</strong>, que se denominan as√≠ por los dobles de las pel√≠culas de acci√≥n que sustituyen a los actores y actrices en las escenas peligrosas.</p>

<p>Si el objeto que estamos probando necesita usar otro objeto diferente, podemos usar un doble de prueba en su lugar. Se comportar√° como un objeto real, pero no lo ser√°.</p>

<p>Por ejemplo, sup√≥n que estamos programando una aplicaci√≥n para jugar al solitario con la baraja espa√±ola, y que tenemos dos clases, una llamada <em>Baraja</em> y otra llamada <em>Jugador</em>. Son dos clases relacionadas entre s√≠:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Baraja</span> <span class="p">{</span>
   <span class="k">private</span> <span class="nv">$cartas</span><span class="p">;</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">cartas</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">"1-oros"</span><span class="p">,</span> <span class="s2">"2-oros"</span><span class="p">,</span> <span class="s2">"3-oros"</span><span class="p">,</span> <span class="mf">...</span><span class="p">,</span> <span class="s2">"12-oros"</span><span class="p">,</span>
                            <span class="s2">"1-copas"</span><span class="p">,</span> <span class="s2">"2-copas"</span><span class="p">,</span> <span class="s2">"3-copas"</span><span class="p">,</span> <span class="mf">...</span> <span class="s2">"12-copas"</span><span class="p">,</span>
                            <span class="s2">"1-espadas"</span><span class="p">,</span> <span class="s2">"2-espadas"</span><span class="p">,</span> <span class="mf">...</span><span class="p">,</span> <span class="s2">"12-espadas"</span><span class="p">,</span>
                            <span class="s2">"1-bastos"</span><span class="p">,</span> <span class="s2">"2-bastos"</span><span class="p">,</span> <span class="mf">...</span><span class="p">,</span> <span class="s2">"12-bastos"</span><span class="p">);</span>   
   <span class="p">}</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">getCarta</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Este m√©todo devuelve la siguiente carta de la baraja</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">getNumero</span><span class="p">(</span><span class="nv">$carta</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Este m√©todo recibe una carta y devuelve solo su n√∫mero</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">getPalo</span><span class="p">(</span><span class="nv">$carta</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Este m√©todo recibe una carta y devuelve solo su palo</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">getAll</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Este m√©todo nos devuelve todas las cartas que a√∫n faltan por salir</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">getMonton</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Este m√©todo nos devuelve todas las cartas que ya han salido</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">barajar</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Este m√©todo baraja las cartas (las desordena al azar)</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">cartasDisponibles</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Este m√©todo nos dice cu√°ntas cartas quedan disponibles (sin salir)</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">reset</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Este m√©todo vuelve a dejar la baraja en su estado inicial (ordenado)</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Jugador</span> <span class="p">{</span>
   <span class="k">private</span> <span class="nv">$nombre</span><span class="p">;</span>  <span class="c1">// Nombre del jugador</span>
   <span class="k">private</span> <span class="nv">$baraja</span><span class="p">;</span>  <span class="c1">// Baraja con la que va a jugar este jugador</span>
   <span class="k">private</span> <span class="nv">$puntos</span><span class="p">;</span>  <span class="c1">// Puntos del jugador</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">nombre</span> <span class="o">=</span> <span class="nv">$n</span><span class="p">;</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Baraja</span><span class="p">();</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">barajar</span><span class="p">();</span>
   <span class="p">}</span>

   <span class="c1">// Getter y setter del atributo $nombre</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">getNombre</span><span class="p">():</span> <span class="kt">string</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">nombre</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">setNombre</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">nombre</span> <span class="o">=</span> <span class="nv">$n</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// Getter y setter del atributo $baraja</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">getBaraja</span><span class="p">():</span> <span class="kt">Baraja</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">setBaraja</span><span class="p">(</span><span class="kt">Baraja</span> <span class="nv">$b</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// Este m√©todo extrae las dos siguientes cartas de la baraja y las devuelve en un array.</span>
   <span class="c1">// Si no hay cartas disponibles, resetea la baraja antes de sacar las dos cartas.</span>
   <span class="c1">// Si el n√∫mero de las dos cartas es igual, incrementa en 1 los puntos del jugador.</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">sacarDosCartas</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">cartasDisponibles</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nb">reset</span><span class="p">();</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">barajar</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="nv">$carta1</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">getCarta</span><span class="p">();</span>
      <span class="nv">$carta2</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">getCarta</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$baraja</span><span class="o">-&gt;</span><span class="nf">getNumero</span><span class="p">(</span><span class="nv">$carta1</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$baraja</span><span class="o">-&gt;</span><span class="nf">getNumero</span><span class="p">(</span><span class="nv">$carta2</span><span class="p">))</span> <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">puntos</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$carta1</span><span class="p">,</span> <span class="nv">$carta2</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// Etc. (aqu√≠ ir√≠an los dem√°s m√©todos de la clase)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>En este ejemplo, cuando creamos un objeto de tipo <em>Jugador</em>, tambi√©n creamos, indirectamente, un objeto de tipo <em>Baraja</em>, puesto que uno de los atributos de <em>Jugador</em> es una <em>Baraja</em> y el objeto <em>$this-&gt;baraja</em> se crea en el constructor.</p>

<p>Observa tambi√©n c√≥mo el m√©todo <em>getBaraja()</em> devuelve un objeto de tipo <em>Baraja</em> y <em>setBaraja()</em> recibe un objeto de ese mismo tipo para asignarlo al atributo <em>$this-&gt;baraja</em>.</p>

<p>M√°s abajo, el m√©todo <em>sacarDosCartas()</em> hace un uso exhaustivo del objeto <em>$this-&gt;baraja</em>, fundamental para que la clase <em>Jugador</em> funcione bien.</p>

<p>Pues bien, ¬øqu√© pasa cuando queremos escribir los tests de la clase <em>Jugador</em>? Porque si los tests deben ser independientes unos de otros, el test de <em>Jugador</em> no deber√≠a verse afectado por lo que ocurra en la clase <em>Baraja</em>. Por ejemplo, podr√≠a suceder que la clase <em>Baraja</em> a√∫n no est√© implementada completamente, o que contenga errores porque no haya sido depurada. En esos casos, los tests de la clase <em>Jugador</em> fallar√≠an, pero no por errores en <em>Jugador</em>, sino por errores a√∫n no resueltos en <em>Baraja</em>, que no es el componente que estamos probando ahora.</p>

<h4 id="dobles-de-prueba-stubs">Dobles de prueba: <em>stubs</em></h4>

<p>Para solventar situaci√≥n como la que acabamos de describir (que es muy habitual en sistemas complejos) se utilizan los <strong>dobles de prueba</strong>, que a veces se llaman <em>stubs</em> y a veces se llaman <em>mocks</em>. En concreto, <strong>necesitamos un doble de la clase <em>Baraja</em> que simule un comportamiento aceptable de esta clase para poder probar la clase <em>Jugador</em></strong>, que es lo que ahora nos interesa.</p>

<p>Puedes ver c√≥mo se crean esos dobles en este caso de prueba de la clase <em>Jugador</em>, que llamaremos <em>JugadorTest</em>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Test</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Application\Jugador</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">JugadorTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span> <span class="p">{</span>
   <span class="k">private</span> <span class="nv">$jugador</span><span class="p">;</span>
   <span class="k">private</span> <span class="nv">$baraja</span><span class="p">;</span>

   <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">persona</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Persona</span><span class="p">(</span><span class="s2">"John Doe"</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createMock</span><span class="p">(</span><span class="err">\</span><span class="nc">Application\Baraja</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">persona</span><span class="o">-&gt;</span><span class="nf">setBaraja</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// Aqu√≠ ir√≠an los m√©todos de los tests de la clase Jugador</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Observa con detenimiento el m√©todo <em>setUp()</em>. Ver√°s que hemos construido un objeto <em>Jugador</em> (al que queremos hacer los tests) y tambi√©n un objeto <em>Baraja</em>. Pero esa no es la clase que queremos probar, y por eso no creamos un objeto real, sino un <strong>doble de prueba</strong>.</p>

<p>Eso se consigue con <strong><em>createMock()</em></strong>, un m√©todo de PHPUNit heredado de <em>TestCase</em>. Este m√©todo solo necesita que le pasemos el nombre de una clase (que se obtiene con la expresi√≥n <em>\Application\Baraja::class</em>) para crear el doble de prueba. Para <em>Jugador</em>, este ser√° como un objeto <em>Baraja</em> real. De hecho, inmediatamente despu√©s se lo pasamos a <em>setBaraja()</em> para que el objeto <em>Jugador</em> lo asuma como su baraja de cartas.</p>

<p><strong>Pero el doble de prueba no es una <em>Baraja</em> de verdad, solo debe parecerlo y se debe comportar como si lo fuera</strong>. De modo que, en el test de <em>Jugador</em>, debemos especificar cu√°l deber√≠a ser un comportamiento apropiado con el √∫nico fin de testear la clase <em>Jugador</em>.</p>

<p>La forma m√°s simple de hacer esto ser√≠a forzando a que los m√©todos de <em>Baraja</em> devuelvan a <em>Jugador</em> un valor cualquiera, siempre que tenga sentido. Esto se hace cuando solo necesitamos que los m√©todos del doble nos devuelvan algo sin importar el valor concreto que, en realidad, no afecta al funcionamiento de la clase que estamos testeando.</p>

<p>Cuando un doble de prueba se comporta as√≠, devolviendo valores a lo loco (pero con sentido), se le suele llamar <strong><em>stub</em></strong>.</p>

<p>Por ejemplo, si te fijas en el m√©todo <em>sacarDosCartas()</em> de la clase <em>Jugador</em>, ver√°s que fallar√° porque los m√©todos de <em>Baraja</em> que se usan all√≠ a√∫n no est√°n implementados (<em>cartasDisponibles()</em>, <em>reset()</em>, <em>barajar()</em> o <em>getCarta()</em>). Esto provocar√° un fallo en el test, pero no es un error de <em>Jugador</em>.</p>

<p>Por lo tanto, para probar el funcionamiento del m√©todo <em>sacarDosCartas()</em>, usaremos un <em>stub</em> a√±adiendo en <em>sacarDosCartasTest()</em>, de este modo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c1">// Test para el m√©todo sacarDosCartas()</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">sacarDosCartasTest</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'cartasDisponibles'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">willReturn</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'barajar'</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'getCarta'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">willReturn</span><span class="p">(</span><span class="s1">'3-bastos'</span><span class="p">);</span>
      <span class="c1">// Aqu√≠ ir√≠a el resto del c√≥digo del test.</span>
   <span class="p">}</span>
</code></pre></div></div>

<p>¬°Y listo! Aunque los m√©todos <em>cartasDisponibles(), reset()</em> y compa√±√≠a a√∫n no existan en <em>Baraja</em>, podemos llamarlos en nuestro test y se comportar√°n como si existieran. De hecho, <em>cartasDisponibles()</em> nos devolver√° el valor 40 y <em>getCarta()</em> nos devolver√° ‚Äú3-bastos‚Äù, que son valores correctos y perfectamente v√°lidos para hacer nuestras pruebas. El valor que nos devolver√° el <em>stub</em> se indica, como puedes ver en el ejemplo, con <em>willReturn()</em>. Por su parte, los m√©todos <em>reset()</em> y <em>barajar()</em> no devolver√°n nada, porque realmente no tienen que hacerlo.</p>

<h4 id="dobles-de-prueba-mocks">Dobles de prueba: <em>mocks</em></h4>

<p>A veces, el doble de prueba no puede comportarse de forma tan simplona (devolver siempre el mismo valor para el mismo m√©todo), sino que necesitamos ‚Äúsimular‚Äù un comportamiento un poco m√°s complejo. Por ejemplo, hacer varias llamadas consecutivas al m√©todo y que este nos devuelva valores diferentes cada vez.</p>

<p>Cuando un doble de prueba tiene un comportamiento como este √∫ltimo, se denomina <strong><em>mock</em></strong> en lugar de <em>stub</em>. Y el objeto <em>Baraja</em> (que, recuerda, no es un objeto de la clase <em>Baraja</em> real, sino un doble) dispone de muchos m√©todos para ello, como:</p>

<ul>
  <li><strong><em>method()</em></strong>: para indicar qu√© m√©todo vamos a simular.</li>
  <li><strong><em>expects()</em></strong>: para especificar el n√∫mero de veces que ese m√©todo deber√≠a ser llamado durante las pruebas.</li>
  <li><strong><em>with()</em></strong>: para especificar los par√°metros que se le van a pasar al m√©todo en cada llamada.</li>
  <li><strong><em>will()</em></strong>: para especificar los valores que el m√©todo devolver√° en cada llamada.</li>
</ul>

<p>Estos m√©todos, a su vez, tienen multitud de variantes. Por ejemplo, <em>will()</em> tiene una variante llamada <em>willReturnOnConsecutive()</em>, que permite especificar una lista de valores que el <em>mock</em> devolver√° en las sucesivas invocaciones. La lista de posibilidades es realmente grande y aqu√≠ no tenemos espacio para verla entera, pero puedes encontrarla en la <a href="https://phpunit.readthedocs.io/es/latest/test-doubles.html">documentaci√≥n oficial de PHPUnit</a>.</p>

<p>En el siguiente ejemplo, vamos a extender el m√©todo <em>sacarDosCartasTest()</em> para que compruebe una de las cosas que tiene que hacer esa funci√≥n: incrementar los puntos del jugador en caso de que el n√∫mero de dos cartas consecutivas sea el mismo. Para ello, forzaremos al <em>mock</em> para que nos devuelva unos valores concretos en las sucesivas llamadas. Observa c√≥mo se hace eso usando <em>willReturnOnConsecutive()</em> en el m√©todo <em>getCarta()</em> del <em>mock</em>, que ahora devolver√° ‚Äú3-bastos‚Äù en la primera llamada y ‚Äú3-oros‚Äù en la segunda.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c1">// Test para el m√©todo sacarDosCartas()</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">sacarDosCartasTest</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'cartasDisponibles'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">willReturn</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'barajar'</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'getCarta'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">willReturnOnConsecutive</span><span class="p">(</span><span class="s1">'3-bastos'</span><span class="p">,</span> <span class="s1">'3-oros'</span><span class="p">);</span>
      <span class="c1">// Aqu√≠ ir√≠a el resto del c√≥digo del test. Por ejemplo, vamos a comprobar si</span>
      <span class="c1">// el m√©todo sacarDosCartas() incrementa los puntos del jugador cuando salen dos</span>
      <span class="c1">// cartas del mismo n√∫mero</span>
      <span class="nv">$puntos_ini</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">jugador</span><span class="o">-&gt;</span><span class="nf">getPuntos</span><span class="p">();</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">baraja</span><span class="o">-&gt;</span><span class="nf">sacarDosCartas</span><span class="p">();</span>                  <span class="c1">// Este m√©todo llamar√° dos veces a getCarta()</span>
      <span class="nv">$puntos_fin</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">jugador</span><span class="o">-&gt;</span><span class="nf">getPuntos</span><span class="p">();</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$puntos_fin</span> <span class="o">-</span> <span class="nv">$puntos_ini</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  <span class="c1">// Los puntos deber√≠an haberse incrementado en 1</span>
   <span class="p">}</span>
</code></pre></div></div>

<p>El resto de cosas que hubiera que comprobar de <em>sacarDosCartas()</em> se pueden programar tambi√©n con ayuda de <em>mocks</em> y <em>stubs</em> de la clase <em>Baraja</em>, igual que hemos comprobado que los puntos se incrementan al sacar dos cartas consecutivas del mismo n√∫mero. Y eso mismo habr√≠a que hacerlo con todos los m√©todos de la clase <em>Jugador</em>. Recuerda que, en la metodolog√≠a TDD, las pruebas se dise√±an ANTES de escribir el c√≥digo de las clases. Puede parecer engorroso (y, de hecho, lo es) pero el c√≥digo resultante es much√≠simo m√°s robusto.</p>

<p>Tal vez el sistema de dobles de prueba de PHPUnit te haya parecido un poco dif√≠cil de usar. Es cierto: los dobles de prueba no son la mayor fortaleza de PHPUnit. Existen, por suerte o por desgracia, otras bibliotecas para hacer pruebas basadas completamente en la creaci√≥n de dobles que tal vez te apetezca explorar, como <a href="https://github.com/mockery/mockery">Mockery</a> o Phake (https://github.com/mlively/phake).</p>

<h4 id="cobertura">Cobertura</h4>

<p>La <strong>cobertura</strong> de los tests es una medida de la cantidad de c√≥digo que est√° siendo comprobada por los casos de prueba que hayamos escrito.</p>

<p>Una cobertura del 100% no indica necesariamente que hayamos escrito tests para todos los posibles comportamientos de nuestro c√≥digo o todos los flujos de ejecuci√≥n, pero s√≠ es un indicador de que nos estamos aproximando a ello. Por el contrario, una cobertura baja siempre nos dice que nuestros casos de prueba son a√∫n muy mejorables.</p>

<p>PHPUnit proporciona una herramienta para generar informes muy intuitivos acerca de la cobertura de nuestros tests. Para obtener ese informe en formato HTML, simplemente teclea esto en la consola de Visual Studio Code (o de tu IDE preferido):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ XDEBUG_MODE = coverage ./vendor/bin/phpunit --coverage-filter test --coverage-html coverage test
</code></pre></div></div>

<p>Este comando generar√° una p√°gina HTML que se ubicar√° en el directorio <em>coverage</em> y que puede abrirse con cualquier navegador web.</p>

:ET