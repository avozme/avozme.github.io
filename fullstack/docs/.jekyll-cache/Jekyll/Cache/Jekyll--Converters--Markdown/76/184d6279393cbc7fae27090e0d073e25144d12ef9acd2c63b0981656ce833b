I"≤h<h2 id="82-perl">8.2. Perl</h2>

<p>A partir de este punto, veremos varios lenguajes alternativos a PHP (es decir, su ‚Äúcompetencia‚Äù) siguiendo siempre el mismo esquema:</p>
<ul>
  <li>Primero, enumeraremos las caracter√≠sticas y filosofia del lenguaje.</li>
  <li>Luego explicaremos a grandes rasgos c√≥mo hay que configurar el servidor para poder usar ese lenguaje para desarrollo web.</li>
  <li>Despu√©s mostraremos la sintaxis b√°sica del lenguaje.</li>
  <li>Por √∫ltimo, escribiremos dos ejemplos completos en cada lenguaje: un sencillo ‚Äúhola, mundo‚Äù y un programa algo m√°s complejo que lanza una validaci√≥n de login mediante ajax. En este segundo caso, la parte del cliente ser√° siempre la misma, y solo cambiaremos la parte del servidor. Eso te permitir√° apreciar las diferencias entre unos lenguajes y otros. Enseguida te dar√°s cuenta de que esas diferencias son m√≠nimas.</li>
</ul>

<h3 id="821-caracter√≠sticas-del-lenguaje-perl">8.2.1. Caracter√≠sticas del lenguaje Perl</h3>

<p>Fecha de aparici√≥n: 1987.</p>

<p>Perspectivas:</p>
<ul>
  <li>Uso decreciente.</li>
  <li>Apto para tareas peque√±as y r√°pidas.</li>
  <li>Cuenta con desarrolladores muy fieles y experimentados. Documentaci√≥n muy extensa.</li>
  <li>Soporte amplio en cualquier servidor.</li>
</ul>

<p>Filosof√≠a de Perl:</p>
<ul>
  <li>Versi√≥n mejorada del shell scripting de Unix.</li>
  <li>Pensado para procesamiento r√°pido de archivos de texto y automatizaci√≥n de tareas de administraci√≥n del sistema.</li>
  <li>Favorece la programaci√≥n √°gil, r√°pida y sucia de scripts.</li>
  <li>√ânfasis en las expresiones regulares.</li>
  <li>Multiparadigma.</li>
  <li>En combinaci√≥n con CGI, se populariz√≥ para aplicaciones web antes de la aparici√≥n de PHP.</li>
</ul>

<h3 id="822-configuraci√≥n-necesaria-en-el-servidor">8.2.2. Configuraci√≥n necesaria en el servidor</h3>

<p>Para utilizar Perl en un servidor Apache o similar, necesitaremos:</p>

<ol>
  <li>Instalar el int√©rprete Perl (usr/bin/perl).</li>
  <li>Activar los m√≥dulos perl y/o cgi de Apache y configurar el handler para CGI.</li>
  <li>Instalar m√≥dulos Perl adicionales para acceso a bases de datos, etc.</li>
</ol>

<p>Se puede ejecutar el int√©rprete Perl de forma nativa en Apache, o bien hacerlo a trav√©s de CGI. Lo primero es m√°s dif√≠cil de configurar y raramente se encuentra en hostings web compartidos.</p>

<h3 id="823-sintaxis-b√°sica-de-perl">8.2.3. Sintaxis b√°sica de Perl</h3>

<p>Las variables en Perl no se declaran, tienen tipado din√°mico y son globales por defecto.</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$var</span> <span class="o">=</span> <span class="nv">valor</span><span class="p">;</span>
<span class="k">print</span> <span class="p">"</span><span class="s2">La variable var vale </span><span class="si">$variable</span><span class="p">";</span>
</code></pre></div></div>

<p>Algunos operadores:</p>

<ul>
  <li>Comparaci√≥n: lt, gt, le, ge, eq, ne‚Ä¶</li>
  <li>Asignaci√≥n: =</li>
</ul>

<p>Algunas estructuras de control:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="nv">condicion</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">Acciones</span>
<span class="p">}</span>


<span class="k">if</span> <span class="p">(</span><span class="nv">condicion</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">Acciones</span><span class="o">-</span><span class="mi">1</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nv">Acciones</span><span class="o">-</span><span class="mi">2</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="824-entrada--salida">8.2.4. Entrada / salida</h3>

<p>Entrada de datos est√°ndar:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chop</span> <span class="p">(</span> <span class="nv">$variable</span> <span class="o">=</span> <span class="o">&lt;</span><span class="bp">STDIN</span><span class="o">&gt;</span> <span class="p">);</span>
</code></pre></div></div>

<p>Lectura de datos desde un formulario HTML:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nv">CGI</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$cgi</span> <span class="o">=</span> <span class="nv">CGI</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$cgi</span><span class="o">-&gt;</span><span class="nv">param</span><span class="p">("</span><span class="s2">username</span><span class="p">");</span>
</code></pre></div></div>

<p>Salida:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span> <span class="p">"</span><span class="s2">cadena </span><span class="si">$variable</span><span class="s2"> cadena...</span><span class="p">";</span> 
</code></pre></div></div>

<h3 id="825-bibliotecas-funciones-y-clases">8.2.5. Bibliotecas, funciones y clases</h3>

<p>Para utilizar una biblioteca o <strong><em>package</em></strong>, como se denominan en Perl, se emplea la palabra <strong>use</strong>:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nv">nombre</span><span class="o">-</span><span class="nv">biblioteca</span><span class="p">;</span>
</code></pre></div></div>

<p>Las bibliotecas se empaquetan en archivos con extensi√≥n .pm (<strong><em>Perl Modules</em></strong>). Dentro de ellas, puede haber una colecci√≥n de funciones o m√©todos que se declaran as√≠:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">package</span> <span class="nv">nombre</span><span class="o">-</span><span class="nv">biblioteca</span><span class="p">;</span>

<span class="nv">Sub</span> <span class="nv">nombre</span><span class="o">-</span><span class="nv">funcion</span> <span class="p">(</span><span class="nv">argumentos</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">Acciones</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Estas funciones pueden usarse desde fuera de la biblioteca con esta sintaxis:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nv">nombre</span><span class="o">-</span><span class="nv">biblioteca</span><span class="p">;</span>

<span class="nv">nombre</span><span class="o">-</span><span class="nn">biblioteca::</span><span class="nv">nombre</span><span class="o">-</span><span class="nv">funcion</span><span class="p">(</span><span class="nv">argumentos</span><span class="p">);</span>
</code></pre></div></div>

<p>Los <strong><em>packages</em></strong> tambi√©n pueden usarse para construir clases (o algo parecido) de las que luego se pueden instanciar objetos. M√°s o menos as√≠:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">package</span> <span class="nv">nombre</span><span class="o">-</span><span class="nv">de</span><span class="o">-</span><span class="nv">la</span><span class="o">-</span><span class="nv">clase</span><span class="p">;</span>

  <span class="k">sub </span><span class="nf">new</span> <span class="p">{</span>
      <span class="c1"># Este es el m√©todo constructor</span>
      <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="p">{};</span>      <span class="c1"># Array para los atributos</span>
      <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">VAR1</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1"># Un atributo</span>
      <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">VAR2</span><span class="p">}</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>  <span class="c1"># Otro atributo</span>
  <span class="p">}</span>

  <span class="k">sub </span><span class="nf">otro</span><span class="p">-m√©todo{</span>
       <span class="c1"># Aqu√≠ van el resto de m√©todos de la clase</span>
  <span class="p">}</span>
  <span class="k">sub </span><span class="nf">DESTROY</span> <span class="p">{</span>
       <span class="c1"># M√©todo destructor</span>
  <span class="p">}</span>
  <span class="mi">1</span>    <span class="c1"># Para que el int√©rprete Perl no se queje al interpretar este archivo</span>
</code></pre></div></div>

<p>Como puedes observar, Perl est√° lleno de peculiaridades que muchos consideran anticuadas o, como m√≠nimo, poco elegantes. Observa si no la forma que tiene de crear los atributos de instancia, los caprichosos nombres de los m√©todos (a veces en min√∫scula, a veces en may√∫scula) o la necesidad de terminar el <strong><em>package</em></strong> con un 1 para que el int√©rprete Perl lo considere un script v√°lido.</p>

<p>Por √∫ltimo, para instanciar un objeto de esta clase:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nv">nombre</span><span class="o">-</span><span class="nv">de</span><span class="o">-</span><span class="nv">la</span><span class="o">-</span><span class="nv">clase</span><span class="p">;</span>
<span class="nv">$objeto</span> <span class="o">=</span> <span class="nv">nombre</span><span class="o">-</span><span class="nv">de</span><span class="o">-</span><span class="nv">la</span><span class="o">-</span><span class="nv">clase</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="826-ejemplo-1-en-perl-hola-mundo">8.2.6. Ejemplo 1 en Perl: Hola mundo</h3>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/perl</span>
<span class="k">print</span> <span class="p">"</span><span class="s2">Content-type: text/html</span><span class="se">\n\n</span><span class="p">";</span>
<span class="k">print</span> <span class="p">"</span><span class="s2">&lt;html&gt;&lt;title&gt;Hola mundo&lt;/title&gt;&lt;body&gt;</span><span class="p">";</span>
<span class="k">print</span> <span class="p">"</span><span class="s2">Hola, mundo</span><span class="p">";</span>
<span class="k">print</span> <span class="p">"</span><span class="s2">&lt;/body&gt;&lt;/html&gt;</span><span class="p">";</span>
</code></pre></div></div>

<h3 id="827-ejemplo-2-en-perl-login-con-comprobaci√≥n-de-email-por-ajax">8.2.7. Ejemplo 2 en Perl: login con comprobaci√≥n de email por Ajax</h3>

<p>Este segundo ejemplo, como hemos explicado m√°s arriba, consistir√° en un formulario de login que comprobar√° el nombre de usuario y la contrase√±a mediante una petici√≥n Ajax.</p>

<h4 id="formulario-html">Formulario HTML</h4>

<p>El formulario de login es un simple c√≥digo HTML que ser√° id√©ntico en todos los ejemplos que veremos en el resto de este cap√≠tulo, as√≠ que solo lo mostraremos aqu√≠ por primera vez.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"loginForm"</span> <span class="na">name=</span><span class="s">"loginForm"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;fieldset&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"username"</span><span class="nt">&gt;</span>Nombre de usuario<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"username"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">class=</span><span class="s">"text"</span> <span class="na">size=</span><span class="s">"20"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"password"</span><span class="nt">&gt;</span>Contrase√±a<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">id=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">class=</span><span class="s">"text"</span> <span class="na">size=</span><span class="s">"20"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/fieldset&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<h4 id="script-jquery">Script jQuery</h4>

<p>El script que lanza la petici√≥n Ajax (cuyo c√≥digo puede ir en el mismo archivo que el formulario) ser√° <strong><em>casi</em></strong> id√©ntico en todos los ejemplos: solo cambiar√° el nombre del script al que se lanza la petici√≥n.</p>

<p>En nuestro caso actual, es script lo hemos llamado <strong>login.pl</strong> (la extensi√≥n .pl denota que se trata de un script escrito en lenguaje Perl). Como es l√≥gico, en ejemplos posteriores, tendr√≠as que cambiar el nombre de ese archivo por el que corresponda (login.py si estamos usando Python, login.rb si estamos usando Ruby, etc).</p>

<p>Para no repetirnos innecesariamente, no volveremos a mostrar tampoco el c√≥digo de este script en los ejemplos sucesivos.</p>

<p>Observa que Javascript est√° esperando que el servidor responda con un JSON que puede llevar estos tres datos en su interior:</p>
<ul>
  <li>data.error: Un string con un texto de error en caso de que el usuario o la contrase√±a sean incorrectos.</li>
  <li>data.success: Un string con un texto de √©xito en caso de que el usuario y la contrase√±a sean correctos.</li>
  <li>data.userId: Un entero con el ID del usuario logueado (solo en caso de √©xito).</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">form#loginForm</span><span class="dl">"</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
    <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#username</span><span class="dl">'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="dl">'</span><span class="s1">value</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Obtenemos el username</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#password</span><span class="dl">'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="dl">'</span><span class="s1">value</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Obtenemos la password</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Los valores de username y password no est√°n vac√≠os</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">login.pl</span><span class="dl">"</span><span class="p">,</span> 
        <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">json</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="dl">"</span><span class="s2">username=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;password=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">password</span><span class="p">,</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// El servidor ha devuelto un error de login</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">div#loginResult</span><span class="dl">'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">data.error: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">div#loginResult</span><span class="dl">'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">);</span>
          <span class="p">}</span> 
          <span class="k">else</span> <span class="p">{</span>            <span class="c1">// El servidor ha hecho el login correctamente</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">form#loginForm</span><span class="dl">'</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">div#loginResult</span><span class="dl">'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">data.success: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">success</span> 
              <span class="o">+</span> <span class="dl">"</span><span class="s2">, data.userid: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">userid</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">div#loginResult</span><span class="dl">'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="dl">"</span><span class="s2">success</span><span class="dl">"</span><span class="p">);</span>
          <span class="p">}</span> 
        <span class="p">}</span> 
      <span class="p">});</span> 
    <span class="p">}</span> 
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">div#loginResult</span><span class="dl">'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">Debe escribir su nombre de usuario y su contrase√±a</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">div#loginResult</span><span class="dl">'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span> 
    <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">div#loginResult</span><span class="dl">'</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">();</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="script-perl-en-el-lado-del-servidor-loginpl">Script Perl en el lado del servidor (login.pl)</h4>

<p>Este ser√≠a el script en Perl que responder√≠a a la petici√≥n Ajax anterior.</p>

<p>Observa que, a pesar de la peculiar sintaxis de Perl, la estructura del algoritmo es id√©ntica a la que usar√≠amos si lo escribi√©ramos en PHP:</p>
<ol>
  <li>Recuperamos los datos del formulario (username y password)</li>
  <li>Conectamos con la base de datos</li>
  <li>Lanzamos la consulta contra la tabla de usuarios</li>
  <li>En funci√≥n del resultado de la consulta, preparamos nuestro JSON de respuesta al cliente</li>
  <li>Devolvemos el JSON al cliente</li>
</ol>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/perl -T</span>
<span class="k">use</span> <span class="nv">CGI</span><span class="p">;</span>
<span class="k">use</span> <span class="nv">DBI</span><span class="p">;</span>
<span class="k">use</span> <span class="nv">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nv">warnings</span><span class="p">;</span>

<span class="c1"># read the CGI params</span>
<span class="k">my</span> <span class="nv">$cgi</span> <span class="o">=</span> <span class="nv">CGI</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$cgi</span><span class="o">-&gt;</span><span class="nv">param</span><span class="p">("</span><span class="s2">username</span><span class="p">");</span>
<span class="k">my</span> <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$cgi</span><span class="o">-&gt;</span><span class="nv">param</span><span class="p">("</span><span class="s2">password</span><span class="p">");</span>

<span class="c1"># connect to the database</span>
<span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="nv">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">("</span><span class="s2">DBI:mysql:database=mydb;host=localhost;port=2009</span><span class="p">",</span>  
  <span class="p">"</span><span class="s2">mydbusername</span><span class="p">",</span> <span class="p">"</span><span class="s2">mydbpassword</span><span class="p">")</span> 
  <span class="ow">or</span> <span class="nb">die</span> <span class="nv">$</span><span class="nn">DBI::</span><span class="nv">errstr</span><span class="p">;</span>

<span class="c1"># check the username and password in the database</span>
<span class="k">my</span> <span class="nv">$statement</span> <span class="o">=</span> <span class="sx">qq{SELECT id FROM users WHERE username=? and password=?}</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="nv">prepare</span><span class="p">(</span><span class="nv">$statement</span><span class="p">)</span>
  <span class="ow">or</span> <span class="nb">die</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="nv">errstr</span><span class="p">;</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nv">execute</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
  <span class="ow">or</span> <span class="nb">die</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nv">errstr</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$userID</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nv">fetchrow_array</span><span class="p">;</span>

<span class="c1"># create a JSON string according to the database result</span>
<span class="k">my</span> <span class="nv">$json</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$userID</span><span class="p">)</span> <span class="p">?</span> 
  <span class="sx">qq{{"success" : "login is successful", "userid" : "$userID"}}</span> <span class="p">:</span> 
  <span class="sx">qq{{"error" : "username or password is wrong"}}</span><span class="p">;</span>

<span class="c1"># return JSON string</span>
<span class="k">print</span> <span class="nv">$cgi</span><span class="o">-&gt;</span><span class="nv">header</span><span class="p">(</span><span class="o">-</span><span class="s">type</span> <span class="o">=&gt;</span> <span class="p">"</span><span class="s2">application/json</span><span class="p">",</span> <span class="o">-</span><span class="s">charset</span> <span class="o">=&gt;</span> <span class="p">"</span><span class="s2">utf-8</span><span class="p">");</span>
<span class="k">print</span> <span class="nv">$json</span><span class="p">;</span>
</code></pre></div></div>
:ET