I"¿V<h1 class="no_toc" id="ap√©ndice-2-virtualizaci√≥n-con-docker">Ap√©ndice 2. Virtualizaci√≥n con Docker</h1>

<ul id="markdown-toc">
  <li><a href="#a21-qu√©-es-docker" id="markdown-toc-a21-qu√©-es-docker">A2.1. ¬øQu√© es Docker?</a></li>
  <li><a href="#a22-comandos-usuales-de-docker" id="markdown-toc-a22-comandos-usuales-de-docker">A2.2. Comandos usuales de Docker</a></li>
  <li><a href="#a23-persistencia-de-datos" id="markdown-toc-a23-persistencia-de-datos">A2.3. Persistencia de datos</a></li>
  <li><a href="#a24-montando-con-docker-un-servidor-web-con-persistencia-de-datos" id="markdown-toc-a24-montando-con-docker-un-servidor-web-con-persistencia-de-datos">A2.4. Montando con Docker un servidor web con persistencia de datos</a>    <ul>
      <li><a href="#paso-1-crear-docker-composeyml" id="markdown-toc-paso-1-crear-docker-composeyml">Paso 1. Crear ./docker-compose.yml</a></li>
      <li><a href="#paso-2-crear-un-dockerfile-para-php" id="markdown-toc-paso-2-crear-un-dockerfile-para-php">Paso 2. Crear un ./Dockerfile para PHP</a></li>
      <li><a href="#paso-3-crear-apache-customhttpdconf" id="markdown-toc-paso-3-crear-apache-customhttpdconf">Paso 3. Crear ./apache-custom/httpd.conf</a></li>
      <li><a href="#paso-4-crear-apache-custommyappconf" id="markdown-toc-paso-4-crear-apache-custommyappconf">Paso 4. Crear ./apache-custom/myapp.conf</a></li>
      <li><a href="#paso-5-crear-el-archivo-customini" id="markdown-toc-paso-5-crear-el-archivo-customini">Paso 5. Crear el archivo custom.ini</a></li>
      <li><a href="#paso-6-levantar-los-contenedores-con-docker-compose-up" id="markdown-toc-paso-6-levantar-los-contenedores-con-docker-compose-up">Paso 6. Levantar los contenedores con docker-compose up</a></li>
      <li><a href="#paso-7-probar-los-contenedores" id="markdown-toc-paso-7-probar-los-contenedores">Paso 7. Probar los contenedores</a></li>
      <li><a href="#paso-8-detener-los-contenedores" id="markdown-toc-paso-8-detener-los-contenedores">Paso 8. Detener los contenedores</a></li>
    </ul>
  </li>
</ul>

<h2 id="a21-qu√©-es-docker">A2.1. ¬øQu√© es Docker?</h2>

<p><strong>Docker</strong> es una herramienta de virtualizaci√≥n basada en <em>contenedores</em>.</p>

<p>Un <strong>contenedor</strong> es un paquete de software completamente independiente del sistema donde se ejecuta. Recibe ese nombre por los contenedores que se utilizan en el transporte mar√≠timo, que tienen unas medidas y una forma estandarizada y que aislan por completo la carga que llevan dentro del exterior.</p>

<p>Un contenedor Docker hace lo mismo, pero con un conjunto de software: lo aisla por completo del exterior. El software que hay dentro del contenedor se puede ejecutar en cualquier m√°quina gracias al <em>runtime</em> de Docker, que se comporta como un mini-sistema operativo virtualizado que corre sobre la m√°quina anfitri√≥n.</p>

<p>Un contenedor puede contener cualquier cosa. Por ejemplo, Apache. De ese modo, podemos ejecutar Apache en cualquier m√°quina (siempre que tenga previamente instalado Docker) sin necesidad de instalarlo realmente, con todo lo que ello conlleva de configuraci√≥n de la m√°quina, consumo de recursos, etc. El contenedor Docker puede ponerse en marcha cuando queramos y detenerse en cualquier momento, sin dejar ning√∫n rastro en la m√°quina anfitriona.</p>

<p>En definitiva, puedes usar y/o testear <em>cualquier</em> programa sin tener que instalarlo realmente en tu m√°quina.</p>

<p>Los contenedores Docker vienen empaquetados en <strong>im√°genes</strong>, a partir de los cuales pueden lanzarse todos los contenedores que necesitemos. Es decir, las im√°genes con como las <em>clases</em> en programaci√≥n orientada a objetos, y los contenedores son como los objetos que se instancian a partir de esas clases.</p>

<p>Cada cual puede construir las im√°genes que necesite o usar im√°genes ya hechas, con todo lo necesario en su interior para ejecutar cualquier software sin necesidad de instalarlo ni configurarlo. Hay repositorios p√∫blicos de im√°genes, como <strong>DockerHub</strong>, donde uno puede encontrar im√°genes de pr√°cticamente cualquier cosa.</p>

<h2 id="a22-comandos-usuales-de-docker">A2.2. Comandos usuales de Docker</h2>

<p>Aunque Docker puede usarse desde un interfaz gr√°fico (como <strong>Docker Desktop</strong>), lo habitual es hacerlo desde la l√≠nea de comandos.</p>

<p>Esto no es un manual de Docker, pero s√≠ vamos a enumerar aqu√≠ los comandos principales que nos ser√°n √∫tiles como desarrolladores web para que puedas usarlos como referencia r√°pida cuando tengas que trabajar con Docker.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker run [nombre-imagen]</code> - Lanza un contenedor a partir de la imagen especificada. Si la imagen no est√° descargada en el ordenador, la buscar√° en el repositorio configurado (por defecto, <em>DockerHub</em>).</li>
  <li><code class="language-plaintext highlighter-rouge">docker ps</code> - Muestra un listado con los contenedores que hay actualmente en el sistema. Un contenedor no tiene por qu√© estar necesariamente corriendo, sino que existen otros estados (detenido, preparado, finalizado, etc). Con <code class="language-plaintext highlighter-rouge">docker ps -a</code> podemos ver todos los contenedores, tambi√©n los detenidos.</li>
  <li><code class="language-plaintext highlighter-rouge">docker stop [id-del-contenedor]</code> - Detiene un contenedor. Su id puede obtenerse con <code class="language-plaintext highlighter-rouge">docker ps</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">docker start [id-del-contenedor]</code> - Reanuda un contenedor.</li>
  <li><code class="language-plaintext highlighter-rouge">docker exec -it [id-del-contenedor] bash</code> - Abrir un terminal en el contenedor.</li>
  <li><code class="language-plaintext highlighter-rouge">docker-compose up -d</code> - Inicia todos los contenedores especificados en el archivo <em>docker-compose.yml</em> del directorio actual. Necesitas tener instalado, adem√°s de Docker, el programa <em>docker-compose</em>.</li>
  <li><code class="language-plaintext highlighter-rouge">docker-compose down</code> - Detiene todos los contenedores especificados en el archivo <em>docker-compose.yml</em> del directorio actual.</li>
</ul>

<h2 id="a23-persistencia-de-datos">A2.3. Persistencia de datos</h2>

<p>Cualquier cosa que guardes en un contenedor de Docker se perder√° cuando el contenedor se detenga. Por ejemplo, si est√°s haciendo una aplicaci√≥n web que usa una base de datos MySQL, y tu servidor MySQL est√° en un contenedor Docker, toda la informaci√≥n de esa base de datos se perder√° cada vez que destruyas el contenedor.</p>

<p>Es posible evitar eso usando la persistencia de datos. Consiste en pedirle a Docker que guarde datos <em>fuera</em> del contenedor, para que estos no se pierdan al reiniciarlo o eliminarlo. Por ejemplo, los datos de la base de datos.</p>

<p>La persistencia se puede habilitar con <strong>docker run</strong>. Por ejemplo:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -d --name mysql-container -e MYSQL_ROOT_PASSWORD=clave123 -v mysql-data:/var/lib/mysql mysql:latest
</code></pre></div></div>

<p>La persistencia se habilita con <em>-v mysql-data:/var/lib/mysql</em>, que crea (o usa) un volumen llamado <em>mysql-data</em> y lo monta en la ruta <em>/var/lib/mysql</em> de la m√°quina real, que es donde MySQL suele guardar los datos.</p>

<p>Personalmente, encuentro m√°s sencillo hacerlo todo a trav√©s de <strong>docker-compose</strong>. Por ejemplo, mira este archivo de configuraci√≥n docker-compose.yml:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">mysql</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:latest</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">mysql-container</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mysql-data:/var/lib/mysql</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3306:3306"</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">mysql-data</span><span class="pi">:</span>
</code></pre></div></div>

<p>Con este archivo de configuraci√≥n se lanzar√° un contenedor de <em>mysql</em> en cuanto tecleemos <em>docker-compose up</em>. Observa estas dos l√≠neas:</p>

<ul>
  <li>La l√≠nea <em>volumes</em> dentro del servicio <em>mysql</em> monta el volumen virtual <em>mysql-data</em> en <em>/var/lib/mysql</em>, el lugar de la m√°quina real donde MySQL suele guardar los datos.</li>
  <li>La l√≠nea <em>volumes</em> al final del archivo declara el volumen llamado <em>mysql-data</em>, que Docker crear√° si no existe.</li>
</ul>

<p>As√≠, los datos persisten en <em>/var/lib/mysql</em> aunque detengas o elimines el contenedor.</p>

<h2 id="a24-montando-con-docker-un-servidor-web-con-persistencia-de-datos">A2.4. Montando con Docker un servidor web con persistencia de datos</h2>

<p>En esta secci√≥n vamos a mostrar c√≥mo montar un servidor web con im√°genes Docker y levantarlo o apagarlo con docker-compose.</p>

<p>Usaremos las im√°genes oficiales de cada desarrollador, y necesitaremos poner en marcha <strong>cuatro contenedores</strong> simult√°neamente, por lo que ser√° mucho m√°s c√≥modo hacerlo con docker-compose para poder levantarlas todas a la vez y no de una en una:</p>

<ol>
  <li><strong>Servidor Apache</strong></li>
  <li><strong>Int√©rprete PHP</strong></li>
  <li><strong>Servidor MariaDB</strong></li>
  <li><strong>PHPMyAdmin</strong></li>
</ol>

<p>Adem√°s, necesitamos que los datos de MariaDB sean persistentes, es decir, que no se pierdan cuando detengamos los contenedores.</p>

<p>Lograr esto es complicadillo, pero trabajar con los servidores siempre lo es. A cambio, tendremos un entorno f√°cilmente transportable a otros servidores.</p>

<p>Te dejo las instrucciones paso a paso para que lo consigas sin desesperarte demasiado:</p>

<h3 id="paso-1-crear-docker-composeyml">Paso 1. Crear ./docker-compose.yml</h3>

<p>Crea un archivo <strong><em>docker-compose.yml</em></strong> en tu directorio de trabajo con este contenido exacto, para trabajar con las im√°gene de nuestros cuatro servicios.</p>

<p>Usaremos solo las im√°genes oficiales. Algunas las tendremos que modificar un poco para que sirvan a nuestros prop√≥sitos: para eso montaremos los archivos <em>custom.ini</em> (en la imagen de PHP) y <em>httpd.conf</em> y <em>myapp.conf</em> (en la imagen de Apache).</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">php</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>  
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./app:/app</span>
      <span class="pi">-</span> <span class="s">./custom.ini:/usr/local/etc/php/conf.d/custom.ini</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mariadb</span>

  <span class="na">apache</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">httpd:2.4</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:80"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./app:/app</span>
      <span class="pi">-</span> <span class="s">./apache-custom/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro</span>
      <span class="pi">-</span> <span class="s">./apache-custom/myapp.conf:/usr/local/apache2/conf/extra/myapp.conf:ro</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">php</span>

  <span class="na">mariadb</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mariadb:10.6</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">MYSQL_ROOT_PASSWORD</span><span class="pi">:</span> <span class="m">1234</span>
      <span class="na">MYSQL_DATABASE</span><span class="pi">:</span> <span class="s">pruebas</span>
      <span class="na">MYSQL_USER</span><span class="pi">:</span> <span class="s">user</span>
      <span class="na">MYSQL_PASSWORD</span><span class="pi">:</span> <span class="m">1234</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mariadb_data:/var/lib/mysql</span>

  <span class="na">phpmyadmin</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">phpmyadmin/phpmyadmin</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8000:80"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">PMA_HOST</span><span class="pi">:</span> <span class="s">mariadb</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mariadb</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">mariadb_data</span><span class="pi">:</span>
</code></pre></div></div>

<h3 id="paso-2-crear-un-dockerfile-para-php">Paso 2. Crear un ./Dockerfile para PHP</h3>

<p>La imagen oficial de PHP-FPM es muy minimalista y viene con muy pocas extensiones instaladas. Tenemos que instalar algunas librer√≠as adicionales en ese contenedor (como <em>pdo_mysql</em> para acceso a bases de datos MySQL con PDO).</p>

<p>Esto se logra creando un archivo llamado <strong><em>Dockerfile</em></strong> en el directorio ra√≠z (en la misma carpeta donde tengas <em>docker-compose.yml</em>) con este contenido:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM php:8.2-fpm

# Instalar dependencias necesarias
RUN apt-get update &amp;&amp; apt-get install -y \
        default-mysql-client \
        libzip-dev \
        unzip \
        git \
    &amp;&amp; docker-php-ext-install pdo pdo_mysql mysqli zip \
    &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*
</code></pre></div></div>

<p>As√≠ informamos a Docker de que:</p>
<ul>
  <li>a) Queremos usar <em>php:8.2-fpm</em>, la imagen oficial de PHP (versi√≥n 8.2) como base para el contenedor.</li>
  <li>b) Queremos instalar (con el comando <em>RUN apt-get</em>) varias extensiones √∫tiles al levantar el contenedor por primera vez (puede tardar un poco).</li>
</ul>

<h3 id="paso-3-crear-apache-customhttpdconf">Paso 3. Crear ./apache-custom/httpd.conf</h3>

<p>Por defecto, la imagen oficial de Apache no interpreta el c√≥digo PHP, sino que lo sirve en texto plano, como si fuera HTML.</p>

<p>Podemos reconfigurar esta imagen sin tener que meter mano tambi√©n a este contenedor:</p>

<ol>
  <li>Crea el directorio <strong><em>apache-custom</em></strong> en tu carpeta de trabajo.</li>
  <li>Crea el archivo <strong><em>./apache-custom/httpd.conf</em></strong> con este contenido:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># httpd.conf m√≠nimo preparado para usar Apache httpd:2.4 + PHP-FPM

ServerRoot "/usr/local/apache2"

# Puerto en el que Apache escuchar√° dentro del contenedor
Listen 80

# M√≥dulos esenciales
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule env_module modules/mod_env.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule alias_module modules/mod_alias.so
LoadModule negotiation_module modules/mod_negotiation.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule headers_module modules/mod_headers.so

# M√≥dulos necesarios para proxying a PHP-FPM
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so

# Informaci√≥n del servidor
ServerAdmin you@example.com
ServerName localhost:80

# Archivos de tipos mime
TypesConfig conf/mime.types

# Logs: enviar a stdout/stderr para que docker-compose logs funcione bien
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 common

# Seguridad por defecto
&lt;Directory /&gt;
    AllowOverride none
    Require all denied
&lt;/Directory&gt;

# DocumentRoot por defecto
DocumentRoot "/usr/local/apache2/htdocs"
&lt;Directory "/usr/local/apache2/htdocs"&gt;
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
&lt;/Directory&gt;

# √çndices (queremos que index.php tenga preferencia sobre index.html)
&lt;IfModule dir_module&gt;
    DirectoryIndex index.php index.html
&lt;/IfModule&gt;

# Incluimos el virtualhost personalizado que defines en apache-custom/myapp.conf
Include conf/extra/myapp.conf

# Fin del archivo
</code></pre></div></div>

<h3 id="paso-4-crear-apache-custommyappconf">Paso 4. Crear ./apache-custom/myapp.conf</h3>

<p>En este archivo de configuraci√≥n adicional redirigiremos todas las peticiones de archivos .php hacia el contenedor con el int√©rprete PHP. El resto de archivos ser√°n servidos por Apache.</p>

<p>Crea el archivo <strong><em>./apache-custom/myapp.conf</em></strong> con este contenido:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
    DocumentRoot "/app"

    &lt;Directory "/app"&gt;
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.php
    &lt;/Directory&gt;

    # Enviar todas las peticiones a .php al FPM del contenedor `php`
    ProxyPassMatch ^/(.*\.php(/.*)?)$ fcgi://php:9000/app/$1
&lt;/VirtualHost&gt;
</code></pre></div></div>

<h3 id="paso-5-crear-el-archivo-customini">Paso 5. Crear el archivo custom.ini</h3>

<p>Este archivo contiene las <strong>opciones de configuraci√≥n adicionales para PHP</strong>.</p>

<p>PHP se configura dentro del contenedor correspondiente, en un archivo llamado <em>php.ini</em>. Podemos agregar configuraciones adicionales sin necesidad de tocar el contenedor con un archivo de configuraci√≥n adicional que mapearemos al interior del contenedor.</p>

<p>Crea un archivo llamado <strong><em>custom.ini</em></strong> en tu directorio de trabajo con este contenido:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>display_errors = On
display_startup_errors = On
error_reporting = E_ALL
opcache.enable = 0
opcache.enable_cli = 0
output_buffering = Off
</code></pre></div></div>

<p>Esto <strong>habilitar√° las opciones de depuraci√≥n de errores</strong> de PHP. En un entorno de producci√≥n, estas opciones se deshabilitar√≠an, claro.</p>

<p>Tambi√©n deshabilitar√° la cach√©, imprescindible para que, al desarrollar, nuestros cambios se vean inmediatamente en el servidor.</p>

<p>Si m√°s adelante necesitas <strong>configuraciones adicionales para PHP</strong> (como incrementar el tama√±o m√°ximo de archivos subidos al servidor o el tiempo de procesamiento de un script), puedes hacerlo f√°cilmente en este custom.ini.</p>

<h3 id="paso-6-levantar-los-contenedores-con-docker-compose-up">Paso 6. Levantar los contenedores con docker-compose up</h3>

<p>Ya lo tenemos todo preparado.</p>

<p>Ahora podemos <strong>poner en marcha los cuatro contenedores</strong> tecleando (en el directorio de trabajo):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">--build</span>   <span class="c"># Lanzar contenedores la primera vez (o despu√©s cambiar docker-compose.yml o Dockerfile)</span>
</code></pre></div></div>

<p>O bien, si no hemos tocado la configuraci√≥n de los contenedores recientemente:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up   <span class="c"># Lanzar contenedores habitualmente</span>
</code></pre></div></div>

<p>Tambi√©n podemos lanzarlo en segundo plano, para que la consola no se quede bloqueada:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span>   <span class="c"># Lanzar contenedores en segundo plano</span>
</code></pre></div></div>

<h3 id="paso-7-probar-los-contenedores">Paso 7. Probar los contenedores</h3>

<p>Si todo ha ido bien, deber√≠as tener estos servicios activos:</p>

<ul>
  <li><strong>http://localhost:8080</strong> -&gt; Aqu√≠ deber√≠a estar escuchando Apache/PHP. Si pones un archivo .php en la carpeta ./app de tu proyecto, tendr√≠a que verse el resultado.</li>
  <li><strong>http://localhost:8000</strong> -&gt; Aqu√≠ deber√≠a estar escuchando PHPMyAdmin. El usuario y contrase√±a de la base de datos est√°n en el <em>docker-compose.yml</em> (los puedes cambiar all√≠ si no te gustan).</li>
</ul>

<h3 id="paso-8-detener-los-contenedores">Paso 8. Detener los contenedores</h3>

<p>Para detener los contenedores, tan solo teclea:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose down
</code></pre></div></div>

<p>O bien pulsa <strong>CTRL + C</strong> si inciaste docker-compose en segundo plano (con la opci√≥n -d).</p>
:ET