I"à˛<h1 class="no_toc" id="4-arquitectura-mvc">4. Arquitectura MVC</h1>

<ul id="markdown-toc">
  <li><a href="#41-patrones-de-software" id="markdown-toc-41-patrones-de-software">4.1. Patrones de software</a>    <ul>
      <li><a href="#411-tipos-de-patrones" id="markdown-toc-411-tipos-de-patrones">4.1.1. Tipos de patrones</a></li>
      <li><a href="#412-ejemplo-de-patr√≥n-el-patr√≥n-singleton" id="markdown-toc-412-ejemplo-de-patr√≥n-el-patr√≥n-singleton">4.1.2. Ejemplo de patr√≥n: el patr√≥n Singleton</a></li>
    </ul>
  </li>
  <li><a href="#42-arquitectura-de-una-aplicaci√≥n-web" id="markdown-toc-42-arquitectura-de-una-aplicaci√≥n-web">4.2. Arquitectura de una aplicaci√≥n web</a>    <ul>
      <li><a href="#421-arquitecturas-f√≠sicas-multicapa-multitier" id="markdown-toc-421-arquitecturas-f√≠sicas-multicapa-multitier">4.2.1. Arquitecturas F√çSICAS multicapa (multitier)</a></li>
      <li><a href="#422-arquitecturas-l√≥gicas-multicapa-multilayer" id="markdown-toc-422-arquitecturas-l√≥gicas-multicapa-multilayer">4.2.2. Arquitecturas L√ìGICAS multicapa (multilayer)</a></li>
      <li><a href="#423-ventajas-de-las-arquitecturas-multicapa" id="markdown-toc-423-ventajas-de-las-arquitecturas-multicapa">4.2.3. Ventajas de las arquitecturas multicapa</a></li>
    </ul>
  </li>
  <li><a href="#43-la-arquitectura-modelo-vista-controlador-mvc" id="markdown-toc-43-la-arquitectura-modelo-vista-controlador-mvc">4.3. La arquitectura Modelo-Vista-Controlador (MVC)</a>    <ul>
      <li><a href="#431-qu√©-es-el-mvc" id="markdown-toc-431-qu√©-es-el-mvc">4.3.1. ¬øQu√© es el MVC?</a></li>
      <li><a href="#432-mvc-en-la-pr√°ctica-una-implementaci√≥n-incremental" id="markdown-toc-432-mvc-en-la-pr√°ctica-una-implementaci√≥n-incremental">4.3.2. MVC en la pr√°ctica: una implementaci√≥n incremental</a></li>
    </ul>
  </li>
  <li><a href="#44-el-patr√≥n-mvc-en-la-teor√≠a" id="markdown-toc-44-el-patr√≥n-mvc-en-la-teor√≠a">4.4. El patr√≥n MVC en la teor√≠a</a></li>
  <li><a href="#45-ejercicios-propuestos" id="markdown-toc-45-ejercicios-propuestos">4.5. Ejercicios propuestos</a></li>
</ul>

<p>En ingenier√≠a del software, como en cualquier otra ingenier√≠a, existen una serie de soluciones estandarizadas que se ajustan sorprendentemente bien a una enorme variedad de situaciones diferentes. Estas soluciones se denominan <strong>patrones de software</strong>, y vamos a empezar este tema hablando de ellas.</p>

<p>Despu√©s nos centraremos en los <strong>patrones de arquitectura</strong>, y sobre todo en uno en concreto denominado <strong>MVC o Modelo-Vista-Controlador</strong> que tiene una enorme importancia en el √°mbito de las aplicaciones web.</p>

<p>Pero, antes de meternos a saco con el patr√≥n MVC, tendremos que darle un par de vueltas al t√©rmino ‚Äúarquitectura‚Äù, porque, en el √°mbito de las aplicaciones web, se usa con dos significados distintos que conviene que tengas claros para no hacerte un l√≠o.</p>

<p>Terminaremos el tema mostrando, como siempre, un ejemplo de c√≥digo bastante basado en la arquitectura MVC, de modo que puedas usarlo para comprender mejor los conceptos te√≥ricos y como base para tus propios proyectos.</p>

<h2 id="41-patrones-de-software">4.1. Patrones de software</h2>

<p>Antes de entrar en la parte m√°s pr√°ctica de todo este asunto, es decir, antes de que veamos los patrones de arquitectura y los apliquemos en un ejemplo concreto de aplicaci√≥n web, tienes que dejarme que te hable de los <strong>patrones de software</strong>.</p>

<p>Los patrones de software son <em>soluciones comprobadas a problemas comunes en el desarrollo de software</em>. La arquitectura MVC, de hecho, es un patr√≥n, porque se ha probado infinidad de veces y se adapta a la perfecci√≥n a multitud de problemas diferentes.</p>

<p>Para que un patr√≥n pueda considerarse tal cosa, tiene que cumplir estas condiciones:</p>

<ul>
  <li>Debe haber sido comprobado en otros sistemas.</li>
  <li>Debe ser f√°cilmente reutilizable.</li>
  <li>Debe ser aplicable a diferentes circunstancias.</li>
  <li>Debe estar bien documentado.</li>
</ul>

<h3 id="411-tipos-de-patrones">4.1.1. Tipos de patrones</h3>

<p>Dependiendo del grado de abstracci√≥n del patr√≥n, existen patrones de diverso tipo:</p>

<ul>
  <li>De arquitectura</li>
  <li>De dise√±o</li>
  <li>De creaci√≥n de objetos</li>
  <li>De estructura de clases</li>
  <li>De comportamiento</li>
  <li>De dialectos</li>
  <li>De interacci√≥n o interfaz de usuario</li>
  <li>De an√°lisis</li>
  <li>De dominio</li>
</ul>

<h3 id="412-ejemplo-de-patr√≥n-el-patr√≥n-singleton">4.1.2. Ejemplo de patr√≥n: el patr√≥n Singleton</h3>

<p>Antes de centrarnos en el patr√≥n MVC, vamos a ver, solo a modo de ejemplo, otro tipo de patr√≥n: <strong>el patr√≥n Singleton</strong>, que est√° considerado un <em>patr√≥n de dise√±o</em>.</p>

<p>Algunos recursos en una aplicaci√≥n son de tal naturaleza que s√≥lo puede existir una instancia de ese tipo de recurso. Por ejemplo, la conexi√≥n a la base de datos a trav√©s de un manejador de base de datos. A veces interesa compartir un manejador de base de datos para que el resto de recursos no tengan que conectarse y desconectarse continuamente de la BD, y s√≥lo deber√≠a existir una instancia de ese manejador.</p>

<p>El patr√≥n Singleton cubre esta necesidad. Un objeto es ‚Äúsingleton‚Äù si la aplicaci√≥n puede generar una y s√≥lo una instancia del mismo.</p>

<p>Esta es una implementaci√≥n sencilla y reutilizable de ese patr√≥n. Utiliza un constructor privado para evitar que se creen varias instancias del objeto y un m√©todo <em>static</em> para obtener la √∫nica instancia permitida.</p>

<p>Ojo, que solo se trata de un ejemplo. De hecho, ni siquiera est√° completo, porque en PHP hay varias formas de construir un objeto sin pasar por el constructor. No te lo tomes como algo que tengas que aprenderte de memoria o algo as√≠. Lo interesante de este ejemplo es que veas que existen muchos patrones que pueden (y, de hecho, deben) reutilizarse una y otra vez en el dise√±o de aplicaciones.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Singleton</span>
<span class="p">{</span>
   <span class="k">private</span> <span class="k">static</span> <span class="nv">$instancia</span><span class="p">;</span>  <span class="c1">// Referencia a la √∫nica instancia de este objeto. Es private</span>
                               <span class="c1">// para que nadie pueda usarla desde fuera del objeto</span>

   <span class="c1">// Constructor privado. Nadie podr√° crear objetos desde fuera de la clase.</span>
   <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">contador</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// Este m√©todo comprueba si existe ya una instancia del objeto Singleton.</span>
   <span class="c1">// Si existe, la devuelve. Si no existe, la crea antes de devolverla.</span>
   <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getInstance</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instancia</span> <span class="k">instanceof</span> <span class="k">self</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="k">self</span><span class="o">::</span><span class="nv">$instancia</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">self</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instancia</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Teniendo una clase como esa, el objeto Singleton puede usarse de este modo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Las dos variables contendr√°n, en realidad, el mismo objeto Singleton</span>
<span class="nv">$single1</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
<span class="nv">$single2</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
</code></pre></div></div>

<p>Por supuesto, a la clase Singleton podemos a√±adirle todos los m√©todos que necesitemos, como a cualquier clase, sin que pierda su condici√≥n de Singleton.</p>

<h2 id="42-arquitectura-de-una-aplicaci√≥n-web">4.2. Arquitectura de una aplicaci√≥n web</h2>

<p>Ahora que tenemos claro qu√© es un patr√≥n de software, vamos a centrarnos en los <strong>patrones de arquitectura</strong>.</p>

<p>Pero existe un problema cuando hablamos de ‚Äúarquitectura de una aplicaci√≥n‚Äù en el √°mbito de las aplicaciones web.</p>

<p>El problema es este: usamos el t√©rmino <em>‚Äúarquitectura de una aplicaci√≥n‚Äù</em> para referirnos a dos cosas distintas: la <em>arquitectura f√≠sica</em> y la <em>arquitectura l√≥gica</em>.</p>

<p>Vamos a intentar explicar la diferencia.</p>

<h3 id="421-arquitecturas-f√≠sicas-multicapa-multitier">4.2.1. Arquitecturas F√çSICAS multicapa (multitier)</h3>

<p>Una <strong>arquitectura f√≠sica de varios niveles</strong> (multinivel o <em>multitier</em>, en ingl√©s) consiste en un conjunto de ordenadores conectados a una red que ejecutan de forma conjunta una aplicaci√≥n.</p>

<p>El ejemplo m√°s sencillo es la arquitectura cliente-servidor, la m√°s popular en aplicaciones web sencillas: una m√°quina cliente y una m√°quina servidor ejecutan alternativamente fragmentos del c√≥digo, proporcionando al usuario final la sensaci√≥n de una aplicaci√≥n unificada.</p>

<p><img src="/docs/dwes/_site/assets/images/04-arquitectura-2-niveles.png" alt="Arquitectura en 2 niveles" /></p>

<p>Por supuesto, nada impide que tengamos m√°s de dos m√°quinas colaborando en red para ejecutar una aplicaci√≥n web. Podemos tener, por ejemplo, un cliente, un servidor web y un servidor de bases de datos (estos dos √∫ltimos en dos m√°quinas f√≠sicas diferentes). Esto ser√≠a una arquitectura de 3 niveles f√≠sicos.</p>

<p>Esta arquitectura se puede generalizar. Una con N niveles f√≠sicos tendr√≠a este aspecto:</p>

<p><img src="/docs/dwes/_site/assets/images/04-arquitectura-N-niveles.png" alt="Arquitectura en N niveles" /></p>

<p>La arquitectura f√≠sica es algo que incumbe sobre todo a los administradores de sistemas, que son los encargados de montarla, configurarla y mantenerla. Para el programador, sin embargo, suele resultar transparente.</p>

<p>Por ejemplo, cuando nos conectamos a un servidor de bases de datos desde nuestra aplicaci√≥n, poco importa que ese servidor est√© en la misma m√°quina f√≠sica o en otra m√°quina diferente: la forma de conectarse y operar con la base de datos es exactamente la misma.</p>

<p>As√≠ que la arquitectura f√≠sica, siendo importante, no lo es demasiado para nosotros y nosotras como desarrolladores.</p>

<p>En cambio, la arquitectura l√≥gica es otra historia‚Ä¶</p>

<h3 id="422-arquitecturas-l√≥gicas-multicapa-multilayer">4.2.2. Arquitecturas L√ìGICAS multicapa (multilayer)</h3>

<p>Ahora viene la vuelta de tuerca: la arquitectura de una aplicaci√≥n tambi√©n puede referirse a sus capas (<em>layers</em> en ingl√©s) l√≥gicas. Es decir, a las capas de software que nosotros, los desarrolladores/as, creamos.</p>

<p><strong>Dividir una aplicaci√≥n en capas que colaboran entre s√≠ por medio de interfaces bien definidos</strong> no es una idea nueva, ni pertenece exclusivamente al √°mbito de la programaci√≥n web. Pero la mayor parte de las aplicaciones web hacen uso de este mecanismo de abstracci√≥n.</p>

<p>La idea es fragmentar nuestra aplicaci√≥n en capas de niveles de abstracci√≥n cada vez mayor. En un extremo, la <strong>capa m√°s abstracta</strong> es la que interacciona con el <strong>usuario</strong>: ah√≠ se implementar√° nuestro interfaz de usuario, o lo que en aplicaciones web se llama <em>front-end</em>.</p>

<p>En el otro extremo, la <strong>capa menos abstracta</strong> es la que est√° en contacto con el <strong>hardware</strong> de la m√°quina. Bueno, en el caso de una aplicaci√≥n web, no hay contacto directo con el harware, sino con otras capas a√∫n menos abstractas que est√°n fuera de nuestra aplicaci√≥n, como el sistema operativo, el servidor web o el gestor de bases de datos. Esas capas externas a nuestra aplicaci√≥n son las que, realmente, interaccionan con el hardware en √∫ltima instancia.</p>

<p>Esta divisi√≥n en capas de abstracci√≥n, que puede parecer una complicaci√≥n innecesaria, tiene un mont√≥n de ventajas y por eso se usa en cualquier aplicaci√≥n un poco m√°s complicada que ‚ÄúHola, mundo‚Äù.</p>

<h3 id="423-ventajas-de-las-arquitecturas-multicapa">4.2.3. Ventajas de las arquitecturas multicapa</h3>

<p>Las arquitecturas multicapa permiten varias cosas que no pueden hacerse con los c√≥digos monol√≠ticos. Entre otras:</p>

<ul>
  <li>Desarrollar en paralelo cada capa (mayor rapidez de desarrollo).</li>
  <li>Aplicaciones m√°s robustas gracias al encapsulamiento. ¬øTe suena? ¬°Programaci√≥n orientada a objetos! Cada capa se implementa en una clase, y cada clase hace su trabajo sin importunar a las dem√°s y sin preocuparse por c√≥mo funcionan las otras internamente.</li>
  <li>El matenimiento es m√°s sencillo.</li>
  <li>M√°s flexibilidad para a√±adir m√≥dulos.</li>
  <li>M√°s seguridad, al poder aislar (relativamente) cada capa del resto.</li>
  <li>Mejor escalabilidad: es m√°s f√°cil hacer crecer al sistema.</li>
  <li>Mejor rendimiento (aunque esto podr√≠a discutirse: puedes hacer un sistema multicapa con un rendimiento desastroso y un sistema monol√≠tico que vaya como un tiro. Pero, en general, es m√°s f√°cil mejorar el rendimiento trabajando en cada capa por separado).</li>
  <li>Es m√°s f√°cil hacer el control de calidad, incluyendo la fase de pruebas.</li>
</ul>

<p>El √∫nico inconveniente rese√±able de las arquitecturas multicapa es que pueden hacer que una aplicaci√≥n muy simple se vuelva artificialmente m√°s compleja de lo necesario. Pero eso solo sucede en aplicaciones muy, pero que muy simples. Para cualquier aplicaci√≥n convencional, la arquitectura multicapa simplifica el dise√±o en lugar de complicarlo.</p>

<p>En resumen: todo son ventajas. Ya ves por qu√© todo el mundo hace aplicaciones web con arquitecturas multicapa.</p>

<h2 id="43-la-arquitectura-modelo-vista-controlador-mvc">4.3. La arquitectura Modelo-Vista-Controlador (MVC)</h2>

<p>Y por fin llegamos a la palabreja: la arquitectura Modelo-Vista-Controlador o MVC.</p>

<p>Cuando hablamos de <strong>arquitectura de una aplicaci√≥n</strong> nos referimos a la estructura b√°sica que la sustenta, como los pilares de un edificio en construcci√≥n. Si quitas las paredes, las ventanas, las puertas, los azulejos de la cocina‚Ä¶ todav√≠a pueden distinguirse las formas fundamentales, ¬øverdad?</p>

<p>Pues bien, el <em>patr√≥n de arquitectura</em> m√°s popular en aplicaciones web se llama <strong>MVC o Modelo-Vista-Controlador</strong> y muy pronto se va a convertir para ti en un viejo amigo.</p>

<h3 id="431-qu√©-es-el-mvc">4.3.1. ¬øQu√© es el MVC?</h3>

<p>El MVC es tan solo <strong>una arquitectura multicapa estandarizada</strong>. Una arquitectura de <strong>3 capas</strong>, para ser exactos.</p>

<p>Este es el esquema de una arquitectura en 3 capas. Recuerda lo que hemos visto antes: cada capa ejecuta una parte de la soluci√≥n, y entre ellas colaboran para formar la aplicaci√≥n completa. La capa superior interact√∫a con el usuario; la capa inferior, con la m√°quina (donde dice ‚Äúhardware‚Äù, deber√≠a decir ‚Äúcualquier cosa menos abstracta que nuestro programa‚Äù). Tienes permiso para imaginar cada capa como una clase con sus m√©todos y atributos.</p>

<p><img src="/docs/dwes/_site/assets/images/04-arquitectura-3-capas.png" alt="Arquitectura en 3 capas" /></p>

<p>Pues bien, si a esas tres capas les ponemos nombres ex√≥ticos como <em>modelo</em>, <em>vista</em> y <em>controlador</em>, y tuneamos un poco el esquema, ya lo tenemos: <strong>la arquitectura MVC</strong>.</p>

<p><img src="/docs/dwes/_site/assets/images/04-arquitectura-mvc.png" alt="Arquitectura MVC" /></p>

<p>Es decir, <strong>la arquitectura MVC solo es un caso particular de la arquitectura en 3 capas</strong>.</p>

<p>¬øY ya est√°? Bueno, no. Ahora tienes que aprender qu√© significa <em>en realidad</em> esta palabrer√≠a.</p>

<p>Porque todo esto est√° muy bien como construcci√≥n te√≥rica, pero ¬øc√≥mo te afecta a ti a la hora de programar? ¬øQu√© clases tienes que crear? ¬øQu√© parte del c√≥digo hay que poner en cada clase?</p>

<p>En la pr√°ctica, es m√°s simple de lo que parece. Lo vas a ver enseguida. Y lo maravilloso es que el 99,99% de las aplicaciones web encajan como un guante en esta arquitectura. Es decir, apenas tendremos que hacer trabajo de dise√±o previo, porque, si es una aplicaci√≥n web, ya sabemos qu√© clases tendremos que construir: los que nos indique la arquitectura MVC.</p>

<p>Antes de pasar a la parte pr√°ctica de todo esto, perm√≠teme un breve apunte: por supuesto, nada impide construir arquitecturas con m√°s de 3 capas. De hecho, nosotros vamos a usar una variante del MVC en el que se a√±ade una capa adicional por debajo del modelo, es decir, una arquitectura con 4 capas. Pero ya llegaremos a eso.</p>

<h3 id="432-mvc-en-la-pr√°ctica-una-implementaci√≥n-incremental">4.3.2. MVC en la pr√°ctica: una implementaci√≥n incremental</h3>

<p>Tras esta introducci√≥n al MVC, vamos a estudiar a fondo este patr√≥n. Y lo vamos a hacer por medio de un ejemplo, que es como mejor suelen comprenderse estas cosas. Una vez terminado y comprendido el ejemplo, daremos una definici√≥n m√°s te√≥rica.</p>

<p>Es decir, que lo vamos hacer al rev√©s de lo habitual: primero la pr√°ctica y luego la teor√≠a. Seg√∫n mi experiencia, la gente suele comprenderlo mejor en ese orden.</p>

<p>Pero, para que esto funcione, tienes que <strong>leer el c√≥digo fuente con atenci√≥n</strong>. Es un c√≥digo sencillo y bien comentado, y que se va complicando muy poco a poco, en pasos incrementales, desde un c√≥digo cl√°sico monol√≠tico hasta una implementaci√≥n completa de un MVC.</p>

<p>Si lo lees con la atenci√≥n que te pido, ver√°s como, <strong>al acabar, entender√°s perfectamente en qu√© consiste el MVC</strong> y podr√°s empezar a aplicarlo en tus proyectos.</p>

<p>El ejemplo con el que vamos a trabajar es este: supongamos que queremos programar una peque√±a aplicaci√≥n web que nos permita hacer publicaciones en una especie de blog simplificado. Esas publicaciones se guardan como registros en una tabla de una base de datos.</p>

<p>En el c√≥digo de ejemplo sobre el que vamos a trabajar, nos vamos a centrar en una funcionalidad concreta de este mini-blog: el listado de los art√≠culos existentes en la base de datos.</p>

<h4 id="c√≥digo-monol√≠tico">C√≥digo monol√≠tico</h4>

<p>Una primera aproximaci√≥n a la soluci√≥n, <strong>sin usar ning√∫n patr√≥n de arquitectura</strong> en absoluto, podr√≠a ser esta (√©chale un vistazo y aseg√∫rate de entenderlo):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?</span>
  <span class="c1">// Conectamos con la base de datos</span>
  <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="s1">'host'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span> <span class="s1">'dbname'</span><span class="p">);</span>
  <span class="c1">// Lanzamos una consulta para recuperar los art√≠culos que haya en la base de datos</span>
  <span class="nv">$resultado</span><span class="o">=</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
// Generamos una tabla HTML con el resultado de la consulta
<span class="nt">&lt;h1&gt;</span>Listado de Art√≠culos<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;table&gt;</span>
     <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Fecha<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Titulo<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span>
  <span class="c1">// Recorremos fila a fila el resultado de la consulta</span>
  <span class="k">while</span> <span class="p">(</span><span class="nv">$fila</span> <span class="o">=</span> <span class="nv">$resultado</span><span class="o">-&gt;</span><span class="nf">fetch_array</span><span class="p">())</span>  <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">"&lt;tr&gt;"</span><span class="p">;</span>
      <span class="k">echo</span> <span class="s2">"&lt;td&gt; "</span><span class="mf">.</span><span class="nv">$fila</span><span class="p">[</span><span class="s1">'fecha'</span><span class="p">]</span><span class="mf">.</span><span class="s2">" &lt;/td&gt;"</span><span class="p">;</span>
      <span class="k">echo</span> <span class="s2">"&lt;td&gt; "</span><span class="mf">.</span><span class="nv">$fila</span><span class="p">[</span><span class="s1">'titulo'</span><span class="p">]</span><span class="mf">.</span><span class="s2">" &lt;/td&gt;"</span><span class="p">;</span>
      <span class="k">echo</span> <span class="s2">"&lt;/tr&gt;"</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">echo</span> <span class="s2">"&lt;/table&gt;"</span><span class="p">;</span>
  <span class="c1">// Cerramos la conexi√≥n con la BD</span>
  <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Esta soluci√≥n se denomina <strong>monol√≠tica</strong>, porque incluye todo el c√≥digo necesario en el mismo bloque.</p>

<p>Por supuesto, para un ejemplo tan simple como este, el c√≥digo monol√≠tico es m√°s que suficiente, pero en un sistema m√°s complejo pronto empieza a convertirse en un monstruo inmanejable.</p>

<h4 id="primera-mejora-controlador--vista">Primera mejora: controlador + vista</h4>

<p>Vamos a aproximarnos un poco a la soluci√≥n MVC <strong>separando ese c√≥digo monol√≠tico en dos bloques</strong> (que guardaremos en archivos distintos):</p>

<ul>
  <li><strong>Un controlador</strong> (archivo <em>index.php</em>).</li>
  <li><strong>Una vista</strong> (archivo <em>showArticles.php</em>).</li>
</ul>

<p>Primero, el <strong>controlador</strong>. Se encargar√° de recuperar los datos, pero <em>no de mostrarlos</em>. Generar el interfaz de usuario, es decir, el HTML, ser√° la labor que le dejaremos a la vista. El controlador preparar√° esos datos y los empaquetar√° en un array para que est√©n disponibles en la vista. Y la vista la insertaremos en el controlador con un <em>include()</em>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?</span>
  <span class="c1">// Este es el controlador.</span>
  <span class="c1">// Como esta aplicaci√≥n de ejemplo solo realiza una acci√≥n,</span>
  <span class="c1">// no usamos de momento la variable "action"</span>

  <span class="c1">// Conectamos a la BD y sacamos la lista de art√≠culos</span>
  <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span> <span class="s1">'dbname'</span><span class="p">);</span>
  <span class="nv">$resultado</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>

  <span class="c1">// Convertimos la lista de art√≠culos, que es un cursor de MySQL, en un array est√°ndar de PHP</span>
  <span class="nv">$articulos</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="nv">$fila</span> <span class="o">=</span> <span class="nv">$resultado</span><span class="o">-&gt;</span><span class="nf">fetch_array</span><span class="p">())</span>  <span class="p">{</span>
      <span class="nv">$articulos</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$fila</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>

  <span class="c1">// Incluimos el c√≥digo de la vista, donde se usar√° el array de art√≠culos</span>
  <span class="c1">// para generar la tabla HTML.</span>
  <span class="k">include</span><span class="p">(</span><span class="s1">'showArticles.php'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>La <strong>vista</strong> que mostrar√° los datos del array contiene un c√≥digo muy semejante al de la soluci√≥n monol√≠tica, solo que ahora estar√° ubicada en un archivo aparte (<em>showArticles.php</em>) y har√° un bucle sobre el array de resultados que le ha preparado el controlador:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Listado de Articulos<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;table&gt;</span>
     <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Fecha<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Titulo<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
     <span class="cp">&lt;?php</span> 
     <span class="k">foreach</span><span class="p">(</span><span class="nv">$articulos</span> <span class="k">as</span> <span class="nv">$articulo</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"&lt;tr&gt;
           &lt;td&gt;"</span><span class="mf">.</span><span class="nv">$articulo</span><span class="p">[</span><span class="s1">'fecha'</span><span class="p">]</span><span class="mf">.</span><span class="s2">"&lt;/td&gt;
           &lt;td&gt;"</span><span class="mf">.</span><span class="nv">$articulo</span><span class="p">[</span><span class="s1">'titulo'</span><span class="p">]</span><span class="mf">.</span><span class="s2">"&lt;/td&gt;
        &lt;/tr&gt;"</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="cp">?&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre></div></div>

<h4 id="segunda-mejora-modelo-vista-y-controlador">Segunda mejora: modelo, vista y controlador</h4>

<p>En esta segunda mejora, <strong>dividiremos el c√≥digo en tres bloques</strong> (ubicados, de nuevo, en archivos diferentes):</p>

<ul>
  <li><strong>Un modelo</strong> para los art√≠clos (archivo <em>articles.php</em>). Contendr√° una clase con un m√©todo que se encargar√° de acceder a la base de datos y empaquetar el resultado de la consulta en un array.</li>
  <li><strong>Una vista</strong> (archivo <em>showArticles.php</em>). Se encargar√° de generar el HTML con el resultado de la consulta.</li>
  <li><strong>Un controlador</strong> (archivo <em>index.php</em>). Se encargar√° de invocar al modelo y a la vista en el orden correcto.</li>
</ul>

<p>Por lo tanto, el <strong>controlador</strong> (<em>index.php</em>), al extraer de √©l todo lo que tenga que ver con la base de datos, se queda en algo tan sencillo como esto:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span><span class="p">(</span><span class="s1">'articles.php'</span><span class="p">);</span>       <span class="c1">// En este archivo estar√° el modelo</span>
<span class="nv">$articulos</span> <span class="o">=</span> <span class="nc">Model</span><span class="o">::</span><span class="nf">getAll</span><span class="p">();</span>  <span class="c1">// Este m√©todo del modelo nos devuelve la lista de art√≠culos</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'showArticles.php'</span><span class="p">);</span>   <span class="c1">// En este archivo estar√° la vista</span>
</code></pre></div></div>

<p>El <strong>modelo</strong> (<em>articles.php</em>) consta de una clase con solo un m√©todo (de momento) encargado de consultar todos los art√≠culos y devolverlos empaquetados en un array:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">Articles</span> <span class="p">{</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">getAll</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span> <span class="s1">'dbname'</span><span class="p">);</span>
    <span class="nv">$resultado</span><span class="o">=</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>

    <span class="nv">$articulos</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$fila</span> <span class="o">=</span> <span class="nv">$resultado</span><span class="o">-&gt;</span><span class="nf">fetch_array</span><span class="p">())</span>  <span class="p">{</span>
        <span class="nv">$articulos</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$fila</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$articulos</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Por √∫ltimo, la <strong>vista</strong> (<em>showArticles.php</em>) ser√° exactamente igual que en la versi√≥n anterior: un recorrido por el array de art√≠culos para mostrarlos en formato HTML:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Listado de Articulos<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;table&gt;</span>
     <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Fecha<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Titulo<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
     <span class="cp">&lt;?php</span> 
     <span class="k">foreach</span><span class="p">(</span><span class="nv">$articulos</span> <span class="k">as</span> <span class="nv">$articulo</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"&lt;tr&gt;
           &lt;td&gt;"</span><span class="mf">.</span><span class="nv">$articulo</span><span class="p">[</span><span class="s1">'fecha'</span><span class="p">]</span><span class="mf">.</span><span class="s2">"&lt;/td&gt;
           &lt;td&gt;"</span><span class="mf">.</span><span class="nv">$articulo</span><span class="p">[</span><span class="s1">'titulo'</span><span class="p">]</span><span class="mf">.</span><span class="s2">"&lt;/td&gt;
        &lt;/tr&gt;"</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="cp">?&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre></div></div>

<h4 id="tercera-mejora-a√±adiendo-capa-de-abstracci√≥n-de-datos">Tercera mejora: a√±adiendo capa de abstracci√≥n de datos</h4>

<p>Como no sabemos lo que es el miedo, vamos a complicar nuestro patr√≥n modelo-vista-controlador con una <strong>cuarta capa</strong>: la <strong>capa de abstracci√≥n de datos</strong>.</p>

<p>La idea de esta capa adicional es proporcionar un mecanismo de abstracci√≥n respecto del gestor de base de datos concreto que estemos utilizando.</p>

<p>Vaya frasecita, ¬øeh? <em>‚ÄúUn mecanismo de abstracci√≥n respecto del gestor de base de datos‚Äù</em>. Si no has bizqueado un poco al leerlo, es que tienes los nervios de acero. ¬øQu√© narices significa eso?</p>

<p>Es solo una de esas expresiones de que los inform√°ticos usamos para fardar, como cuando un m√©dico te dice que est√°s acatarrado, pero te lo dice en lat√≠n para que parezca m√°s complicado de lo que es.</p>

<p>Te explico qu√© es eso del <em>‚Äúmecanismo de abstracci√≥n bla, bla, bla‚Äù</em>.</p>

<p>Si te fijas en el <strong>modelo</strong> de la soluci√≥n anterior, ver√°s que estamos usando una clase (<em>mysqli</em>) y unos m√©todos que solo funcionan con MySQL o MariaDB. Si quis√©ramos cambiar el gestor de base de datos (algo relativamente frecuente), tendr√≠amos que revisar <em>todos</em> nuestros modelos, y tal vez modificar y volver a probar miles de l√≠neas de c√≥digo.</p>

<p>Una forma de independizar nuestra aplicaci√≥n del gestor de base de datos que haya debajo es programar lo que se llama <strong>capa de abstracci√≥n</strong> que contenga dos o tres m√©todos gen√©ricos (como <em>consultar()</em> para lanzar SELECT o <em>manipular()</em> para lanzar INSERT, UPDATE o DELETE).</p>

<p>De ese modo, cuando queramos hacer una consulta desde el modelo, no lo haremos con los m√©todos de MySQL (como <em>query()</em>, <em>fetch_array()</em> y similares), sino con los nuestros (<em>consultar()</em>, <em>manipular()</em>, o como los hayamos querido llamar). Si alg√∫n d√≠a necesitamos cambiar el gestor de base de datos, solo tendremos que reescribir el c√≥digo de esa capa de abstracci√≥n, es decir, un par de decenas de l√≠neas de c√≥digo frente a varios miles que ten√≠amos que revisar y probar antes.</p>

<p>Por lo tanto, en esta tercera mejora vamos a dividir el c√≥digo en cuatro bloques:</p>

<ul>
  <li><strong>Un controlador</strong> (archivo index.php).</li>
  <li><strong>Una vista</strong> (archivo view.php).</li>
  <li><strong>Un modelo en dos capas</strong>:
    <ul>
      <li><strong>Capa de abstracci√≥n de datos</strong> (db.php)</li>
      <li><strong>Capa de acceso a datos</strong> (el modelo de art√≠culos propiamente dicho) (articles.php).</li>
    </ul>
  </li>
</ul>

<p>El c√≥digo de la <strong>capa de abstracci√≥n</strong> ser√≠a algo as√≠:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Db</span> <span class="p">{</span>

  <span class="k">private</span> <span class="nv">$db</span><span class="p">;</span> <span class="c1">// Aqu√≠ guardaremos la conexi√≥n con la base de datos</span>

  <span class="k">function</span> <span class="n">crearConexion</span><span class="p">(</span><span class="nv">$servidor</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="nv">$servidor</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">cerrarConexion</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">consulta</span><span class="p">(</span><span class="nv">$consulta</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="nv">$consulta</span><span class="p">);</span>
    <span class="nv">$resArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$resArray</span> <span class="o">=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="nf">fetch_all</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$resArray</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//...etc... (aqu√≠ a√±adimos cualquier funci√≥n que acceda directamente a MySQL)</span>

<span class="p">}</span>
</code></pre></div></div>

<p>El c√≥digo del <strong>modelo</strong> va a hacer uso de la capa de abstracci√≥n en lugar de usar los m√©todos de la clase <em>mysqli</em> directamente:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span> <span class="s2">"Db.php"</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Articles</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">getAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Db</span><span class="p">();</span>  <span class="c1">// Creamos un objeto para usar nuestra capa de abstracci√≥n</span>

    <span class="c1">// Conectamos con la BD a trav√©s de nuestra capa de abstracci√≥n</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">crearConexion</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span> <span class="s1">'dbName'</span><span class="p">);</span>

    <span class="c1">// Lanzamos la consulta a trav√©s de nuestra capa de abstracci√≥n.</span>
    <span class="c1">// Nos devolver√° directamente un array est√°ndar de PHP.</span>
    <span class="nv">$articulos</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">consulta</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>

    <span class="c1">// Cerramos la conexi√≥n con la BD</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">cerrarConexion</span><span class="p">();</span>

    <span class="k">return</span> <span class="nv">$articulos</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>El <strong>controlador</strong> y la <strong>vista</strong> son exactamente los mismos que en la soluci√≥n anterior, as√≠ que no vamos a escribir el c√≥digo de nuevo. Esto es l√≥gico: solo hemos modificado la forma en la que trabaja el modelo, pero gracias al encapsulamiento de los objetos, el resto de la aplicaci√≥n no se ha enterado de ello.</p>

<h4 id="cuarta-y-√∫ltima-mejora-transformaci√≥n-en-clases-y-objetos-reutilizables-c√≥digo-fuente-definitivo">Cuarta (y √∫ltima) mejora: transformaci√≥n en clases y objetos reutilizables. C√≥digo fuente definitivo</h4>

<p>Para terminar, vamos a dejar el <strong>c√≥digo bien organizado</strong> y a mostrarlo completo.</p>

<p>Lo que haremos en esta √∫ltima etapa es <strong>empaquetarlo todo en clases reutilizables</strong>. Observa que sigue siendo el mismo c√≥digo fuente, solo que empaquetado en clases y m√©todos. Lo √∫nico que queda fuera de una clase es la instanciaci√≥n iniciar del objeto controlador.</p>

<p>F√≠jate bien en c√≥mo hemos convertido las vistas en una clase con un m√©todo <em>show()</em> que nos servir√° para mostrar cualquier vista y reutilizar el mismo <em>header</em> y el mismo <em>footer</em>. Cada vista se programar√° en un archivo independiente que deberemos organizar en directorios y subdirectorios.</p>

<p>Otra cosa que quiero que observes con atenci√≥n es <strong>el punto de entrada a la aplicaci√≥n</strong> (archivo <strong>index.php</strong>), porque lo hemos dejado preparado para poder a√±adir nuevas funciones al programa con posterioridad, as√≠ como varios controladores. El m√©todo que se ejecutar√° depender√° no solo de la variable ‚Äúaction‚Äù que se pasa por GET, sino tambi√©n de otra variable llamada ‚Äúcontroller‚Äù, que tambi√©n se pasa por GET, y que contendr√° el nombre de la clase del controlador.</p>

<p>As√≠, para invocar, por ejemplo, el m√©todo showAll() del controlador ArticlesController, la ruta deber√≠a ser esta:</p>

<p><code>
http://mi-servidor/index.php?controller=ArticlesController&amp;action=showAll
</code></p>

<p>Este index.php es tan gen√©rico que te servir√° para montar cualquier aplicaci√≥n MVC.</p>

<p>Si repasas el c√≥digo del ejemplo resuelto de tema anterior (el de la autenticaci√≥n mediante ACL), ver√°s que ya se parec√≠a mucho a este esquema, aunque en el index.php siempre utiliz√°bamos el mismo controlador.</p>

<p><strong>Punto de entrada a la aplicaci√≥n</strong> (index.php)</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
  <span class="k">include</span><span class="p">(</span><span class="s2">"articlesController.php"</span><span class="p">);</span>

  <span class="c1">// Miramos a ver si se indica alguna acci√≥n en la URL</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// No la hay. Usamos la acci√≥n por defecto (main). Puedes cambiarla por cualquier otra que vaya bien con tu aplicaci√≥n.</span>
    <span class="nv">$action</span> <span class="o">=</span> <span class="s2">"main"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// S√≠ la hay. La recuperamos.</span>
    <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="c1">// Hacemos lo mismo con el nombre del controlador</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'controller'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// No la hay. Asignaremos un controlador por defecto (Articles). Por supuesto, puedes cambiarla por otro que vaya bien con tu aplicaci√≥n.</span>
    <span class="nv">$controllerClass</span> <span class="o">=</span> <span class="s2">"ArticlesController"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// S√≠ la hay. La recuperamos.</span>
    <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'controller'</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="c1">// Instanciamos el controlador e invocamos al m√©todo que se llame como la acci√≥n</span>
  <span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$controllerClass</span><span class="p">();</span>
  <span class="nv">$controller</span><span class="o">-&gt;</span><span class="nv">$action</span><span class="p">();</span>
<span class="cp">?&gt;</span>

</code></pre></div></div>

<p><strong>Controlador de art√≠culos</strong> (articlesController.php)</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Controlador. Deber√≠a tener un m√©todo por cada posible valor de la variable "action".</span>
<span class="k">include</span> <span class="p">(</span><span class="s2">"view.php"</span><span class="p">);</span>
<span class="k">include</span> <span class="p">(</span><span class="s2">"articles.php"</span><span class="p">);</span>

<span class="kd">class</span> <span class="nc">ArticlesController</span> <span class="p">{</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">showAllArticles</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$data</span><span class="p">[</span><span class="s1">'articulos'</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Articulos</span><span class="o">::</span><span class="nf">getAllArticulos</span><span class="p">();</span>
      <span class="nc">View</span><span class="o">::</span><span class="nf">show</span><span class="p">(</span><span class="s2">"showAllArticles"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// Se a√±ade un m√©todo por cada posible valor de la variable "action"</span>

<span class="p">}</span>
</code></pre></div></div>

<p><strong>Clase vista</strong> (view.php)</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">View</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">show</span><span class="p">(</span><span class="nv">$nombreVista</span><span class="p">,</span> <span class="nv">$data</span><span class="o">=</span><span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">include</span><span class="p">(</span><span class="s2">"header.php"</span><span class="p">);</span>
      <span class="k">include</span><span class="p">(</span><span class="s2">"</span><span class="nv">$nombreVista</span><span class="s2">.php"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
      <span class="k">include</span><span class="p">(</span><span class="s2">"footer.php"</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p><strong>Vista showAllArticles</strong> (showAllArticles.php)</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Listado de Articulos<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;table&gt;</span>
     <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Fecha<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Titulo<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
     <span class="cp">&lt;?php 
     $articulos = $data['articulos'];
     foreach($articulos as $articulo) {
        echo "&lt;tr&gt;
           &lt;td&gt;".$articulo['fecha']."&lt;/td&gt;
           &lt;td&gt;".$articulo['titulo']."&lt;/td&gt;
        &lt;/tr&gt;";
     }
     ?&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre></div></div>

<p><strong>Modelo - Capa de acceso a datos</strong> (articles.php)</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span> <span class="s2">"db.php"</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Articles</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">getAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Db</span><span class="p">();</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">crearConexion</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span><span class="s1">'dbName'</span><span class="p">);</span>
    <span class="nv">$articulos</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">cosulta</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">cerrarConexion</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$articulos</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Modelo - Capa de abstracci√≥n de datos</strong> (db.php)</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Db</span> <span class="p">{</span>

  <span class="k">private</span> <span class="nv">$db</span><span class="p">;</span>

  <span class="k">function</span> <span class="n">crearConexion</span><span class="p">(</span><span class="nv">$servidor</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="nv">$servidor</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">cerrarConexion</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$db</span><span class="p">)</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">consulta</span><span class="p">(</span><span class="nv">$consulta</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$db</span><span class="err">‚Üí</span><span class="nf">query</span><span class="p">(</span><span class="nv">$consulta</span><span class="p">);</span>
    <span class="nv">$resArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$resArray</span> <span class="o">=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="nf">fetch_all</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$resArray</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">//...etc... (a√±adimos cualquier funci√≥n que acceda directamente a MySQL)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="44-el-patr√≥n-mvc-en-la-teor√≠a">4.4. El patr√≥n MVC en la teor√≠a</h2>

<p>Ahora que hemos aprendido a manejarnos con el patr√≥n MVC por medio de un ejemplo, estamos en condiciones de definirlo de manera m√°s te√≥rica. E incluso entender esa definici√≥n, no te vayas a creer.</p>

<p>El patr√≥n MVC consiste, pues, en dividir la aplicaci√≥n en tres capas:</p>

<ul>
  <li>
    <p><strong>Los modelos</strong>, donde se programa la <em>l√≥gica de negocio</em>. De esa forma tan rimbombante se refiere la literatura t√©cnica al acceso a los datos con los filtros, algoritmos y restricciones que el sistema imponga.</p>

    <p>En la pr√°ctica, esto significa que en los modelos debemos colocar todo el c√≥digo de acceso a la base de datos o a cualquier otro recurso del servidor (como las variables de sesi√≥n, por ejemplo). Los modelos deben empaquetar esos datos en objetos est√°ndar de PHP (como arrays) y devolverlos al controlador.</p>

    <p>Lo m√°s pr√°ctico es <strong>crear un modelo para cada tabla maestra</strong> de la base de datos.</p>

    <p>Los <em>frameworks</em> automatizan los m√©todos m√°s t√≠picos de cada modelo, como insertar un registro, borrar, actualizar, consultar uno o consultar todos. Ya veremos de que formas tan alucinantes se las ingenian para hacer todo esto con un m√≠nimo de esfuerzo por nuestra parte y, por supuesto, sin escribir el mismo c√≥digo una y otra vez.</p>
  </li>
  <li>
    <p><strong>Las vistas</strong>, donde se programan todas las salidas HTML que el usuario final va a ver y con las que va a interactuar.</p>

    <p>El c√≥digo Javascript y CSS, por lo tanto, forma parte de las vistas.</p>

    <p>En las vistas estar√° el grueso del c√≥digo de cualquier aplicaci√≥n. Los <em>frameworks</em> m√°s avanzados incluyen sistemas de <strong>plantillas</strong> para reutilizar fragmentos de vistas, as√≠ como lenguajes adicionales para simplificar este proceso. Pero, si programamos en PHP cl√°sico, tendremos que construir las vistas manualmente.</p>
  </li>
  <li>
    <p><strong>Los controladores</strong>, donde se captura cada petici√≥n del usuario y se dirige el flujo de ejecuci√≥n, invocando a los modelos y a las vistas en el orden adecuado.</p>

    <p>En una aplicaci√≥n peque√±a, bastar√° con tener un controlador para todo. Cuando la aplicaci√≥n crece, suele hacerse <strong>un controlador por cada modelo</strong>, es decir, un controlador por cada tabla maestra.</p>

    <p>Los controladores estar√°n compuestos por una colecci√≥n de m√©todos, uno para cada funcionalidad de la aplicaci√≥n. El m√©todo que se ejecute en cada ocasi√≥n estar√° controlado por la URL (en concreto, por una variable como ‚Äúaction‚Äù que se pasar√° por GET).</p>

    <p>En los <em>frameworks</em>, esta variable ‚Äúaction‚Äù se transforma en una URL limpia que, a trav√©s de un objeto adicional llamado <strong>enrutador</strong>, termina provocando la invocaci√≥n del m√©todo adecuado.</p>

    <p>Es decir: en una aplicaci√≥n MVC como las que hemos visto hasta ahora, tendremos una ruta como esta para, por ejemplo, consultar el art√≠culo con id 37:</p>

    <p><code>https://mi-servidor/index.php?action=showArticle&amp;idArticle=37</code></p>

    <p>En cambio, en un <em>framework</em> avanzado, la ruta tendr√° un aspecto m√°s limpio para hacer lo mismo. Algo as√≠ como:</p>

    <p><code>https://mi-servidor/articles/show/37</code></p>

    <p>Y el enrutador se encargar√° trocear esa URL y extraer de ella la informaci√≥n para instanciar el controlador y llamar al m√©todo adecuado.</p>
  </li>
</ul>

<h1 id="45-ejercicios-propuestos">4.5. Ejercicios propuestos</h1>

<p>Para terminar, como siempre, vamos a proponer algunos casos pr√°cticos para que pongas manos a la obra.</p>

<h4 id="crear-un-enrutador">Crear un enrutador</h4>

<p><em>Advertencia: ¬°este ejercicio es complicadillo!</em></p>

<p>¬øTe atreves a crear un enrutador como el de los frameworks avanzados? No es un elemento fundamental para que la aplicaci√≥n web funcione, sino que tan solo sirve para construir rutas limpias.</p>

<p>Recuerda que el enrutador tiene que ser capaz de coger una URL limpia, como esta:</p>

<p><code>
https://mi-servidor/articles/show/37
</code></p>

<p>‚Ä¶y deducir de ah√≠ que hay que invocar el m√©todo <em>show(37)</em> del controlador de art√≠culos. O bien el m√©todo <em>showArticle(37)</em> si tu aplicaci√≥n es tan simple que solo tiene un controlador.</p>

<p>Deber√≠a funcionar con cualquier ruta construida de ese modo y cualquier cantidad de controladores.</p>

<p>A ver si se te ocurre algo para hacerlo.</p>

<p>(No s√© si te has dado cuenta, pero, poco a poco, estamos construyendo nuestro porpio <em>framework</em> casero para programar aplicaciones MVC)</p>

<h4 id="reserva-de-recursos-inform√°ticos">Reserva de recursos inform√°ticos</h4>

<p>Vamos a hacer una aplicaci√≥n realista de aplicaci√≥n directa en un lugar como un instituto, una empresa o cualquier otra organizaci√≥n medianamente compleja.</p>

<p>Un problema que se presenta a menudo en estas organizaciones es la necesidad de compartir ciertos recursos, como proyectores, ordenadores port√°tiles o salas de conferencias.</p>

<p>En nuestro instituto, por ejemplo, tenemos unas listas impresas en papel en un tabl√≥n de anuncios para que el profesorado reserve los carritos con port√°tiles o las aulas de inform√°tica, de modo que dos personas no traten de usar a la vez el mismo recurso.</p>

<p>Es un m√©todo un poco primitivo (aunque eficaz, todo hay que decirlo) que se puede informatizar f√°cilmente. Y eso es lo que vamos a proponer aqu√≠.</p>

<p>Se trata de <strong>escribir una aplicaci√≥n para reservar recursos</strong> de la organizaci√≥n. Los recursos pueden ser de cualquier tipo (ordenadores port√°tiles, carritos, proyectores, salas de conferencias‚Ä¶). Los usuarios, que tendr√°n que estar registrados, podr√°n reservar cada recurso durante tramos horarios predefinidos.</p>

<p>Las tablas de la aplicaci√≥n, por lo tanto, ser√°n estas:</p>

<ul>
  <li>Resources(id#, name, description, location, image)</li>
  <li>Users(id#, username, password, realname)</li>
  <li>TimeSlots(id#, dayOfWeek, startTime, endTime)</li>
  <li>Reservations(idResource#, idUser#, idTimeSlot#, remarks)</li>
</ul>

<p>La aplicaci√≥n, una vez introducidos los datos en las tablas maestras <em>Resources</em>, <em>Users</em> y <em>TimeSlots</em>, podr√°n reservar recursos autentic√°ndose en la aplicaci√≥n y seleccionando el recurso, el d√≠a y el tramo horario de la reserva (siempre que el recurso no est√© reservado ya, obviamente).</p>

<p>Para conseguir implementar la aplicaci√≥n completa, vamos a hacerlo por pasos:</p>

<p><strong>Paso 1. Mantenimiento de la tabla Resources</strong></p>

<p>Crea todos los elementos necesarios para hacer el manenimiento completo de la tabla de recursos. Es decir: listado, inserci√≥n, borrado y modificaci√≥n.</p>

<p>Hazlo exactamente en ese orden, porque he escrito las operaciones en orden de dificultad en su implementaci√≥n.</p>

<p>Para hacerlo, necesitar√°s:</p>

<ul>
  <li>El punto de entrada a la aplicaci√≥n (index.php)</li>
  <li>El controlador de recursos (clase ResourcesController)</li>
  <li>El modelo de recursos (clase Resources)</li>
  <li>La capa de abstracci√≥n (clase Db)</li>
  <li>La clase vista (View)</li>
  <li>Una colecci√≥n de vistas sencillas. Al menos dos: una para mostrar el listado de recursos y otra para el formulario de insercion y modificaci√≥n (se puede reutilizar la misma).</li>
</ul>

<p>F√≠jate en que puedes reutilizar gran parte del c√≥digo fuente que hemos mostrado como ejemplo de MVC m√°s arriba, con unas pocas adaptaciones.</p>

<p><strong>Paso 2. Mantenimiento de la tabla TimeSlots</strong></p>

<p>El mantenimiento de esta tabla es muy similar al de la anterior. Necesitar√°s un controlador nuevo y un modelo nuevo, con m√©todos muy parecidos a los que ya has implementado para <em>Resources</em>.</p>

<p><strong>Paso 3. Mantenimiento de la tabla Users</strong></p>

<p>M√°s de lo mismo. Reutiliza y adapta todo lo que puedas. Este tercer mantenimiento te deber√≠a salir con mucha m√°s facilidad y rapidez que los anteriores.</p>

<p><strong>Paso 4. Men√∫ principal</strong></p>

<p>Hasta ahora, tenemos un pu√±ado de m√©todos en uno o varios controladores que se invocan pasando variables de control por la URL (algo como <code>http://mi-servidor/index.php?controller=resources&amp;action=showAll</code>).</p>

<p>En este punto, vamos a juntarlos todos en un men√∫ principal que contendr√° enlaces a todas esas URLs. Cuando a√±adamos m√°s funcionalidades al programa, solo tendremos que agregarlas al men√∫ principal.</p>

<p><strong>Paso 5. Autenticaci√≥n</strong></p>

<p>De momento, cualquiera puede entrar a la aplicaci√≥n y a√±adir, modificar o eliminar registros de las tablas maestras.</p>

<p>Vamos a proteger el acceso al men√∫ principal con un sistema de autenticaci√≥n (login). Puedes reutilizar el c√≥digo del tema anterior, cuando hablamos de las listas ACL, pero simplificando aquel c√≥digo, puesto que aqu√≠ solo tenemos una tabla de usuarios registrados (nada de tablas de permisos ni roles).</p>

<p>No te olvides de controlar el acceso a los m√©todos de los controladores para que solo los usuarios debidamente autenticados puedan ejecutarlos.</p>

<p><strong>Paso 6. Reservas</strong></p>

<p>Hacer o eliminar reservas consiste, b√°sicamente, en insertar y eliminar registros de la tabla TimeSlots.</p>

<p>Sin embargo, no es un mantenimiento como el de las otras tablas, puesto que esta tabla proviene de una relaci√≥n ternaria entre tres entidades (reservas, slots y usuarios), y no es una tabla maestra como tal.</p>

<p>Por eso dejamos este mantenimiento de tabla para el final: porque es el m√°s <em>raro</em> y, adem√°s, constituye la pieza principal de la aplicaci√≥n: si esto no est√° hecho, la aplicaci√≥n, simplemente, no funciona.</p>

<p><strong>Paso 7. Roles de usuario</strong></p>

<p>(Este paso es optativo)</p>

<p>Vamos a a√±adir un campo nuevo a la tabla de usuarios. Lo llamaremos <em>‚Äútype‚Äù</em>, y solo podr√° contener dos valores: 0 (admin) o 1 (user). Puedes usar un VARCHAR si te sientes m√°s c√≥modo/a que con c√≥digos num√©ricos.</p>

<p>Si el usuario que entra en la aplicaci√≥n es de tipo 0 (admin), tendr√° acceso al men√∫ principal y a todos los m√©todos de todos los controlares. Como hasta ahora, vamos.</p>

<p>Pero si el usuario que entra en la aplicaci√≥n es de tipo 1 (user), en el men√∫ principal solo le aparecer√°n las opciones de acceso a las reservas. Es decir, no podr√° a√±adir, modificar ni eliminar usuarios, slots o recursos. Cosa que es bastante l√≥gica, ¬øno te parece?</p>

<p>Recuerda revisar el acceso a todos los m√©todos de todos los controladores para asegurarte de que un usuario de tipo 1 no entre, por ejemplo, al m√©todo para borrar recursos, ni siquiera escribiendo manualmente la URL.</p>

<p><strong>Paso 8. Otras mejoras</strong></p>

<p>(Este paso es optativo)</p>

<p>A la aplicaci√≥n se le pueden hacer infinitas mejoras. Aqu√≠ te sugiero algunas, pero estar√≠a bien que te sacaras otras de tu propia chistera:</p>

<ul>
  <li>Hacer que las vistas sean visualmente atractivas con CSS y/o Javascript.</li>
  <li>Mostrar un calendario en el que se aprecien visualmente las reservas de una semana o de un mes. O, mejor a√∫n, incorporar un selector para poder ver el d√≠a actual, la semana actual o el mes actual (ojo, que esto √∫ltimo es bastante complicadillo).</li>
  <li>A√±adir la posibilidad de crear y anular reservas directamente desde el calendario. Observa que, as√≠, la vista principal del usuario de tipo 1 ser√≠a el calendario, mientras que el usuario de tipo 0 seguir√≠a accediendo al viejo men√∫ de principal para hacer el mantenimiento completo de tablas.</li>
  <li>Controlar que los usuarios de tipo 1 solo puedan eliminar sus propias reservas, no las de otros usuarios. En cambio, los usuarios de tipo 0 podr√°n eliminar cualquier reserva.</li>
  <li>Eliminar autom√°ticamente las reservas cuya fecha ya haya pasado.</li>
</ul>

:ET